<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>跛足的登山者</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.liuyong520.cn/"/>
  <updated>2019-05-11T14:37:35.583Z</updated>
  <id>http://www.liuyong520.cn/</id>
  
  <author>
    <name>xxydliuy</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>storm 的分组策略深入理解（-）</title>
    <link href="http://www.liuyong520.cn/2019/05/10/storm-groupping/"/>
    <id>http://www.liuyong520.cn/2019/05/10/storm-groupping/</id>
    <published>2019-05-10T13:37:40.000Z</published>
    <updated>2019-05-11T14:37:35.583Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun May 12 2019 12:14:16 GMT+0800 (GMT+08:00) --><h1 id="storm的分组策略"><a href="#storm的分组策略" class="headerlink" title="storm的分组策略"></a>storm的分组策略</h1><ul><li><p>洗牌分组(Shuffle grouping): 随机分配元组到Bolt的某个任务上，这样保证同一个Bolt的每个任务都能够得到相同数量的元组。</p></li><li><p>字段分组(Fields grouping): 按照指定的分组字段来进行流的分组。例如，流是用字段“user-id”来分组的，那有着相同“user-id”的元组就会分到同一个任务里，但是有不同“user-id”的元组就会分到不同的任务里。这是一种非常重要的分组方式，通过这种流分组方式，我们就可以做到让Storm产出的消息在这个”user-id”级别是严格有序的，这对一些对时序敏感的应用(例如，计费系统)是非常重要的。</p></li><li><p>Partial Key grouping: 跟字段分组一样，流也是用指定的分组字段进行分组的，但是在多个下游Bolt之间是有负载均衡的，这样当输入数据有倾斜时可以更好的利用资源。这篇论文很好的解释了这是如何工作的，有哪些优势。</p></li><li><p>All grouping: 流会复制给Bolt的所有任务。小心使用这种分组方式。在拓扑中，如果希望某类元祖发送到所有的下游消费者，就可以使用这种All grouping的流分组策略。</p></li><li><p>Global grouping: 整个流会分配给Bolt的一个任务。具体一点，会分配给有最小ID的任务。<br>不分组(None grouping): 说明不关心流是如何分组的。目前，None grouping等价于洗牌分组。</p></li><li><p>Direct grouping：一种特殊的分组。对于这样分组的流，元组的生产者决定消费者的哪个任务会接收处理这个元组。只能在声明做直连的流(direct streams)上声明Direct groupings分组方式。只能通过使用emitDirect系列函数来吐元组给直连流。一个Bolt可以通过提供的TopologyContext来获得消费者的任务ID，也可以通过OutputCollector对象的emit函数(会返回元组被发送到的任务的ID)来跟踪消费者的任务ID。在ack的实现中，Spout有两个直连输入流，ack和ackFail，使用了这种直连分组的方式。</p></li><li><p>Local or shuffle grouping：如果目标Bolt在同一个worker进程里有一个或多个任务，元组就会通过洗牌的方式分配到这些同一个进程内的任务里。否则，就跟普通的洗牌分组一样。这种方式的好处是可以提高拓扑的处理效率，因为worker内部通信就是进程内部通信了，相比拓扑间的进程间通信要高效的多。worker进程间通信是通过使用Netty来进行网络通信的。</p></li></ul><h1 id="根据实例来分析分组策略"><a href="#根据实例来分析分组策略" class="headerlink" title="根据实例来分析分组策略"></a>根据实例来分析分组策略</h1><h2 id="common配置："><a href="#common配置：" class="headerlink" title="common配置："></a>common配置：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.sonly.strom&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;strom-study&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;source&gt;7&lt;/source&gt;</span><br><span class="line">                    &lt;target&gt;7&lt;/target&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;descriptorRefs&gt;</span><br><span class="line">                        &lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;</span><br><span class="line">                    &lt;/descriptorRefs&gt;</span><br><span class="line">                    &lt;archive&gt;</span><br><span class="line">                        &lt;manifest&gt;</span><br><span class="line">                            &lt;mainClass&gt;com.sonly.storm.demo1.HelloToplogy&lt;/mainClass&gt;</span><br><span class="line">                        &lt;/manifest&gt;</span><br><span class="line">                    &lt;/archive&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;make-assembly&lt;/id&gt;</span><br><span class="line">                        &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;single&lt;/goal&gt;</span><br><span class="line">                        &lt;/goals&gt;</span><br><span class="line">                    &lt;/execution&gt;</span><br><span class="line">                &lt;/executions&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.storm&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;storm-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.2.2&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure><h1 id="Shuffle-grouping"><a href="#Shuffle-grouping" class="headerlink" title="Shuffle grouping"></a>Shuffle grouping</h1><h2 id="shuffle-grouping的实例代码"><a href="#shuffle-grouping的实例代码" class="headerlink" title="shuffle grouping的实例代码"></a>shuffle grouping的实例代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sonly.storm.demo1.grouppings.spout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.storm.spout.SpoutOutputCollector;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichSpout;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Fields;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Values;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;package:com.sonly.storm.demo1&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;project(项目):stormstudy&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;class(类)$&#123;CLASS_NAME&#125;&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;creat date(创建时间):2019-05-09 20:27&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;author(作者):&lt;/b&gt;xxydliuyss&lt;/br&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;note(备注)):&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * If you want to change the file header,please modify zhe File and Code Templates.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WordSpout</span> <span class="keyword">extends</span> <span class="title">BaseRichSpout</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(WordSpout.class);</span><br><span class="line">    <span class="comment">//拓扑上下文</span></span><br><span class="line">    <span class="keyword">private</span> TopologyContext context;</span><br><span class="line">    <span class="keyword">private</span> SpoutOutputCollector collector;</span><br><span class="line">    <span class="keyword">private</span> Map config;</span><br><span class="line">    <span class="keyword">private</span> AtomicInteger atomicInteger = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Map conf, TopologyContext topologyContext, SpoutOutputCollector collector)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.config = conf;</span><br><span class="line">        <span class="keyword">this</span>.context = topologyContext;</span><br><span class="line">        <span class="keyword">this</span>.collector = collector;</span><br><span class="line">        LOGGER.warn(<span class="string">"WordSpout-&gt;open:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;"</span>, <span class="keyword">this</span>.hashCode(), Thread.currentThread().getId(), context.getThisTaskId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nextTuple</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String[] sentences = <span class="keyword">new</span> String[]&#123;<span class="string">"zhangsan"</span>,<span class="string">"zhangsan"</span>,<span class="string">"zhangsan"</span>,<span class="string">"zhangsan"</span>,<span class="string">"zhangsan"</span>,<span class="string">"zhangsan"</span>,<span class="string">"zhangsan"</span>,<span class="string">"zhangsan"</span>,<span class="string">"lisi"</span>,<span class="string">"lisi"</span>&#125;;</span><br><span class="line">        <span class="keyword">int</span> i = atomicInteger.get();</span><br><span class="line">        <span class="keyword">if</span>(i&lt;<span class="number">10</span>)&#123;</span><br><span class="line">            atomicInteger.incrementAndGet();</span><br><span class="line">            <span class="keyword">final</span> String sentence = sentences[i];</span><br><span class="line">            collector.emit(<span class="keyword">new</span> Values(sentence));</span><br><span class="line">            LOGGER.warn(<span class="string">"WordSpout-&gt;nextTuple:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;,Values:&#123;&#125;"</span>, <span class="keyword">this</span>.hashCode(), Thread.currentThread().getId(), context.getThisTaskId(), sentence);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</span><br><span class="line">        declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"sentence"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>bolt1<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sonly.storm.demo1.grouppings;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.OutputCollector;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichBolt;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Fields;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Tuple;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Values;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;package:com.sonly.storm.demo1&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;project(项目):stormstudy&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;class(类)$&#123;CLASS_NAME&#125;&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;creat date(创建时间):2019-05-09 21:19&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;author(作者):&lt;/b&gt;xxydliuyss&lt;/br&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;note(备注)):&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * If you want to change the file header,please modify zhe File and Code Templates.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SheffleGroupingBolt</span> <span class="keyword">extends</span> <span class="title">BaseRichBolt</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(SheffleGroupingBolt.class);</span><br><span class="line">    <span class="keyword">private</span> TopologyContext context;</span><br><span class="line">    <span class="keyword">private</span> Map conf;</span><br><span class="line">    <span class="keyword">private</span> OutputCollector collector;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Integer&gt; counts = <span class="keyword">new</span> HashMap(<span class="number">16</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map map, TopologyContext topologyContext, OutputCollector outputCollector)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.conf=map;</span><br><span class="line">        <span class="keyword">this</span>.context = topologyContext;</span><br><span class="line">        <span class="keyword">this</span>.collector = outputCollector;</span><br><span class="line">        LOGGER.warn(<span class="string">"SheffleGroupingBolt-&gt;prepare:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple tuple)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String word = tuple.getString(<span class="number">0</span>);</span><br><span class="line">        LOGGER.warn(<span class="string">"SheffleGroupingBolt-&gt;execute:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;,value:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId(),word);</span><br><span class="line">        collector.emit(<span class="keyword">new</span> Values(word));</span><br><span class="line">        collector.ack(tuple);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</span><br><span class="line">        declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"bolt1"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>bolt<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sonly.storm.demo1.grouppings;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.OutputCollector;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichBolt;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Fields;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Tuple;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Values;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;package:com.sonly.storm.demo1&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;project(项目):stormstudy&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;class(类)$&#123;CLASS_NAME&#125;&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;creat date(创建时间):2019-05-09 21:29&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;author(作者):&lt;/b&gt;xxydliuyss&lt;/br&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;note(备注)):&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * If you want to change the file header,please modify zhe File and Code Templates.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SheffleGrouppingBolt1</span> <span class="keyword">extends</span> <span class="title">BaseRichBolt</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(SheffleGrouppingBolt1.class);</span><br><span class="line">    <span class="keyword">private</span> TopologyContext context;</span><br><span class="line">    <span class="keyword">private</span> Map conf;</span><br><span class="line">    <span class="keyword">private</span> OutputCollector collector;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map map, TopologyContext topologyContext, OutputCollector outputCollector)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.conf=map;</span><br><span class="line">        <span class="keyword">this</span>.context = topologyContext;</span><br><span class="line">        <span class="keyword">this</span>.collector = outputCollector;</span><br><span class="line">        LOGGER.warn(<span class="string">"SheffleGrouppingBolt1-&gt;prepare:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple tuple)</span> </span>&#123;</span><br><span class="line">        String word = tuple.getStringByField(<span class="string">"sentence"</span>);</span><br><span class="line">        LOGGER.warn(<span class="string">"SheffleGroupingBolt1-&gt;execute:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;,value:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId(),word);</span><br><span class="line">        collector.emit(<span class="keyword">new</span> Values(word));</span><br><span class="line">        collector.ack(tuple);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</span><br><span class="line">        declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"bolt"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>topology<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sonly.storm.demo1.grouppings;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sonly.storm.demo1.grouppings.spout.WordSpout;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.Config;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.LocalCluster;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.StormSubmitter;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.generated.AlreadyAliveException;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.generated.AuthorizationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.generated.InvalidTopologyException;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.TopologyBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Fields;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;package:com.sonly.storm.demo1&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;project(项目):stormstudy&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;class(类)$&#123;CLASS_NAME&#125;&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;creat date(创建时间):2019-05-09 21:55&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;author(作者):&lt;/b&gt;xxydliuyss&lt;/br&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;note(备注)):&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * If you want to change the file header,please modify zhe File and Code Templates.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShuffleGroupingToplogy</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(ShuffleGroupingToplogy.class);</span><br><span class="line">    <span class="comment">//Topology Name</span></span><br><span class="line">    <span class="comment">//component prefix</span></span><br><span class="line">    <span class="comment">//workers</span></span><br><span class="line">    <span class="comment">//spout executor (parallelism_hint)</span></span><br><span class="line">    <span class="comment">//spout task size</span></span><br><span class="line">    <span class="comment">//bolt executor (parallelism_hint)</span></span><br><span class="line">    <span class="comment">//bolt task size</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</span><br><span class="line">        Config conf = <span class="keyword">new</span> Config();</span><br><span class="line">        conf.setDebug(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (args==<span class="keyword">null</span> || args.length &lt; <span class="number">7</span>) &#123;</span><br><span class="line">            conf.setNumWorkers(<span class="number">3</span>);</span><br><span class="line">            builder.setSpout(<span class="string">"spout"</span>, <span class="keyword">new</span> WordSpout(), <span class="number">4</span>).setNumTasks(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">            builder.setBolt(<span class="string">"split-bolt"</span>, <span class="keyword">new</span> SheffleGrouppingBolt1(),  <span class="number">4</span>).shuffleGrouping(<span class="string">"spout"</span>).setNumTasks(<span class="number">8</span>);</span><br><span class="line">            builder.setBolt(<span class="string">"count-bolt"</span>, <span class="keyword">new</span> SheffleGroupingBolt(), <span class="number">8</span>).fieldsGrouping(<span class="string">"split-bolt"</span>, <span class="keyword">new</span> Fields(<span class="string">"word"</span>)).setNumTasks(<span class="number">8</span>);</span><br><span class="line">            LocalCluster cluster = <span class="keyword">new</span> LocalCluster();</span><br><span class="line">            cluster.submitTopology(<span class="string">"word-count"</span>, conf, builder.createTopology());</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">            cluster.killTopology(<span class="string">"word-count"</span>);</span><br><span class="line">            cluster.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            Options options = Options.builder(args);</span><br><span class="line">            LOGGER.warn(<span class="string">"The Topology Options &#123;&#125; is Submited "</span>,options.toString());</span><br><span class="line">            conf.setNumWorkers(options.getWorkers());</span><br><span class="line">            builder.setSpout(options.getPrefix()+<span class="string">"-spout"</span>, <span class="keyword">new</span> WordSpout(), options.getSpoutParallelismHint()).setNumTasks(options.getSpoutTaskSize());</span><br><span class="line"></span><br><span class="line">            builder.setBolt(<span class="string">"bolt1"</span>, <span class="keyword">new</span> SheffleGrouppingBolt1(),  options.getBoltParallelismHint()).shuffleGrouping(options.getPrefix()+<span class="string">"-spout"</span>).setNumTasks(options.getBoltTaskSize());</span><br><span class="line">            builder.setBolt(<span class="string">"bolt"</span>, <span class="keyword">new</span> SheffleGroupingBolt(), options.getBoltParallelismHint()).shuffleGrouping(options.getPrefix()+<span class="string">"-spout"</span>).setNumTasks(options.getBoltTaskSize());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                StormSubmitter.submitTopologyWithProgressBar(options.getTopologyName(), conf, builder.createTopology());</span><br><span class="line">                LOGGER.warn(<span class="string">"==========================================================="</span>);</span><br><span class="line">                LOGGER.warn(<span class="string">"The Topology &#123;&#125; is Submited "</span>,options.getTopologyName());</span><br><span class="line">                LOGGER.warn(<span class="string">"==========================================================="</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (AlreadyAliveException | InvalidTopologyException | AuthorizationException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Options</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String topologyName;</span><br><span class="line">        <span class="keyword">private</span> String prefix;</span><br><span class="line">        <span class="keyword">private</span> Integer workers;</span><br><span class="line">        <span class="keyword">private</span> Integer spoutParallelismHint;</span><br><span class="line">        <span class="keyword">private</span> Integer spoutTaskSize;</span><br><span class="line">        <span class="keyword">private</span> Integer boltParallelismHint;</span><br><span class="line">        <span class="keyword">private</span> Integer boltTaskSize;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Options</span><span class="params">(String topologyName, String prefix, Integer workers, Integer spoutParallelismHint, Integer spoutTaskSize, Integer boltParallelismHint, Integer boltTaskSize)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.topologyName = topologyName;</span><br><span class="line">            <span class="keyword">this</span>.prefix = prefix;</span><br><span class="line">            <span class="keyword">this</span>.workers = workers;</span><br><span class="line">            <span class="keyword">this</span>.spoutParallelismHint = spoutParallelismHint;</span><br><span class="line">            <span class="keyword">this</span>.spoutTaskSize = spoutTaskSize;</span><br><span class="line">            <span class="keyword">this</span>.boltParallelismHint = boltParallelismHint;</span><br><span class="line">            <span class="keyword">this</span>.boltTaskSize = boltTaskSize;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Options <span class="title">builder</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Options(args[<span class="number">0</span>],args[<span class="number">1</span>],Integer.parseInt(args[<span class="number">2</span>])</span><br><span class="line">            ,Integer.parseInt(args[<span class="number">3</span>]),Integer.parseInt(args[<span class="number">4</span>]),Integer.parseInt(args[<span class="number">5</span>]),Integer.parseInt(args[<span class="number">6</span>])</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getTopologyName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> topologyName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTopologyName</span><span class="params">(String topologyName)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.topologyName = topologyName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getPrefix</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> prefix;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrefix</span><span class="params">(String prefix)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.prefix = prefix;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getWorkers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> workers;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWorkers</span><span class="params">(Integer workers)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.workers = workers;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getSpoutParallelismHint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> spoutParallelismHint;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSpoutParallelismHint</span><span class="params">(Integer spoutParallelismHint)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.spoutParallelismHint = spoutParallelismHint;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getSpoutTaskSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> spoutTaskSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSpoutTaskSize</span><span class="params">(Integer spoutTaskSize)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.spoutTaskSize = spoutTaskSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getBoltParallelismHint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> boltParallelismHint;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBoltParallelismHint</span><span class="params">(Integer boltParallelismHint)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.boltParallelismHint = boltParallelismHint;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getBoltTaskSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> boltTaskSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBoltTaskSize</span><span class="params">(Integer boltTaskSize)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.boltTaskSize = boltTaskSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Options&#123;"</span> +</span><br><span class="line">                    <span class="string">"topologyName='"</span> + topologyName + <span class="string">'\''</span> +</span><br><span class="line">                    <span class="string">", prefix='"</span> + prefix + <span class="string">'\''</span> +</span><br><span class="line">                    <span class="string">", workers="</span> + workers +</span><br><span class="line">                    <span class="string">", spoutParallelismHint="</span> + spoutParallelismHint +</span><br><span class="line">                    <span class="string">", spoutTaskSize="</span> + spoutTaskSize +</span><br><span class="line">                    <span class="string">", boltParallelismHint="</span> + boltParallelismHint +</span><br><span class="line">                    <span class="string">", boltTaskSize="</span> + boltTaskSize +</span><br><span class="line">                    <span class="string">'&#125;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>mvn package 打包，上传到storm服务器</p><h2 id="ShuffleGrouping-样例分析"><a href="#ShuffleGrouping-样例分析" class="headerlink" title="ShuffleGrouping 样例分析"></a>ShuffleGrouping 样例分析</h2><p><strong>1)样例1</strong></p><p>1.执行：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">storm jar strom-study-1.0-SNAPSHOT-jar-with-dependencies.jar com.sonly.storm.demo1.grouppings.ShuffleGroupingToplogy ShuffleGrouping ShuffleGrouping 1 2 1 2 1</span><br></pre></td></tr></table></figure><p></p><p>2.参数：</p><p>topologyName=’ShuffleGrouping’, prefix=’ShuffleGrouping’, workers=1, spoutParallelismHint=2, spoutTaskSize=1, boltParallelismHint=2, boltTaskSize=1<br>3.拓扑图：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557542411480.png" alt="enter description here"><br>一个spout接了两个bolt<br>4.查看一下这个bolt分布情况：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557542590072.png" alt="enter description here"><br>5.进入服务器去看每一个bolt的日志<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">2019-05-07 18:09:13.109 c.s.s.d.g.SheffleGrouppingBolt1 Thread-11-bolt1-executor[5 5] [WARN] SheffleGroupingBolt1-&gt;execute:hashcode:1393282516-&gt;ThreadId:45,TaskId:5,value:zhangsan</span><br><span class="line">2019-05-07 18:09:13.110 c.s.s.d.g.SheffleGrouppingBolt1 Thread-11-bolt1-executor[5 5] [WARN] SheffleGroupingBolt1-&gt;execute:hashcode:1393282516-&gt;ThreadId:45,TaskId:5,value:zhangsan</span><br><span class="line">2019-05-07 18:09:13.110 c.s.s.d.g.SheffleGrouppingBolt1 Thread-11-bolt1-executor[5 5] [WARN] SheffleGroupingBolt1-&gt;execute:hashcode:1393282516-&gt;ThreadId:45,TaskId:5,value:zhangsan</span><br><span class="line">2019-05-07 18:09:13.111 c.s.s.d.g.SheffleGrouppingBolt1 Thread-11-bolt1-executor[5 5] [WARN] SheffleGroupingBolt1-&gt;execute:hashcode:1393282516-&gt;ThreadId:45,TaskId:5,value:zhangsan</span><br><span class="line">2019-05-07 18:09:13.112 c.s.s.d.g.SheffleGrouppingBolt1 Thread-11-bolt1-executor[5 5] [WARN] SheffleGroupingBolt1-&gt;execute:hashcode:1393282516-&gt;ThreadId:45,TaskId:5,value:zhangsan</span><br><span class="line">2019-05-07 18:09:13.115 c.s.s.d.g.SheffleGrouppingBolt1 Thread-11-bolt1-executor[5 5] [WARN] SheffleGroupingBolt1-&gt;execute:hashcode:1393282516-&gt;ThreadId:45,TaskId:5,value:zhangsan</span><br><span class="line">2019-05-07 18:09:13.116 c.s.s.d.g.SheffleGrouppingBolt1 Thread-11-bolt1-executor[5 5] [WARN] SheffleGroupingBolt1-&gt;execute:hashcode:1393282516-&gt;ThreadId:45,TaskId:5,value:zhangsan</span><br><span class="line">2019-05-07 18:09:13.117 c.s.s.d.g.SheffleGrouppingBolt1 Thread-11-bolt1-executor[5 5] [WARN] SheffleGroupingBolt1-&gt;execute:hashcode:1393282516-&gt;ThreadId:45,TaskId:5,value:zhangsan</span><br><span class="line">2019-05-07 18:09:13.118 c.s.s.d.g.SheffleGrouppingBolt1 Thread-11-bolt1-executor[5 5] [WARN] SheffleGroupingBolt1-&gt;execute:hashcode:1393282516-&gt;ThreadId:45,TaskId:5,value:lisi</span><br><span class="line">2019-05-07 18:09:13.119 c.s.s.d.g.SheffleGrouppingBolt1 Thread-11-bolt1-executor[5 5] [WARN] SheffleGroupingBolt1-&gt;execute:hashcode:1393282516-&gt;ThreadId:45,TaskId:5,value:lisi</span><br></pre></td></tr></table></figure><p></p><p>6.进入另外一个bolt的日志 10条信息被处理了<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">2019-05-07 18:09:00.791 c.s.s.d.g.SheffleGroupingBolt Thread-9-bolt-executor[4 4] [WARN] SheffleGroupingBolt-&gt;execute:hashcode:1430296959-&gt;ThreadId:43,TaskId:4,value:zhangsan</span><br><span class="line">2019-05-07 18:09:00.793 c.s.s.d.g.SheffleGroupingBolt Thread-9-bolt-executor[4 4] [WARN] SheffleGroupingBolt-&gt;execute:hashcode:1430296959-&gt;ThreadId:43,TaskId:4,value:zhangsan</span><br><span class="line">2019-05-07 18:09:00.794 c.s.s.d.g.SheffleGroupingBolt Thread-9-bolt-executor[4 4] [WARN] SheffleGroupingBolt-&gt;execute:hashcode:1430296959-&gt;ThreadId:43,TaskId:4,value:zhangsan</span><br><span class="line">2019-05-07 18:09:00.795 c.s.s.d.g.SheffleGroupingBolt Thread-9-bolt-executor[4 4] [WARN] SheffleGroupingBolt-&gt;execute:hashcode:1430296959-&gt;ThreadId:43,TaskId:4,value:zhangsan</span><br><span class="line">2019-05-07 18:09:00.795 c.s.s.d.g.SheffleGroupingBolt Thread-9-bolt-executor[4 4] [WARN] SheffleGroupingBolt-&gt;execute:hashcode:1430296959-&gt;ThreadId:43,TaskId:4,value:zhangsan</span><br><span class="line">2019-05-07 18:09:00.796 c.s.s.d.g.SheffleGroupingBolt Thread-9-bolt-executor[4 4] [WARN] SheffleGroupingBolt-&gt;execute:hashcode:1430296959-&gt;ThreadId:43,TaskId:4,value:zhangsan</span><br><span class="line">2019-05-07 18:09:00.797 c.s.s.d.g.SheffleGroupingBolt Thread-9-bolt-executor[4 4] [WARN] SheffleGroupingBolt-&gt;execute:hashcode:1430296959-&gt;ThreadId:43,TaskId:4,value:zhangsan</span><br><span class="line">2019-05-07 18:09:00.805 c.s.s.d.g.SheffleGroupingBolt Thread-9-bolt-executor[4 4] [WARN] SheffleGroupingBolt-&gt;execute:hashcode:1430296959-&gt;ThreadId:43,TaskId:4,value:zhangsan</span><br><span class="line">2019-05-07 18:09:00.805 c.s.s.d.g.SheffleGroupingBolt Thread-9-bolt-executor[4 4] [WARN] SheffleGroupingBolt-&gt;execute:hashcode:1430296959-&gt;ThreadId:43,TaskId:4,value:lisi</span><br><span class="line">2019-05-07 18:09:00.806 c.s.s.d.g.SheffleGroupingBolt Thread-9-bolt-executor[4 4] [WARN] SheffleGroupingBolt-&gt;execute:hashcode:1430296959-&gt;ThreadId:43,TaskId:4,value:lisi</span><br></pre></td></tr></table></figure><p></p><p>也是一样10条被处理了<br><strong>总结：</strong><br><strong>对于spout直接对接两个bolt，sheffgrouping 分组不会随机给两个bolt分配消息，而是全量发给两个BOlT</strong></p><p><strong>2）样例2</strong></p><p>1.修改一下参数看一下：<br>topologyName=’ShuffleGrouping1’, prefix=’ShuffleGrouping1’, workers=2, spoutParallelismHint=1, spoutTaskSize=2, boltParallelismHint=2, boltTaskSize=2<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557544178946.png" alt="enter description here"><br>总共4个bolt，两个spout，总共发送了40条消息，spout产生消息20条。transfer了40次。<br>看看4个bolt的消息分配的情况。<br>因为只有两个worker所以会有两个bolt在同一个work上，日志会打在一起，但是从名字可以可以区分开来，同样每个bolt都是10条。</p><p>2.修改拓扑结构为：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557547693509.png" alt="enter description here"><br>3.修改代码：<br>bolt<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String word = tuple.getStringByField(<span class="string">"bolt"</span>);</span><br></pre></td></tr></table></figure><p></p><p>topoloy：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> builder.setBolt(<span class="string">"bolt1"</span>, <span class="keyword">new</span> SheffleGrouppingBolt1(), <span class="number">1</span>).shuffleGrouping(options.getPrefix()+<span class="string">"-spout"</span>);</span><br><span class="line">builder.setBolt(<span class="string">"bolt"</span>, <span class="keyword">new</span> SheffleGroupingBolt(), options.getBoltParallelismHint()).shuffleGrouping(<span class="string">"bolt1"</span>).setNumTasks(options.getBoltTaskSize());</span><br></pre></td></tr></table></figure><p></p><p>4.参数：<br>topologyName=’ShuffleGrouping2’, prefix=’ShuffleGrouping2’, workers=2, spoutParallelismHint=1, spoutTaskSize=1, boltParallelismHint=2, boltTaskSize=2<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557547737355.png" alt="enter description here"><br>5.查看日志：k8s-n2 这个节点只有bolt bolt1这个节点在k8s-n3上<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-n2 6706]# grep &quot;SheffleGroupingBolt-&gt;execute&quot; worker.log |wc -l</span><br><span class="line">3</span><br><span class="line">[root@k8s-n2 6706]# grep &quot;SheffleGroupingBolt1-&gt;execute&quot; worker.log |wc -l</span><br><span class="line">0</span><br><span class="line">[root@k8s-n3 6706]#  grep &quot;SheffleGroupingBolt-&gt;execute&quot; worker.log |wc -l</span><br><span class="line">7</span><br><span class="line">[root@k8s-n3 6706]#  grep &quot;SheffleGroupingBolt1-&gt;execute&quot; worker.log |wc -l</span><br><span class="line">10</span><br></pre></td></tr></table></figure><p></p><p>可以看出来bolt1-&gt;bolt这条线上的数据被随机分配了一个三条一个两条。<br><strong>总结：</strong><br><strong>对于bolt 连接bolt的shuffingGrouping，消息是随机分配到多个bolt上面的</strong></p><h1 id="Fields-grouping"><a href="#Fields-grouping" class="headerlink" title="Fields grouping"></a>Fields grouping</h1><h2 id="Fields-grouping-的实例"><a href="#Fields-grouping-的实例" class="headerlink" title="Fields grouping 的实例"></a>Fields grouping 的实例</h2><p>代码:<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeildGroupingToplogy</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(FeildGroupingToplogy.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Topology Name</span></span><br><span class="line">    <span class="comment">//component prefix</span></span><br><span class="line">    <span class="comment">//workers</span></span><br><span class="line">    <span class="comment">//spout executor (parallelism_hint)</span></span><br><span class="line">    <span class="comment">//spout task size</span></span><br><span class="line">    <span class="comment">//bolt executor (parallelism_hint)</span></span><br><span class="line">    <span class="comment">//bolt task size</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</span><br><span class="line">        Config conf = <span class="keyword">new</span> Config();</span><br><span class="line">        conf.setDebug(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        Options options = Options.builder(args);</span><br><span class="line">        LOGGER.warn(<span class="string">"The Topology Options &#123;&#125; is Submited "</span>, options.toString());</span><br><span class="line">        conf.setNumWorkers(options.getWorkers());</span><br><span class="line">        String spoutName = options.getPrefix() + <span class="string">"-spout"</span>;</span><br><span class="line">        builder.setSpout(spoutName, <span class="keyword">new</span> WordSpout(), options.getSpoutParallelismHint()).setNumTasks(options.getSpoutTaskSize());</span><br><span class="line">         builder.setBolt(options.getPrefix() + <span class="string">"bolt1"</span>, <span class="keyword">new</span> FieldGrouppingBolt1(), options.getBoltParallelismHint()).fieldsGrouping(spoutName, <span class="keyword">new</span> Fields(<span class="string">"sentence"</span>)).setNumTasks(options.getBoltTaskSize());</span><br><span class="line">        builder.setBolt(options.getPrefix() + <span class="string">"bolt"</span>, <span class="keyword">new</span> FieldGroupingBolt(), options.getBoltParallelismHint()).fieldsGrouping(spoutName, <span class="keyword">new</span> Fields(<span class="string">"sentence"</span>)).setNumTasks(options.getBoltTaskSize());</span><br><span class="line"><span class="comment">//            builder.setBolt("bolt1", new FieldGrouppingBolt1(), 1).shuffleGrouping(options.getPrefix()+"-spout");</span></span><br><span class="line"><span class="comment">//            builder.setBolt("bolt", new FieldGroupingBolt(), options.getBoltParallelismHint()).fieldsGrouping("bolt1",new Fields("bolt")).setNumTasks(options.getBoltTaskSize());</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            StormSubmitter.submitTopologyWithProgressBar(options.getTopologyName(), conf, builder.createTopology());</span><br><span class="line">            LOGGER.warn(<span class="string">"==========================================================="</span>);</span><br><span class="line">            LOGGER.warn(<span class="string">"The Topology &#123;&#125; is Submited "</span>, options.getTopologyName());</span><br><span class="line">            LOGGER.warn(<span class="string">"==========================================================="</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AlreadyAliveException | InvalidTopologyException | AuthorizationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Options</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String topologyName;</span><br><span class="line">        <span class="keyword">private</span> String prefix;</span><br><span class="line">        <span class="keyword">private</span> Integer workers;</span><br><span class="line">        <span class="keyword">private</span> Integer spoutParallelismHint;</span><br><span class="line">        <span class="keyword">private</span> Integer spoutTaskSize;</span><br><span class="line">        <span class="keyword">private</span> Integer boltParallelismHint;</span><br><span class="line">        <span class="keyword">private</span> Integer boltTaskSize;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Options</span><span class="params">(String topologyName, String prefix, Integer workers, Integer spoutParallelismHint, Integer spoutTaskSize, Integer boltParallelismHint, Integer boltTaskSize)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.topologyName = topologyName;</span><br><span class="line">            <span class="keyword">this</span>.prefix = prefix;</span><br><span class="line">            <span class="keyword">this</span>.workers = workers;</span><br><span class="line">            <span class="keyword">this</span>.spoutParallelismHint = spoutParallelismHint;</span><br><span class="line">            <span class="keyword">this</span>.spoutTaskSize = spoutTaskSize;</span><br><span class="line">            <span class="keyword">this</span>.boltParallelismHint = boltParallelismHint;</span><br><span class="line">            <span class="keyword">this</span>.boltTaskSize = boltTaskSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Options <span class="title">builder</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Options(args[<span class="number">0</span>], args[<span class="number">1</span>], Integer.parseInt(args[<span class="number">2</span>])</span><br><span class="line">                    , Integer.parseInt(args[<span class="number">3</span>]), Integer.parseInt(args[<span class="number">4</span>]), Integer.parseInt(args[<span class="number">5</span>]), Integer.parseInt(args[<span class="number">6</span>])</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getTopologyName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> topologyName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTopologyName</span><span class="params">(String topologyName)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.topologyName = topologyName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getPrefix</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> prefix;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrefix</span><span class="params">(String prefix)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.prefix = prefix;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getWorkers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> workers;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWorkers</span><span class="params">(Integer workers)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.workers = workers;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getSpoutParallelismHint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> spoutParallelismHint;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSpoutParallelismHint</span><span class="params">(Integer spoutParallelismHint)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.spoutParallelismHint = spoutParallelismHint;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getSpoutTaskSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> spoutTaskSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSpoutTaskSize</span><span class="params">(Integer spoutTaskSize)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.spoutTaskSize = spoutTaskSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getBoltParallelismHint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> boltParallelismHint;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBoltParallelismHint</span><span class="params">(Integer boltParallelismHint)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.boltParallelismHint = boltParallelismHint;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getBoltTaskSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> boltTaskSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBoltTaskSize</span><span class="params">(Integer boltTaskSize)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.boltTaskSize = boltTaskSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Options&#123;"</span> +</span><br><span class="line">                    <span class="string">"topologyName='"</span> + topologyName + <span class="string">'\''</span> +</span><br><span class="line">                    <span class="string">", prefix='"</span> + prefix + <span class="string">'\''</span> +</span><br><span class="line">                    <span class="string">", workers="</span> + workers +</span><br><span class="line">                    <span class="string">", spoutParallelismHint="</span> + spoutParallelismHint +</span><br><span class="line">                    <span class="string">", spoutTaskSize="</span> + spoutTaskSize +</span><br><span class="line">                    <span class="string">", boltParallelismHint="</span> + boltParallelismHint +</span><br><span class="line">                    <span class="string">", boltTaskSize="</span> + boltTaskSize +</span><br><span class="line">                    <span class="string">'&#125;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FieldGroupingBolt</span> <span class="keyword">extends</span> <span class="title">BaseRichBolt</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(FieldGroupingBolt.class);</span><br><span class="line">    <span class="keyword">private</span> TopologyContext context;</span><br><span class="line">    <span class="keyword">private</span> Map conf;</span><br><span class="line">    <span class="keyword">private</span> OutputCollector collector;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Integer&gt; counts = <span class="keyword">new</span> HashMap(<span class="number">16</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map map, TopologyContext topologyContext, OutputCollector outputCollector)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.conf=map;</span><br><span class="line">        <span class="keyword">this</span>.context = topologyContext;</span><br><span class="line">        <span class="keyword">this</span>.collector = outputCollector;</span><br><span class="line">        LOGGER.warn(<span class="string">"FieldGroupingBolt-&gt;prepare:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple tuple)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String word = tuple.getStringByField(<span class="string">"bolt"</span>);</span><br><span class="line">        LOGGER.warn(<span class="string">"FieldGroupingBolt-&gt;execute:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;,value:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId(),word);</span><br><span class="line">        collector.emit(<span class="keyword">new</span> Values(word));</span><br><span class="line">        collector.ack(tuple);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</span><br><span class="line">        declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"bolt1"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FieldGrouppingBolt1</span> <span class="keyword">extends</span> <span class="title">BaseRichBolt</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(FieldGrouppingBolt1.class);</span><br><span class="line">    <span class="keyword">private</span> TopologyContext context;</span><br><span class="line">    <span class="keyword">private</span> OutputCollector collector;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map map, TopologyContext topologyContext, OutputCollector outputCollector)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context = topologyContext;</span><br><span class="line">        <span class="keyword">this</span>.collector = outputCollector;</span><br><span class="line">        LOGGER.warn(<span class="string">"FieldGrouppingBolt1-&gt;prepare:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple tuple)</span> </span>&#123;</span><br><span class="line">        String word = tuple.getStringByField(<span class="string">"sentence"</span>);</span><br><span class="line">        LOGGER.warn(<span class="string">"SheffleGroupingBolt1-&gt;execute:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;,value:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId(),word);</span><br><span class="line">        collector.emit(<span class="keyword">new</span> Values(word));</span><br><span class="line">        collector.ack(tuple);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</span><br><span class="line">        declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"bolt"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.打包上传到服务器<br>3.执行：<br></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">storm jar strom-study-1.0-SNAPSHOT-jar-with-dependencies.jar com.sonly.storm.demo1.grouppings.fieldgrouping.FeildGroupingToplogy FieldGrouping1 FieldGrouping1 2 1 1 2 2</span><br></pre></td></tr></table></figure><p></p><p>4.参数<br>topologyName=’FieldGrouping1’, prefix=’FieldGrouping1’, workers=2, spoutParallelismHint=1, spoutTaskSize=1, boltParallelismHint=2, boltTaskSize=2<br>5。拓扑图：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557580946479.png" alt="enter description here"><br>6.并发度以及组件分布图：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557581055667.png" alt="enter description here"><br>同样看图可以看到消息被发送了20次，但是被transfer40次。这是因为spout对bolt，对消息进行了复制，全量发送到了每个bolt，所以每个bolt都会有10条消息。<br><strong>总结：</strong><br><strong>和sheffleGrouping 一样，spout-&gt;bolt是全量广播发送，每个bolt都会spout的全量消息。</strong></p><p><strong>样例2</strong><br>1.修改拓扑的代码<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        TopologyBuilder builder = new TopologyBuilder();</span><br><span class="line">        Config conf = new Config();</span><br><span class="line">        conf.setDebug(true);</span><br><span class="line"></span><br><span class="line">        Options options = Options.builder(args);</span><br><span class="line">        LOGGER.warn(&quot;The Topology Options &#123;&#125; is Submited &quot;, options.toString());</span><br><span class="line">        conf.setNumWorkers(options.getWorkers());</span><br><span class="line">        String spoutName = options.getPrefix() + &quot;-spout&quot;;</span><br><span class="line">        builder.setSpout(spoutName, new WordSpout(), options.getSpoutParallelismHint()).setNumTasks(options.getSpoutTaskSize());</span><br><span class="line">//        builder.setBolt(options.getPrefix() + &quot;bolt1&quot;, new FieldGrouppingBolt1(), options.getBoltParallelismHint()).fieldsGrouping(spoutName, new Fields(&quot;sentence&quot;)).setNumTasks(options.getBoltTaskSize());</span><br><span class="line">//        builder.setBolt(options.getPrefix() + &quot;bolt&quot;, new FieldGroupingBolt(), options.getBoltParallelismHint()).fieldsGrouping(spoutName, new Fields(&quot;sentence&quot;)).setNumTasks(options.getBoltTaskSize());</span><br><span class="line">            builder.setBolt(&quot;bolt1&quot;, new FieldGrouppingBolt1(), 1).fieldsGrouping(spoutName, new Fields(&quot;sentence&quot;));</span><br><span class="line">            builder.setBolt(&quot;bolt&quot;, new FieldGroupingBolt(), options.getBoltParallelismHint()).fieldsGrouping(&quot;bolt1&quot;,new Fields(&quot;bolt&quot;)).setNumTasks(options.getBoltTaskSize());</span><br><span class="line">        try &#123;</span><br><span class="line">            StormSubmitter.submitTopologyWithProgressBar(options.getTopologyName(), conf, builder.createTopology());</span><br><span class="line">            LOGGER.warn(&quot;===========================================================&quot;);</span><br><span class="line">            LOGGER.warn(&quot;The Topology &#123;&#125; is Submited &quot;, options.getTopologyName());</span><br><span class="line">            LOGGER.warn(&quot;===========================================================&quot;);</span><br><span class="line">        &#125; catch (AlreadyAliveException | InvalidTopologyException | AuthorizationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="FieldGrouping-样例分析"><a href="#FieldGrouping-样例分析" class="headerlink" title="FieldGrouping 样例分析"></a>FieldGrouping 样例分析</h2><p><strong>1）样例1</strong></p><p>2.将上面代码打包上传服务器执行命令<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">storm jar strom-study-1.0-SNAPSHOT-jar-with-dependencies.jar com.sonly.storm.demo1.grouppings.fieldgrouping.FeildGroupingToplogy FieldGrouping2 FieldGrouping2 2 1 1 2 2</span><br></pre></td></tr></table></figure><p></p><p>3.参数<br>topologyName=’FieldGrouping2’, prefix=’FieldGrouping2’, workers=2, spoutParallelismHint=1, spoutTaskSize=1, boltParallelismHint=2, boltTaskSize=<br>4.拓扑图：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557583229548.png" alt="enter description here"><br>6.并发度以及组件分布图：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557583288457.png" alt="enter description here"><br>7.根据分布情况检查各个work的日志查看消息的发送情况<br>k8s-n3节点上：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-n3 6701]# grep &quot;SheffleGroupingBolt1-&gt;execute&quot; worker.log|wc -l</span><br><span class="line">10</span><br><span class="line">[root@k8s-n3 6701]# grep &quot;FieldGroupingBolt-&gt;execute&quot; worker.log|wc -l</span><br><span class="line">2</span><br></pre></td></tr></table></figure><p></p><p>k8s-n2节点：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-n2 6701]# grep &quot;SheffleGroupingBolt1-&gt;execute&quot; worker.log|wc -l</span><br><span class="line">0</span><br><span class="line">[root@k8s-n2 6701]# grep &quot;FieldGroupingBolt-&gt;execute&quot; worker.log|wc -l</span><br><span class="line">8</span><br></pre></td></tr></table></figure><p></p><p>再看一下详情如何<br>k8s-n3：bolt1有10条消息应为bolt只有一个所以Fied分组是不会生效的。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-n3 6701]# grep &quot;SheffleGroupingBolt1-&gt;execute&quot; worker.log</span><br><span class="line">2019-05-07 21:59:35.805 c.s.s.d.g.f.FieldGrouppingBolt1 Thread-7-bolt1-executor[6 6] [WARN] SheffleGroupingBolt1-&gt;execute:hashcode:107880849-&gt;ThreadId:41,TaskId:6,value:zhangsan</span><br><span class="line">2019-05-07 21:59:35.810 c.s.s.d.g.f.FieldGrouppingBolt1 Thread-7-bolt1-executor[6 6] [WARN] SheffleGroupingBolt1-&gt;execute:hashcode:107880849-&gt;ThreadId:41,TaskId:6,value:zhangsan</span><br><span class="line">2019-05-07 21:59:35.810 c.s.s.d.g.f.FieldGrouppingBolt1 Thread-7-bolt1-executor[6 6] [WARN] SheffleGroupingBolt1-&gt;execute:hashcode:107880849-&gt;ThreadId:41,TaskId:6,value:zhangsan</span><br><span class="line">2019-05-07 21:59:35.811 c.s.s.d.g.f.FieldGrouppingBolt1 Thread-7-bolt1-executor[6 6] [WARN] SheffleGroupingBolt1-&gt;execute:hashcode:107880849-&gt;ThreadId:41,TaskId:6,value:zhangsan</span><br><span class="line">2019-05-07 21:59:35.811 c.s.s.d.g.f.FieldGrouppingBolt1 Thread-7-bolt1-executor[6 6] [WARN] SheffleGroupingBolt1-&gt;execute:hashcode:107880849-&gt;ThreadId:41,TaskId:6,value:zhangsan</span><br><span class="line">2019-05-07 21:59:35.812 c.s.s.d.g.f.FieldGrouppingBolt1 Thread-7-bolt1-executor[6 6] [WARN] SheffleGroupingBolt1-&gt;execute:hashcode:107880849-&gt;ThreadId:41,TaskId:6,value:zhangsan</span><br><span class="line">2019-05-07 21:59:35.813 c.s.s.d.g.f.FieldGrouppingBolt1 Thread-7-bolt1-executor[6 6] [WARN] SheffleGroupingBolt1-&gt;execute:hashcode:107880849-&gt;ThreadId:41,TaskId:6,value:zhangsan</span><br><span class="line">2019-05-07 21:59:35.814 c.s.s.d.g.f.FieldGrouppingBolt1 Thread-7-bolt1-executor[6 6] [WARN] SheffleGroupingBolt1-&gt;execute:hashcode:107880849-&gt;ThreadId:41,TaskId:6,value:zhangsan</span><br><span class="line">2019-05-07 21:59:35.815 c.s.s.d.g.f.FieldGrouppingBolt1 Thread-7-bolt1-executor[6 6] [WARN] SheffleGroupingBolt1-&gt;execute:hashcode:107880849-&gt;ThreadId:41,TaskId:6,value:lisi</span><br><span class="line">2019-05-07 21:59:35.838 c.s.s.d.g.f.FieldGrouppingBolt1 Thread-7-bolt1-executor[6 6] [WARN] SheffleGroupingBolt1-&gt;execute:hashcode:107880849-&gt;ThreadId:41,TaskId:6,value:lisi</span><br></pre></td></tr></table></figure><p></p><p>k8s-n3:bolt 有两个实例，按照field分组。里面有两条消息。都是lisi<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-n3 6701]# grep &quot;FieldGroupingBolt-&gt;execute&quot; worker.log</span><br><span class="line">2019-05-07 21:59:35.855 c.s.s.d.g.f.FieldGroupingBolt Thread-11-bolt-executor[4 4] [WARN] FieldGroupingBolt-&gt;execute:hashcode:281792799-&gt;ThreadId:45,TaskId:4,value:lisi</span><br><span class="line">2019-05-07 21:59:35.856 c.s.s.d.g.f.FieldGroupingBolt Thread-11-bolt-executor[4 4] [WARN] FieldGroupingBolt-&gt;execute:hashcode:281792799-&gt;ThreadId:45,TaskId:4,value:lisi</span><br></pre></td></tr></table></figure><p></p><p>k8s-n2: bolt 应该就是8条消息，验证一下<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-n2 6701]# grep &quot;FieldGroupingBolt-&gt;execute&quot; worker.log</span><br><span class="line">2019-05-07 21:59:48.315 c.s.s.d.g.f.FieldGroupingBolt Thread-11-bolt-executor[5 5] [WARN] FieldGroupingBolt-&gt;execute:hashcode:1858735164-&gt;ThreadId:45,TaskId:5,value:zhangsan</span><br><span class="line">2019-05-07 21:59:48.317 c.s.s.d.g.f.FieldGroupingBolt Thread-11-bolt-executor[5 5] [WARN] FieldGroupingBolt-&gt;execute:hashcode:1858735164-&gt;ThreadId:45,TaskId:5,value:zhangsan</span><br><span class="line">2019-05-07 21:59:48.317 c.s.s.d.g.f.FieldGroupingBolt Thread-11-bolt-executor[5 5] [WARN] FieldGroupingBolt-&gt;execute:hashcode:1858735164-&gt;ThreadId:45,TaskId:5,value:zhangsan</span><br><span class="line">2019-05-07 21:59:48.318 c.s.s.d.g.f.FieldGroupingBolt Thread-11-bolt-executor[5 5] [WARN] FieldGroupingBolt-&gt;execute:hashcode:1858735164-&gt;ThreadId:45,TaskId:5,value:zhangsan</span><br><span class="line">2019-05-07 21:59:48.318 c.s.s.d.g.f.FieldGroupingBolt Thread-11-bolt-executor[5 5] [WARN] FieldGroupingBolt-&gt;execute:hashcode:1858735164-&gt;ThreadId:45,TaskId:5,value:zhangsan</span><br><span class="line">2019-05-07 21:59:48.319 c.s.s.d.g.f.FieldGroupingBolt Thread-11-bolt-executor[5 5] [WARN] FieldGroupingBolt-&gt;execute:hashcode:1858735164-&gt;ThreadId:45,TaskId:5,value:zhangsan</span><br><span class="line">2019-05-07 21:59:48.319 c.s.s.d.g.f.FieldGroupingBolt Thread-11-bolt-executor[5 5] [WARN] FieldGroupingBolt-&gt;execute:hashcode:1858735164-&gt;ThreadId:45,TaskId:5,value:zhangsan</span><br><span class="line">2019-05-07 21:59:48.320 c.s.s.d.g.f.FieldGroupingBolt Thread-11-bolt-executor[5 5] [WARN] FieldGroupingBolt-&gt;execute:hashcode:1858735164-&gt;ThreadId:45,TaskId:5,value:zhangsan</span><br></pre></td></tr></table></figure><p></p><p><strong>总结：</strong><br><strong>bolt-&gt;bolt节点时，feild分组会按照field字段的key值进行分组，key相同的会被分配到一个bolt里面。</strong><br>如果执行<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">storm jar strom-study-1.0-SNAPSHOT-jar-with-dependencies.jar com.sonly.storm.demo1.grouppings.fieldgrouping.FeildGroupingToplogy FieldGrouping3 FieldGrouping3 4 1 1 4 4</span><br></pre></td></tr></table></figure><p></p><p>bolt 的分配情况是什么样子？这个留给大家去思考一下。例子中按照field分组后只有两种数据，但是这两种数据要分配给4个bolt，那这个是怎么分配的？我将在下一篇博客里揭晓答案！</p><p>下一篇我会继续分析这个分组策略，我会把我在学习这个storm的时候当时的自己思考的一个过程展现给大家，如果有什么错误的，或者没有讲清楚的地方，欢迎大家给我留言，咱们可以一起交流讨论。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun May 12 2019 12:14:16 GMT+0800 (GMT+08:00) --&gt;&lt;h1 id=&quot;storm的分组策略&quot;&gt;&lt;a href=&quot;#storm的分组策略&quot; class=&quot;headerlink&quot; title=&quot;storm的分
      
    
    </summary>
    
      <category term="storm" scheme="http://www.liuyong520.cn/categories/storm/"/>
    
    
      <category term="storm" scheme="http://www.liuyong520.cn/tags/storm/"/>
    
  </entry>
  
  <entry>
    <title>理解storm并发度</title>
    <link href="http://www.liuyong520.cn/2019/05/10/storm-parallelism/"/>
    <id>http://www.liuyong520.cn/2019/05/10/storm-parallelism/</id>
    <published>2019-05-10T03:46:25.000Z</published>
    <updated>2019-05-11T00:36:38.975Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun May 12 2019 12:14:16 GMT+0800 (GMT+08:00) --><h1 id="什么是storm的并发度"><a href="#什么是storm的并发度" class="headerlink" title="什么是storm的并发度"></a>什么是storm的并发度</h1><p>一个topology（拓扑）在storm集群上最总是以executor和task的形式运行在suppervisor管理的worker节点上。而worker进程都是运行在jvm虚拟机上面的，每个拓扑都会被拆开多个组件分布式的运行在worker节点上。<br>1.worker<br>2.executor<br>3.task<br>这三个简单关系图：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557460241883.png" alt="官方图"></p><p>一个worker工作进程运行一个拓扑的子集（其实就是拓扑的组件），每个组件的都会以executor（线程）在worker进程上执行，一个worker进程可以同时运行多个拓扑的组件也就是线程。</p><p>一个executor线程可以运行同一个组件的一个或者多个tasks</p><p>task是实际处理数据的执行者，每一个spout或者bolt会在集群上执行很多个task。在拓扑的生命周期内拓扑结构相同的拓扑的组件任务task数量总是相同的。但是每个组件的执行的线程（executor）数是可以变化的。这就意味着以下条件总是成立的：#threads ≤ #tasks 也就是task的数量总是大于线程数，一般情况下，任务task的数量往往设置成和线程（executor）的数量一致，这样，每个线程执行一个task。</p><p>在storm拓扑的并发度其实就是集群上拓扑组件在集群上运行的executor（线程）的数量。</p><h1 id="如何设置拓扑的并发度"><a href="#如何设置拓扑的并发度" class="headerlink" title="如何设置拓扑的并发度"></a>如何设置拓扑的并发度</h1><p>“并行度”如何配置？其实不仅仅是设置executor线程的数量,同时也要从worker工作进程和task任务的数量的方面考虑。<br>可以用以下几种方式配置并发度：<br>1.通过storm的配置文件配置。storm配置文件的加载优先级是：defaults.yaml &lt; storm.yaml &lt; topology-specific configuration &lt; internal component-specific configuration &lt; external component-specific configuration.<br>工作进程数<br>描述：为群集中的计算机上的拓扑创建多少个工作进程。<br>配置选项：TOPOLOGY_WORKERS<br>如何设置代码（示例）：<br>配置＃setNumWorkers<br>执行者数（线程数）<br>描述：每个组件生成多少个执行程序。<br>配置选项：无（将parallelism_hint参数传递给setSpout或setBolt）<br>如何设置代码（示例）：<br>TopologyBuilder＃setSpout（）<br>TopologyBuilder＃setBolt（）<br>请注意，从Storm 0.8开始，parallelism_hint参数现在指定该螺栓的执行者的初始数量（不是任务！）。<br>任务数量<br>描述：每个组件创建多少个任务。<br>配置选项：TOPOLOGY_TASKS<br>如何设置代码（示例）：<br>ComponentConfigurationDeclarer＃setNumTasks（）<br>以下是在实践中显示这些设置的示例代码段：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">topologyBuilder.setBolt(<span class="string">"green-bolt"</span>, <span class="keyword">new</span> GreenBolt(), <span class="number">2</span>)</span><br><span class="line">               .setNumTasks(<span class="number">4</span>)</span><br><span class="line">               .shuffleGrouping(<span class="string">"blue-spout"</span>);</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">在上面的代码中，我们配置了Storm来运行GreenBolt带有初始数量为两个执行器和四个相关任务的bolt 。Storm将为每个执行程序（线程）运行两个任务。如果您没有明确配置任务数，Storm将默认运行每个执行程序一个任务。</span><br><span class="line"></span><br><span class="line">#官方例子</span><br><span class="line">下图显示了简单拓扑在操作中的外观。拓扑结构由三个部分组成：一个叫做spout BlueSpout，两个叫做GreenBolt和YellowBolt。组件被链接，以便BlueSpout将其输出发送到GreenBolt，然后将其自己的输出发送到YellowBolt。</span><br><span class="line">![官方图](https:<span class="comment">//www.github.com/liuyong520/pic/raw/master/小书匠/1557460241883.png)</span></span><br><span class="line">在GreenBolt被配置为每代码段以上而BlueSpout和YellowBolt仅设置并行提示（执行人数）。这是相关代码：</span><br><span class="line">```java</span><br><span class="line">Config conf = <span class="keyword">new</span> Config();</span><br><span class="line">conf.setNumWorkers(<span class="number">2</span>); <span class="comment">// use two worker processes</span></span><br><span class="line"></span><br><span class="line">topologyBuilder.setSpout(<span class="string">"blue-spout"</span>, <span class="keyword">new</span> BlueSpout(), <span class="number">2</span>); <span class="comment">// set parallelism hint to 2</span></span><br><span class="line"></span><br><span class="line">topologyBuilder.setBolt(<span class="string">"green-bolt"</span>, <span class="keyword">new</span> GreenBolt(), <span class="number">2</span>)</span><br><span class="line">               .setNumTasks(<span class="number">4</span>)</span><br><span class="line">               .shuffleGrouping(<span class="string">"blue-spout"</span>);</span><br><span class="line"></span><br><span class="line">topologyBuilder.setBolt(<span class="string">"yellow-bolt"</span>, <span class="keyword">new</span> YellowBolt(), <span class="number">6</span>)</span><br><span class="line">               .shuffleGrouping(<span class="string">"green-bolt"</span>);</span><br><span class="line"></span><br><span class="line">StormSubmitter.submitTopology(</span><br><span class="line">        <span class="string">"mytopology"</span>,</span><br><span class="line">        conf,</span><br><span class="line">        topologyBuilder.createTopology()</span><br><span class="line">    );</span><br></pre></td></tr></table></figure><p>当然，Storm附带了额外的配置设置来控制拓扑的并行性，包括：</p><p>TOPOLOGY_MAX_TASK_PARALLELISM：此设置为可以为单个组件生成的执行程序数量设置上限。它通常在测试期间用于限制在本地模式下运行拓扑时产生的线程数。您可以通过例如Config＃setMaxTaskParallelism（）设置此选项。</p><h1 id="从实际运行的拓扑的角度理解storm的并发度"><a href="#从实际运行的拓扑的角度理解storm的并发度" class="headerlink" title="从实际运行的拓扑的角度理解storm的并发度"></a>从实际运行的拓扑的角度理解storm的并发度</h1><h2 id="自己写一个拓扑"><a href="#自己写一个拓扑" class="headerlink" title="自己写一个拓扑"></a>自己写一个拓扑</h2><p>实现一个可以设置worker数量，设置spout 、bolt 的Parallelism Hint的拓扑然后打包上传到storm集群运行。<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sonly.storm.demo1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.storm.Config;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.LocalCluster;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.StormSubmitter;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.generated.AlreadyAliveException;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.generated.AuthorizationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.generated.InvalidTopologyException;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.TopologyBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Fields;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;package:com.sonly.storm.demo1&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;project(项目):stormstudy&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;class(类)HelloToplogy&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;creat date(创建时间):2019-05-09 21:55&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;author(作者):&lt;/b&gt;xxydliuyss&lt;/br&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;note(备注)):&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * If you want to change the file header,please modify zhe File and Code Templates.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloToplogy</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(HelloToplogy.class);</span><br><span class="line">    <span class="comment">//Topology Name</span></span><br><span class="line">    <span class="comment">//component prefix</span></span><br><span class="line">    <span class="comment">//workers</span></span><br><span class="line">    <span class="comment">//spout executor (parallelism_hint)</span></span><br><span class="line">    <span class="comment">//spout task size</span></span><br><span class="line">    <span class="comment">//bolt executor (parallelism_hint)</span></span><br><span class="line">    <span class="comment">//bolt task size</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</span><br><span class="line">        Config conf = <span class="keyword">new</span> Config();</span><br><span class="line">        conf.setDebug(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (args==<span class="keyword">null</span> || args.length &lt; <span class="number">7</span>) &#123;</span><br><span class="line">            conf.setNumWorkers(<span class="number">3</span>);</span><br><span class="line">            builder.setSpout(<span class="string">"spout"</span>, <span class="keyword">new</span> HellowordSpout(), <span class="number">4</span>).setNumTasks(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">            builder.setBolt(<span class="string">"split-bolt"</span>, <span class="keyword">new</span> SplitBolt(),  <span class="number">4</span>).shuffleGrouping(<span class="string">"spout"</span>).setNumTasks(<span class="number">8</span>);</span><br><span class="line">            builder.setBolt(<span class="string">"count-bolt"</span>, <span class="keyword">new</span> HellowordBolt(), <span class="number">8</span>).fieldsGrouping(<span class="string">"split-bolt"</span>, <span class="keyword">new</span> Fields(<span class="string">"word"</span>)).setNumTasks(<span class="number">8</span>);</span><br><span class="line">            LocalCluster cluster = <span class="keyword">new</span> LocalCluster();</span><br><span class="line">            cluster.submitTopology(<span class="string">"word-count"</span>, conf, builder.createTopology());</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">            cluster.killTopology(<span class="string">"word-count"</span>);</span><br><span class="line">            cluster.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            Options options = Options.builder(args);</span><br><span class="line">            conf.setNumWorkers(options.getWorkers());</span><br><span class="line">            builder.setSpout(options.getPrefix()+<span class="string">"-spout"</span>, <span class="keyword">new</span> HellowordSpout(), options.getSpoutParallelismHint()).setNumTasks(options.getSpoutTaskSize());</span><br><span class="line"></span><br><span class="line">            builder.setBolt(options.getPrefix()+<span class="string">"-split-bolt"</span>, <span class="keyword">new</span> SplitBolt(),  options.getBoltParallelismHint()).shuffleGrouping(options.getPrefix()+<span class="string">"-spout"</span>).setNumTasks(options.getBoltTaskSize());</span><br><span class="line">            builder.setBolt(options.getPrefix()+<span class="string">"-count-bolt"</span>, <span class="keyword">new</span> HellowordBolt(), options.getBoltParallelismHint()).fieldsGrouping(options.getPrefix()+<span class="string">"-split-bolt"</span>, <span class="keyword">new</span> Fields(<span class="string">"word"</span>)).setNumTasks(options.getBoltTaskSize());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                StormSubmitter.submitTopologyWithProgressBar(options.getTopologyName(), conf, builder.createTopology());</span><br><span class="line">                LOGGER.warn(<span class="string">"==========================================================="</span>);</span><br><span class="line">                LOGGER.warn(<span class="string">"The Topology &#123;&#125; is Submited "</span>,options.getTopologyName());</span><br><span class="line">                LOGGER.warn(<span class="string">"==========================================================="</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (AlreadyAliveException | InvalidTopologyException | AuthorizationException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Options</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String topologyName;</span><br><span class="line">        <span class="keyword">private</span> String prefix;</span><br><span class="line">        <span class="keyword">private</span> Integer workers;</span><br><span class="line">        <span class="keyword">private</span> Integer spoutParallelismHint;</span><br><span class="line">        <span class="keyword">private</span> Integer spoutTaskSize;</span><br><span class="line">        <span class="keyword">private</span> Integer boltParallelismHint;</span><br><span class="line">        <span class="keyword">private</span> Integer boltTaskSize;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Options</span><span class="params">(String topologyName, String prefix, Integer workers, Integer spoutParallelismHint, Integer spoutTaskSize, Integer boltParallelismHint, Integer boltTaskSize)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.topologyName = topologyName;</span><br><span class="line">            <span class="keyword">this</span>.prefix = prefix;</span><br><span class="line">            <span class="keyword">this</span>.workers = workers;</span><br><span class="line">            <span class="keyword">this</span>.spoutParallelismHint = spoutParallelismHint;</span><br><span class="line">            <span class="keyword">this</span>.spoutTaskSize = spoutTaskSize;</span><br><span class="line">            <span class="keyword">this</span>.boltParallelismHint = boltParallelismHint;</span><br><span class="line">            <span class="keyword">this</span>.boltTaskSize = boltTaskSize;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Options <span class="title">builder</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Options(args[<span class="number">0</span>],args[<span class="number">1</span>],Integer.parseInt(args[<span class="number">2</span>])</span><br><span class="line">            ,Integer.parseInt(args[<span class="number">3</span>]),Integer.parseInt(args[<span class="number">4</span>]),Integer.parseInt(args[<span class="number">5</span>]),Integer.parseInt(args[<span class="number">6</span>])</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getTopologyName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> topologyName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTopologyName</span><span class="params">(String topologyName)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.topologyName = topologyName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getPrefix</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> prefix;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrefix</span><span class="params">(String prefix)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.prefix = prefix;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getWorkers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> workers;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWorkers</span><span class="params">(Integer workers)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.workers = workers;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getSpoutParallelismHint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> spoutParallelismHint;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSpoutParallelismHint</span><span class="params">(Integer spoutParallelismHint)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.spoutParallelismHint = spoutParallelismHint;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getSpoutTaskSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> spoutTaskSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSpoutTaskSize</span><span class="params">(Integer spoutTaskSize)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.spoutTaskSize = spoutTaskSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getBoltParallelismHint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> boltParallelismHint;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBoltParallelismHint</span><span class="params">(Integer boltParallelismHint)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.boltParallelismHint = boltParallelismHint;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getBoltTaskSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> boltTaskSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBoltTaskSize</span><span class="params">(Integer boltTaskSize)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.boltTaskSize = boltTaskSize;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>spout 类：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sonly.storm.demo1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.storm.spout.SpoutOutputCollector;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichSpout;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Fields;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Values;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Currency;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;package:com.sonly.storm.demo1&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;project(项目):stormstudy&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;class(类)$&#123;HellowordSpout&#125;&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;creat date(创建时间):2019-05-09 20:27&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;author(作者):&lt;/b&gt;xxydliuyss&lt;/br&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;note(备注)):&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * If you want to change the file header,please modify zhe File and Code Templates.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HellowordSpout</span> <span class="keyword">extends</span> <span class="title">BaseRichSpout</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(HellowordSpout.class);</span><br><span class="line">    <span class="comment">//拓扑上下文</span></span><br><span class="line">    <span class="keyword">private</span> TopologyContext context;</span><br><span class="line">    <span class="keyword">private</span> SpoutOutputCollector collector;</span><br><span class="line">    <span class="keyword">private</span> Map config;</span><br><span class="line">    <span class="keyword">private</span> Random random;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Map conf, TopologyContext topologyContext, SpoutOutputCollector collector)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.config = conf;</span><br><span class="line">        <span class="keyword">this</span>.context = topologyContext;</span><br><span class="line">        <span class="keyword">this</span>.collector = collector;</span><br><span class="line">        <span class="keyword">this</span>.random = <span class="keyword">new</span> Random();</span><br><span class="line">        LOGGER.warn(<span class="string">"HellowordSpout-&gt;open:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nextTuple</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String[] sentences = <span class="keyword">new</span> String[]&#123;<span class="string">"hello world !"</span>, <span class="string">"hello Storm !"</span>,</span><br><span class="line">                <span class="string">"hello apache flink !"</span>, <span class="string">"hello apache kafka stream !"</span>, <span class="string">"hello apache spark !"</span>&#125;;</span><br><span class="line">        <span class="keyword">final</span> String sentence = sentences[random.nextInt(sentences.length)];</span><br><span class="line">        collector.emit(<span class="keyword">new</span> Values(sentence));</span><br><span class="line">        LOGGER.warn(<span class="string">"HellowordSpout-&gt;nextTuple:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;,Values:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId(),sentence);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</span><br><span class="line">        declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"sentence"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LOGGER.warn(<span class="string">"HellowordSpout-&gt;close:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId());</span><br><span class="line">        <span class="keyword">super</span>.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>实现两个bolt一个用来统计单词出现个数，一个用来拆分语句。<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sonly.storm.demo1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.OutputCollector;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichBolt;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Fields;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Tuple;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Values;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;package:com.sonly.storm.demo1&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;project(项目):stormstudy&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;class(类)$&#123;CLASS_NAME&#125;&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;creat date(创建时间):2019-05-09 21:19&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;author(作者):&lt;/b&gt;xxydliuyss&lt;/br&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;note(备注)):&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * If you want to change the file header,please modify zhe File and Code Templates.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HellowordBolt</span> <span class="keyword">extends</span> <span class="title">BaseRichBolt</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(HellowordBolt.class);</span><br><span class="line">    <span class="keyword">private</span> TopologyContext context;</span><br><span class="line">    <span class="keyword">private</span> Map conf;</span><br><span class="line">    <span class="keyword">private</span> OutputCollector collector;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Integer&gt; counts = <span class="keyword">new</span> HashMap(<span class="number">16</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map map, TopologyContext topologyContext, OutputCollector outputCollector)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.conf=map;</span><br><span class="line">        <span class="keyword">this</span>.context = topologyContext;</span><br><span class="line">        <span class="keyword">this</span>.collector = outputCollector;</span><br><span class="line">        LOGGER.warn(<span class="string">"HellowordBolt-&gt;prepare:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple tuple)</span> </span>&#123;</span><br><span class="line">        LOGGER.warn(<span class="string">"HellowordBolt-&gt;execute:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId());</span><br><span class="line">        String word = tuple.getString(<span class="number">0</span>);</span><br><span class="line">        Integer count = counts.get(word);</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="keyword">null</span>)</span><br><span class="line">            count = <span class="number">0</span>;</span><br><span class="line">        count++;</span><br><span class="line">        counts.put(word, count);</span><br><span class="line">        collector.emit(<span class="keyword">new</span> Values(word, count));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</span><br><span class="line">        declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"word"</span>, <span class="string">"count"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sonly.storm.demo1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.OutputCollector;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichBolt;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Fields;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Tuple;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Values;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;package:com.sonly.storm.demo1&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;project(项目):stormstudy&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;class(类)$&#123;CLASS_NAME&#125;&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;creat date(创建时间):2019-05-09 21:29&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;author(作者):&lt;/b&gt;xxydliuyss&lt;/br&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;note(备注)):&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * If you want to change the file header,please modify zhe File and Code Templates.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SplitBolt</span> <span class="keyword">extends</span> <span class="title">BaseRichBolt</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(SplitBolt.class);</span><br><span class="line">    <span class="keyword">private</span> TopologyContext context;</span><br><span class="line">    <span class="keyword">private</span> Map conf;</span><br><span class="line">    <span class="keyword">private</span> OutputCollector collector;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map map, TopologyContext topologyContext, OutputCollector outputCollector)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.conf=map;</span><br><span class="line">        <span class="keyword">this</span>.context = topologyContext;</span><br><span class="line">        <span class="keyword">this</span>.collector = outputCollector;</span><br><span class="line">        LOGGER.warn(<span class="string">"SplitBolt-&gt;prepare:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple tuple)</span> </span>&#123;</span><br><span class="line">        String words = tuple.getStringByField(<span class="string">"sentence"</span>);</span><br><span class="line">        String[] contents = words.split(<span class="string">" +"</span>);</span><br><span class="line">        <span class="keyword">for</span> (String content : contents) &#123;</span><br><span class="line">            collector.emit(<span class="keyword">new</span> Values(content));</span><br><span class="line">            collector.ack(tuple);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.warn(<span class="string">"SplitBolt-&gt;execute:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</span><br><span class="line">        declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"word"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>local模式启动运行<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557417096146.png" alt="enter description here"></p><p>在pom文件中添加打包插件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">    &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;</span><br><span class="line">    &lt;configuration&gt;</span><br><span class="line">        &lt;descriptorRefs&gt;</span><br><span class="line">            &lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;</span><br><span class="line">        &lt;/descriptorRefs&gt;</span><br><span class="line">        &lt;archive&gt;</span><br><span class="line">            &lt;manifest&gt;</span><br><span class="line">                &lt;mainClass&gt;com.sonly.storm.demo1.HelloToplogy&lt;/mainClass&gt;</span><br><span class="line">            &lt;/manifest&gt;</span><br><span class="line">        &lt;/archive&gt;</span><br><span class="line">    &lt;/configuration&gt;</span><br><span class="line">    &lt;executions&gt;</span><br><span class="line">        &lt;execution&gt;</span><br><span class="line">            &lt;id&gt;make-assembly&lt;/id&gt;</span><br><span class="line">            &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">            &lt;goals&gt;</span><br><span class="line">                &lt;goal&gt;single&lt;/goal&gt;</span><br><span class="line">            &lt;/goals&gt;</span><br><span class="line">        &lt;/execution&gt;</span><br><span class="line">    &lt;/executions&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure><p>同时修改dependency 的scope为provide<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;scope&gt;provide&lt;/scope&gt;</span><br></pre></td></tr></table></figure><p></p><p>原因是服务器上storm相关包都已经存在了，防止重复打包导致冲突。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//Topology Name</span><br><span class="line">//component prefix</span><br><span class="line">//workers</span><br><span class="line">//spout executor (parallelism_hint)</span><br><span class="line">//spout task size</span><br><span class="line">//bolt executor (parallelism_hint)</span><br><span class="line">//bolt task size</span><br></pre></td></tr></table></figure><p></p><h2 id="在storm集群提交拓扑"><a href="#在storm集群提交拓扑" class="headerlink" title="在storm集群提交拓扑"></a>在storm集群提交拓扑</h2><h3 id="修改日志级别"><a href="#修改日志级别" class="headerlink" title="修改日志级别"></a>修改日志级别</h3><p>修改worker的工作进程的日志级别，修改成只输出warn日志，避免其他日志对我的干扰。进入${your_storm_path}/log4j2/目录修改worker.xml文件。先把worker.xml备份把Info级别改成warn<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cp worker.xml worker.xml.bak</span><br></pre></td></tr></table></figure><p></p><p>修改成：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;loggers&gt;</span><br><span class="line">    &lt;root level=&quot;warn&quot;&gt; &lt;!-- We log everything --&gt;</span><br><span class="line">        &lt;appender-ref ref=&quot;A1&quot;/&gt;</span><br><span class="line">        &lt;appender-ref ref=&quot;syslog&quot;/&gt;</span><br><span class="line">    &lt;/root&gt;</span><br><span class="line">    &lt;Logger name=&quot;org.apache.storm.metric.LoggingMetricsConsumer&quot; level=&quot;info&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">        &lt;appender-ref ref=&quot;METRICS&quot;/&gt;</span><br><span class="line">    &lt;/Logger&gt;</span><br><span class="line">    &lt;Logger name=&quot;STDERR&quot; level=&quot;INFO&quot;&gt;</span><br><span class="line">        &lt;appender-ref ref=&quot;STDERR&quot;/&gt;</span><br><span class="line">        &lt;appender-ref ref=&quot;syslog&quot;/&gt;</span><br><span class="line">    &lt;/Logger&gt;</span><br><span class="line">    &lt;Logger name=&quot;STDOUT&quot; level=&quot;INFO&quot;&gt;</span><br><span class="line">        &lt;appender-ref ref=&quot;STDOUT&quot;/&gt;</span><br><span class="line">        &lt;appender-ref ref=&quot;syslog&quot;/&gt;</span><br><span class="line">    &lt;/Logger&gt;</span><br><span class="line">&lt;/loggers&gt;</span><br></pre></td></tr></table></figure><p></p><p>同步到另外两台supervisor的工作节点服务器。<br>为了跟清晰的理解并发度，我会通过这个demo 拓扑，修改参数观察stormUI的exector数量和tasks数量。</p><h3 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// topologyName=&apos;count&apos; ## Topology Name 拓扑的名字</span><br><span class="line">// prefix=&apos;tp1&apos; ## component prefix 即为每个spout，bolt的前缀名称</span><br><span class="line">// workers=1  ## worker number 即为工作进程jvm数量</span><br><span class="line">// spoutParallelismHint=2  ## spout executor (parallelism_hint) 即spout的线程数量</span><br><span class="line">// spoutTaskSize=1 ## spout task size 即spout的运行实例数</span><br><span class="line">// boltParallelismHint=2  ## bolt executor (parallelism_hint) 即bolt的线程数量</span><br><span class="line">// boltTaskSize=1  ##bolt task size 即bolt的运行实例数</span><br></pre></td></tr></table></figure><h2 id="根据样例分析理解storm的并发度"><a href="#根据样例分析理解storm的并发度" class="headerlink" title="根据样例分析理解storm的并发度"></a>根据样例分析理解storm的并发度</h2><h3 id="例子1"><a href="#例子1" class="headerlink" title="例子1"></a>例子1</h3><p>执行：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">storm jar storm-demo1.jar com.sonly.storm.demo1.HelloToplogy tp1 tp1 1 2 0 2 0</span><br></pre></td></tr></table></figure><p>参数详情：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;topologyName=&apos;tp1&apos;, prefix=&apos;tp1&apos;, workers=1, spoutParallelismHint=2, spoutTaskSize=0, boltParallelismHint=2, boltTaskSize=0&#125;</span><br></pre></td></tr></table></figure><p>这时候task都被设置成0了。如下图：excutors为1，task为1。<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557487851467.png" alt="tp1"><br>接着往下看：此时我们的bolt的task都被设置0了，所以我们是没有创建spout，bolt的，但是你会发现一个_acker的bolt，这是storm的acker机制，storm自己给我们创建的bolt，并且每一个worker都会必须有一个_acker的bolt，如果我们没有取消ack机制的话。所以worker上只用了一个excutor来跑这个_acker的bolt。<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557488029568.png" alt="tp1组件图"></p><h3 id="例子2"><a href="#例子2" class="headerlink" title="例子2"></a>例子2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">storm jar storm-demo1.jar com.sonly.storm.demo1.HelloToplogy tp2 tp2 1 2 1 2 1</span><br></pre></td></tr></table></figure><p>参数详情：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;topologyName=&apos;tp2&apos;, prefix=&apos;tp2&apos;, workers=1, spoutParallelismHint=2, spoutTaskSize=1, boltParallelismHint=2, boltTaskSize=1&#125;</span><br></pre></td></tr></table></figure><p>此时 task的值都被设置成1了。如下图：excutors为4，task为4。<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557488644015.png" alt="tp2"><br>接着看一下spout，bolt 以及组件的分布情况见下图：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557488808341.png" alt="tp2组件"><br>此时已经我们的有tp2-spout 一个spout，除了系统的acker 还有我们自己创建的两个bolt。因为只有一个worker所以全部分布在一个worker里面。<br>尽管我们设置了spout的线程数为2，bolt的线程数为2，但是task都被设置成1，只有一个任务需要被两个excutor执行，所以有一个线程实际上是没有任务执行的。所以线程数，就是这几个task的值的和，<br>一个spout，两个自己的创建的bolt以及acker的task数量的和。</p><h3 id="例子3"><a href="#例子3" class="headerlink" title="例子3"></a>例子3</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">storm jar storm-demo1.jar com.sonly.storm.demo1.HelloToplogy tp3 tp3 2 2 1 2 1</span><br></pre></td></tr></table></figure><p>参数详情：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;topologyName=&apos;tp3&apos;, prefix=&apos;tp3&apos;, workers=2, spoutParallelismHint=2, spoutTaskSize=1, boltParallelismHint=2, boltTaskSize=1&#125;</span><br></pre></td></tr></table></figure><p>此时worker已经被设置成2了，如下图：executor为5，task为5.<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557491206007.png" alt="tp3"><br>接着看一下spout，bolt以及组件的分布情况如下图：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557491303432.png" alt="tp3组件"></p><p>此时，task任务数依然是1，spout和bolt都是1份，acker每个worker都必须有一份的，所以，executor的数就是task实例数也就是：一个spout 两个系统acker bolt，和两个我们自己的bolt。也就是5.这个5个task不均匀的分配到了两个worker进程上。</p><h3 id="例子4"><a href="#例子4" class="headerlink" title="例子4"></a>例子4</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">storm jar storm-demo1.jar com.sonly.storm.demo1.HelloToplogy tp4 tp4 2 2 2 2 2</span><br></pre></td></tr></table></figure><p>参数详情：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;topologyName=&apos;tp4&apos;, prefix=&apos;tp4&apos;, workers=2, spoutParallelismHint=2, spoutTaskSize=2, boltParallelismHint=2, boltTaskSize=2&#125;</span><br></pre></td></tr></table></figure><p>此时参数已经taks 数量被设置成2了，如下图：executor为8，task为8.<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557491922132.png" alt="tp4"><br>再看一下spout，bolt的分布情况：如下图：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557492028989.png" alt="tp4组件图"><br>此时，我们task都被设置成了2，那spout实例和bolt的实例都是2，也就是2+2+2=6 这个是我们自己的创建的task，再加上acker两个task，所以task参数就是8.而这里设置时executor也是8个 被均分到两个worker上面。</p><h3 id="例子5"><a href="#例子5" class="headerlink" title="例子5"></a>例子5</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">storm jar storm-demo1.jar com.sonly.storm.demo1.HelloToplogy tp5 tp5 2 2 4 2 4</span><br></pre></td></tr></table></figure><p>参数详情：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;topologyName=&apos;tp5&apos;, prefix=&apos;tp5&apos;, workers=2, spoutParallelismHint=2, spoutTaskSize=4, boltParallelismHint=2, boltTaskSize=4&#125;</span><br></pre></td></tr></table></figure><p>此时task设置成4，excutor设置成2，那这样的话，一个excutor会跑两个task ，executor=8,task=14 如下图：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557492553004.png" alt="tp5"><br>继续看一下spout和bolt的分布情况：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557492702803.png" alt="tp5组件图"><br>此时task设置成4，executor是2，那就是bolt和spout实例就是 4+4+4=12 再加上两个worker的Acker就是14个task。exector 是bolt的设置的值2+2+2=6个再加上两个acker的值，就是8个。同时，一个executor执行了两个task。8个executor平均分配到两个worker上面了。</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>exector和task的值，和拓扑结构有关系，拓扑中的spout 和bolt设置的parallelism_hint都会影响到exector和task的数量。task和exectuor之间的关系在设置上就已经确定了，最好exector和task之间，task 的数量最好设置成executor的倍数，这样每个executor执行的task才是一样的。<br>说到这里，相信大家对并发度，有了比较清晰的理解。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun May 12 2019 12:14:16 GMT+0800 (GMT+08:00) --&gt;&lt;h1 id=&quot;什么是storm的并发度&quot;&gt;&lt;a href=&quot;#什么是storm的并发度&quot; class=&quot;headerlink&quot; title=&quot;什么是
      
    
    </summary>
    
      <category term="storm" scheme="http://www.liuyong520.cn/categories/storm/"/>
    
    
      <category term="storm" scheme="http://www.liuyong520.cn/tags/storm/"/>
    
  </entry>
  
  <entry>
    <title>storm 基本知识</title>
    <link href="http://www.liuyong520.cn/2019/05/02/storm-base/"/>
    <id>http://www.liuyong520.cn/2019/05/02/storm-base/</id>
    <published>2019-05-02T14:00:40.000Z</published>
    <updated>2019-05-09T16:02:25.209Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --><h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>介绍storm之前，我先抛出这两个问题：</p><blockquote><p>1.实时计算需要解决些什么问题？<br>2.storm作为实时计算到底有何优势？</p></blockquote><h1 id="storm简介"><a href="#storm简介" class="headerlink" title="storm简介"></a>storm简介</h1><p>官方介绍：</p><blockquote><p>Apache Storm is a free and open source distributed realtime computation system. Storm makes it easy to reliably process unbounded streams of data, doing for realtime processing what Hadoop did for batch processing. Storm is simple, can be used with any programming language, and is a lot of fun to use!<br>翻译：<br>Apache Storm是一个免费的开源分布式实时计算系统。Storm可以轻松可靠地处理无限数据流，实时处理Hadoop为批处理所做的工作。storm很简单，可以与任何编程语言一起使用，并且使用起来很有趣！</p></blockquote><p>简单的说就是：storm是一个分布式实时计算系统。<br>1.实时计算需要解决些什么问题？<br>伴随着信息科技的日新月异的发展，信息呈现出爆发式的膨胀，人们获取信息的渠道也更加多元化，获取信息的方式也更加便捷，对信息的实效性也越来越高，举个电商系统一个搜索的简单例子，当卖家发布一条宝贝信息时，买家在搜索的时候需要能够马上呈现出来，同时买家购买后，能够需要统计该商品的卖出的数量以及该商品总营业额，利润等等。而且可以根据最近的购买的记录，可以给用户推荐同类型的产品。诸如此类的都需要以大数据为基础的，通过离线或者实时计算，获取相关的信息，从而获得商机。</p><p>在Storm之前，进行实时处理是非常痛苦的事情: 需要维护一堆消息队列和消费者，他们构成了非常复杂的图结构。消费者进程从队列里取消息，处理完成后，去更新数据库，或者给其他队列发新消息。</p><p>这样进行实时处理是非常痛苦的。我们主要的时间都花在关注往哪里发消息，从哪里接收消息，消息如何序列化，真正的业务逻辑只占了源代码的一小部分。一个应用程序的逻辑运行在很多worker上，但这些worker需要各自单独部署，还需要部署消息队列。最大问题是系统很脆弱，而且不是容错的：需要自己保证消息队列和worker进程工作正常。<br>例如上面的例子，简单的统计数量，统计营业额，计算毛利润，根据购买记录，推荐相似商品等等，就是通过，开启多个工作线程，实时去扫表，或者是从消息对列中拿出数据，计算统计值，写入对应的表。<br>这种定时任务，往往数据处理也不够及时，实效性比较差。</p><p>2.实时计算系统要考虑哪些问题？</p><ul><li>低延迟 处理消息一定要及时，延迟高就不叫实时了。</li><li>高性能 性能不高，那么就要浪费机器，这样浪费机器就是浪费资源</li><li>分布式 系统数据和来源可能有多个，处理数据结果也有可能作为基础数据给其他系统。如果你的系统应用单机就能搞定，那么不需要考虑这么复杂了，实时计算系统就是为了解决这种单机系统无法解决的问题的。</li><li>可扩展 伴随业务的的发展，我们的业务量，及计算量可能会越来越大，系统是要求可以扩展的，</li><li>容错性 这个是分布式系统的通用问题了，一个节点挂了，不能影响到整个系统。<br>3.storm的优势</li><li>简单的编程模型。类似于MapReduce降低了批处理的复杂性，storm降低了进行实时处理的复杂性</li><li>服务化，一个服务框架，支持热部署，即时上线或者下线app</li><li>支持多种语言，你可以在storm之上使用各种编程语言，默认支持的有clojure,java,ruby,python</li><li>容错性，storm会管理工作进程和节点故障</li><li>水平扩展性，计算是在多个系统、进程、服务器之间进行的。可以水平扩展机器，进程，或者线程等。</li><li>可靠的消息处理 storm 能够保证消息至少能够得到一次完整的消息处理。任务失败时，它会负责从消息源头重新处理。</li><li>快速 系统的设计保证消息的快速处理，低版本的storm使用的zeroMQ作为内部消息系统。高版本中使用netty完全替代了ZeroMQ作为内部消息系统</li><li>本地模式 storm 又一个本地模式，能够模拟集群，使我们的开发测试变得更加简单。<h1 id="storm的基本概念"><a href="#storm的基本概念" class="headerlink" title="storm的基本概念"></a>storm的基本概念</h1></li></ul><ol><li><p>拓扑(Topologies)<br>实时应用程序的逻辑被打包到Storm拓扑中。Storm拓扑类似于MapReduce作业。一个关键的区别是MapReduce作业最终完成，而拓扑结构永远运行（当然，直到你杀死它）。个拓扑是一个通过流分组(stream grouping)把Spout和Bolt连接到一起的拓扑结构。图的每条边代表一个Bolt订阅了其他Spout或者Bolt的输出流。一个拓扑就是一个复杂的多阶段的流计算。</p></li><li><p>元组(Tuple)<br>元组是Storm提供的一个轻量级的数据格式，可以用来包装你需要实际处理的数据。元组是一次消息传递的基本单元。一个元组是一个命名的值列表，其中的每个值都可以是任意类型的。元组是动态地进行类型转化的–字段的类型不需要事先声明。在Storm中编程时，就是在操作和转换由元组组成的流。通常，元组包含整数，字节，字符串，浮点数，布尔值和字节数组等类型。要想在元组中使用自定义类型，就需要实现自己的序列化方式。</p></li><li><p>流(Streams)<br>流是Storm中的核心抽象。一个流由无限的元组序列组成，这些元组会被分布式并行地创建和处理。通过流中元组包含的字段名称来定义这个流。<br>每个流声明时都被赋予了一个ID。只有一个流的Spout和Bolt非常常见，所以OutputFieldsDeclarer提供了不需要指定ID来声明一个流的函数(Spout和Bolt都需要声明输出的流)。这种情况下，流的ID是默认的“default”。</p></li><li><p>Spouts(喷嘴)<br>Spout(喷嘴，这个名字很形象)是Storm中流的来源。通常Spout从外部数据源，如消息队列中读取元组数据并吐到拓扑里。Spout可以是可靠的(reliable)或者不可靠(unreliable)的。可靠的Spout能够在一个元组被Storm处理失败时重新进行处理，而非可靠的Spout只是吐数据到拓扑里，不关心处理成功还是失败了。</p></li></ol><p>Spout可以一次给多个流吐数据。此时需要通过OutputFieldsDeclarer的declareStream函数来声明多个流并在调用SpoutOutputCollector提供的emit方法时指定元组吐给哪个流。</p><p>Spout中最主要的函数是nextTuple，Storm框架会不断调用它去做元组的轮询。如果没有新的元组过来，就直接返回，否则把新元组吐到拓扑里。nextTuple必须是非阻塞的，因为Storm在同一个线程里执行Spout的函数。</p><p>Spout中另外两个主要的函数是ack和fail。当Storm检测到一个从Spout吐出的元组在拓扑中成功处理完时调用ack,没有成功处理完时调用fail。只有可靠型的Spout会调用ack和fail函数。</p><ol start="5"><li>Bolts<br>在拓扑中所有的计算逻辑都是在Bolt中实现的。一个Bolt可以处理任意数量的输入流，产生任意数量新的输出流。Bolt可以做函数处理，过滤，流的合并，聚合，存储到数据库等操作。Bolt就是流水线上的一个处理单元，把数据的计算处理过程合理的拆分到多个Bolt、合理设置Bolt的task数量，能够提高Bolt的处理能力，提升流水线的并发度。</li></ol><p>Bolt可以给多个流吐出元组数据。此时需要使用OutputFieldsDeclarer的declareStream方法来声明多个流并在使用<a href="https://storm.apache.org/javadoc/apidocs/backtype/storm/task/OutputCollector.html" target="_blank" rel="noopener">OutputColletor</a>的emit方法时指定给哪个流吐数据。</p><p>当你声明了一个Bolt的输入流，也就订阅了另外一个组件的某个特定的输出流。如果希望订阅另一个组件的所有流，需要单独挨个订阅。InputDeclarer有语法糖来订阅ID为默认值的流。例如declarer.shuffleGrouping(“redBolt”)订阅了redBolt组件上的默认流，跟declarer.shuffleGrouping(“redBolt”, DEFAULT_STREAM_ID)是相同的。</p><p>在Bolt中最主要的函数是execute函数，它使用一个新的元组当作输入。Bolt使用OutputCollector对象来吐出新的元组。Bolts必须为处理的每个元组调用OutputCollector的ack方法以便于Storm知道元组什么时候被各个Bolt处理完了（最终就可以确认Spout吐出的某个元组处理完了）。通常处理一个输入的元组时，会基于这个元组吐出零个或者多个元组，然后确认(ack)输入的元组处理完了，Storm提供了IBasicBolt接口来自动完成确认。</p><p>必须注意OutputCollector不是线程安全的，所以所有的吐数据(emit)、确认(ack)、通知失败(fail)必须发生在同一个线程里</p><ol start="6"><li><p>任务(Tasks)<br>每个Spout和Bolt会以多个任务(Task)的形式在集群上运行。每个任务对应一个执行线程，流分组定义了如何从一组任务(同一个Bolt)发送元组到另外一组任务(另外一个Bolt)上。可以在调用TopologyBuilder的setSpout和setBolt函数时设置每个Spout和Bolt的并发数。</p></li><li><p>组件(Component)<br>组件(component)是对Bolt和Spout的统称</p></li><li><p>流分组(Stream groupings)<br>定义拓扑的时候，一部分工作是指定每个Bolt应该消费哪些流。流分组定义了一个流在一个消费它的Bolt内的多个任务(task)之间如何分组。流分组跟计算机网络中的路由功能是类似的，决定了每个元组在拓扑中的处理路线。</p></li></ol><p>在Storm中有七个内置的流分组策略，你也可以通过实现CustomStreamGrouping接口来自定义一个流分组策略:</p><ul><li>洗牌分组(Shuffle grouping): 随机分配元组到Bolt的某个任务上，这样保证同一个Bolt的每个任务都能够得到相同数量的元组。</li><li>字段分组(Fields grouping): 按照指定的分组字段来进行流的分组。例如，流是用字段“user-id”来分组的，那有着相同“user-id”的元组就会分到同一个任务里，但是有不同“user-id”的元组就会分到不同的任务里。这是一种非常重要的分组方式，通过这种流分组方式，我们就可以做到让Storm产出的消息在这个”user-id”级别是严格有序的，这对一些对时序敏感的应用(例如，计费系统)是非常重要的。</li><li>Partial Key grouping: 跟字段分组一样，流也是用指定的分组字段进行分组的，但是在多个下游Bolt之间是有负载均衡的，这样当输入数据有倾斜时可以更好的利用资源。这篇论文很好的解释了这是如何工作的，有哪些优势。</li><li>All grouping: 流会复制给Bolt的所有任务。小心使用这种分组方式。在拓扑中，如果希望某类元祖发送到所有的下游消费者，就可以使用这种All grouping的流分组策略。</li><li>Global grouping: 整个流会分配给Bolt的一个任务。具体一点，会分配给有最小ID的任务。<br>不分组(None grouping): 说明不关心流是如何分组的。目前，None grouping等价于洗牌分组。</li><li>Direct grouping：一种特殊的分组。对于这样分组的流，元组的生产者决定消费者的哪个任务会接收处理这个元组。只能在声明做直连的流(direct streams)上声明Direct groupings分组方式。只能通过使用emitDirect系列函数来吐元组给直连流。一个Bolt可以通过提供的TopologyContext来获得消费者的任务ID，也可以通过OutputCollector对象的emit函数(会返回元组被发送到的任务的ID)来跟踪消费者的任务ID。在ack的实现中，Spout有两个直连输入流，ack和ackFail，使用了这种直连分组的方式。</li><li>Local or shuffle grouping：如果目标Bolt在同一个worker进程里有一个或多个任务，元组就会通过洗牌的方式分配到这些同一个进程内的任务里。否则，就跟普通的洗牌分组一样。这种方式的好处是可以提高拓扑的处理效率，因为worker内部通信就是进程内部通信了，相比拓扑间的进程间通信要高效的多。worker进程间通信是通过使用Netty来进行网络通信的。</li></ul><ol start="9"><li>可靠性(Reliability)<br>Storm保证了拓扑中Spout产生的每个元组都会被处理。Storm是通过跟踪每个Spout所产生的所有元组构成的树形结构并得知这棵树何时被完整地处理来达到可靠性。每个拓扑对这些树形结构都有一个关联的“消息超时”。如果在这个超时时间里Storm检测到Spout产生的一个元组没有被成功处理完，那Sput的这个元组就处理失败了，后续会重新处理一遍。</li></ol><p>为了发挥Storm的可靠性，需要你在创建一个元组树中的一条边时告诉Storm，也需要在处理完每个元组之后告诉Storm。这些都是通过Bolt吐元组数据用的OutputCollector对象来完成的。标记是在emit函数里完成，完成一个元组后需要使用ack函数来告诉Storm。</p><ol start="10"><li>Workers(工作进程)<br>拓扑以一个或多个Worker进程的方式运行。每个Worker进程是一个物理的Java虚拟机，执行拓扑的一部分任务。例如，如果拓扑的并发设置成了300，分配了50个Worker，那么每个Worker执行6个任务(作为Worker内部的线程）。Storm会尽量把所有的任务均分到所有的Worker上。</li></ol><h1 id="storm的工作流程"><a href="#storm的工作流程" class="headerlink" title="storm的工作流程"></a>storm的工作流程</h1><p>Storm实现了一个数据流(data flow)的模型，在这个模型中数据持续不断地流经一个由很多转换实体构成的网络。一个数据流的抽象叫做流(stream)，流是无限的元组(Tuple)序列。元组就像一个可以表示标准数据类型（例如int，float和byte数组）和用户自定义类型（需要额外序列化代码的）的数据结构。每个流由一个唯一的ID来标示的，这个ID可以用来构建拓扑中各个组件的数据源。</p><p>如下图所示，其中的水龙头代表了数据流的来源，一旦水龙头打开，数据就会源源不断地流经Bolt而被处理。图中有三个流，用不同的颜色来表示，每个数据流中流动的是元组(Tuple)，它承载了具体的数据。元组通过流经不同的转换实体而被处理。</p><p>Storm对数据输入的来源和输出数据的去向没有做任何限制。像Hadoop，是需要把数据放到自己的文件系统HDFS里的。在Storm里，可以使用任意来源的数据输入和任意的数据输出，只要你实现对应的代码来获取/写入这些数据就可以。典型场景下，输入/输出数据来是基于类似Kafka或者ActiveMQ这样的消息队列，但是数据库，文件系统或者web服务也都是可以的。<br>如图：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557330376448.png" alt="enter description here"></p><h1 id="storm-测试用例并运行"><a href="#storm-测试用例并运行" class="headerlink" title="storm 测试用例并运行"></a>storm 测试用例并运行</h1><p>往往我在学习这些开源框架的时候，查看官方文档和源码中的例子是入门上手比较快的一种方式。<br>这里我也是从官方文档和github上的代码入手的<br>1.clone 下来1.2.2的源码<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone --branch v1.2.2 https://github.com/apache/storm.git</span><br></pre></td></tr></table></figure><p></p><p>2.进入examples目录下有很多例子，如storm-starter这个项目。同时在github上进入这个例子的目录下有README.md文件，介绍如何运行我们的测试例子。我们可以先感官体验一下storm运行拓扑是怎样的。详情请看<a href="https://github.com/apache/storm/tree/master/examples/storm-starter" target="_blank" rel="noopener">storm-starter</a><br>step 1：用idea 打开storm源码 然后用maven打包或者进入storm-starter项目里面执行<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn package</span><br></pre></td></tr></table></figure><p></p><p>会在target目录里面生成一个start-storm-{version}.jar包上传到storm的服务器。<br>step 2: 提交运行实例拓扑，有本地和集群两种模式。是不是本地模式🉐️看代码如何实现的。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">storm jar stormlib/storm-starter-1.2.2.jar org.apache.storm.starter.ExclamationTopology  ##本地模式</span><br><span class="line">storm jar stormlib/storm-starter-1.2.2.jar org.apache.storm.starter.ExclamationTopology ExclamationTopology ## ExclamationTopology为Topology的名字</span><br></pre></td></tr></table></figure><p></p><p><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557397799999.png" alt="enter description here"><br>step 3: org.apache.storm.starter.ExclamationTopology 这个拓扑类如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Licensed to the Apache Software Foundation (ASF) under one</span></span><br><span class="line"><span class="comment"> * or more contributor license agreements.  See the NOTICE file</span></span><br><span class="line"><span class="comment"> * distributed with this work for additional information</span></span><br><span class="line"><span class="comment"> * regarding copyright ownership.  The ASF licenses this file</span></span><br><span class="line"><span class="comment"> * to you under the Apache License, Version 2.0 (the</span></span><br><span class="line"><span class="comment"> * "License"); you may not use this file except in compliance</span></span><br><span class="line"><span class="comment"> * with the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">package</span> org.apache.storm.starter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.storm.Config;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.LocalCluster;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.StormSubmitter;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.OutputCollector;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.testing.TestWordSpout;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.TopologyBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichBolt;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Fields;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Tuple;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Values;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.utils.Utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This is a basic example of a Storm topology.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExclamationTopology</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ExclamationBolt</span> <span class="keyword">extends</span> <span class="title">BaseRichBolt</span> </span>&#123;</span><br><span class="line">    OutputCollector _collector;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map conf, TopologyContext context, OutputCollector collector)</span> </span>&#123;</span><br><span class="line">      _collector = collector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple tuple)</span> </span>&#123;</span><br><span class="line">      _collector.emit(tuple, <span class="keyword">new</span> Values(tuple.getString(<span class="number">0</span>) + <span class="string">"!!!"</span>));</span><br><span class="line">      _collector.ack(tuple);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</span><br><span class="line">      declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"word"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//构建拓扑类</span></span><br><span class="line">    TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder(); </span><br><span class="line">    <span class="comment">//设置数据获取来源spout</span></span><br><span class="line">    builder.setSpout(<span class="string">"word"</span>, <span class="keyword">new</span> TestWordSpout(), <span class="number">10</span>);</span><br><span class="line">    <span class="comment">//设置数据处理bolt类按照word分组</span></span><br><span class="line">    builder.setBolt(<span class="string">"exclaim1"</span>, <span class="keyword">new</span> ExclamationBolt(), <span class="number">3</span>).shuffleGrouping(<span class="string">"word"</span>);</span><br><span class="line">    <span class="comment">//设置数据处理bolt类按照exclaim1分组</span></span><br><span class="line">    builder.setBolt(<span class="string">"exclaim2"</span>, <span class="keyword">new</span> ExclamationBolt(), <span class="number">2</span>).shuffleGrouping(<span class="string">"exclaim1"</span>);</span><br><span class="line">    <span class="comment">//设置配置参数，打开debug模式</span></span><br><span class="line">    Config conf = <span class="keyword">new</span> Config();</span><br><span class="line">    conf.setDebug(<span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// 根据传入参数创建对应拓扑，如果参数大于0，就提交到storm集群，集群模式运行</span></span><br><span class="line">    <span class="keyword">if</span> (args != <span class="keyword">null</span> &amp;&amp; args.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      conf.setNumWorkers(<span class="number">3</span>);</span><br><span class="line">      <span class="comment">//通过nimbus提交拓扑到suppervisisor工作节点运行</span></span><br><span class="line">      StormSubmitter.submitTopologyWithProgressBar(args[<span class="number">0</span>], conf, builder.createTopology());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; <span class="comment">//否则就是local本地模式运行，本地模式运行所有的日志都会打印到本地，可以用来调试</span></span><br><span class="line"></span><br><span class="line">      LocalCluster cluster = <span class="keyword">new</span> LocalCluster();</span><br><span class="line">      cluster.submitTopology(<span class="string">"test"</span>, conf, builder.createTopology());</span><br><span class="line">      Utils.sleep(<span class="number">10000</span>);</span><br><span class="line">      <span class="comment">//运行10秒后杀掉拓扑</span></span><br><span class="line">      cluster.killTopology(<span class="string">"test"</span>); </span><br><span class="line">      <span class="comment">//同时释放资源，关掉storm</span></span><br><span class="line">      cluster.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>org.apache.storm.testing.TestWordSpout;<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Licensed to the Apache Software Foundation (ASF) under one</span></span><br><span class="line"><span class="comment"> * or more contributor license agreements.  See the NOTICE file</span></span><br><span class="line"><span class="comment"> * distributed with this work for additional information</span></span><br><span class="line"><span class="comment"> * regarding copyright ownership.  The ASF licenses this file</span></span><br><span class="line"><span class="comment"> * to you under the Apache License, Version 2.0 (the</span></span><br><span class="line"><span class="comment"> * "License"); you may not use this file except in compliance</span></span><br><span class="line"><span class="comment"> * with the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">package</span> org.apache.storm.testing;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.storm.Config;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.spout.SpoutOutputCollector;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichSpout;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Fields;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Values;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.utils.Utils;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestWordSpout</span> <span class="keyword">extends</span> <span class="title">BaseRichSpout</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Logger LOG = LoggerFactory.getLogger(TestWordSpout.class);</span><br><span class="line">    <span class="keyword">boolean</span> _isDistributed;</span><br><span class="line">    SpoutOutputCollector _collector;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestWordSpout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestWordSpout</span><span class="params">(<span class="keyword">boolean</span> isDistributed)</span> </span>&#123;</span><br><span class="line">        _isDistributed = isDistributed;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Map conf, TopologyContext context, SpoutOutputCollector collector)</span> </span>&#123;</span><br><span class="line">        _collector = collector;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nextTuple</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Utils.sleep(<span class="number">100</span>);</span><br><span class="line">        <span class="keyword">final</span> String[] words = <span class="keyword">new</span> String[] &#123;<span class="string">"nathan"</span>, <span class="string">"mike"</span>, <span class="string">"jackson"</span>, <span class="string">"golda"</span>, <span class="string">"bertels"</span>&#125;;</span><br><span class="line">        <span class="keyword">final</span> Random rand = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">final</span> String word = words[rand.nextInt(words.length)];</span><br><span class="line">        <span class="comment">//随机从这些字符串中获取数据</span></span><br><span class="line">        _collector.emit(<span class="keyword">new</span> Values(word));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ack</span><span class="params">(Object msgId)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fail</span><span class="params">(Object msgId)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</span><br><span class="line">        declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"word"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getComponentConfiguration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!_isDistributed) &#123;</span><br><span class="line">            Map&lt;String, Object&gt; ret = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">            ret.put(Config.TOPOLOGY_MAX_TASK_PARALLELISM, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h1 id="storm-API-简单介绍"><a href="#storm-API-简单介绍" class="headerlink" title="storm API 简单介绍"></a>storm API 简单介绍</h1><p>1.拓扑构建<br>TopologyBuilder公开了Java API，用于指定要执行的Storm拓扑。拓扑结构最终是Thrift结构，但由于Thrift API非常冗长，TopologyBuilder极大地简化了创建拓扑的过程。用于创建和提交拓扑的模板类似于：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</span><br><span class="line">builder.setSpout(<span class="string">"1"</span>, <span class="keyword">new</span> TestWordSpout(<span class="keyword">true</span>), <span class="number">5</span>);</span><br><span class="line">builder.setSpout(<span class="string">"2"</span>, <span class="keyword">new</span> TestWordSpout(<span class="keyword">true</span>), <span class="number">3</span>);</span><br><span class="line">builder.setBolt(<span class="string">"3"</span>, <span class="keyword">new</span> TestWordCounter(), <span class="number">3</span>)</span><br><span class="line">         .fieldsGrouping(<span class="string">"1"</span>, <span class="keyword">new</span> Fields(<span class="string">"word"</span>))</span><br><span class="line">         .fieldsGrouping(<span class="string">"2"</span>, <span class="keyword">new</span> Fields(<span class="string">"word"</span>));</span><br><span class="line">builder.setBolt(<span class="string">"4"</span>, <span class="keyword">new</span> TestGlobalCount())</span><br><span class="line">         .globalGrouping(<span class="string">"1"</span>);</span><br><span class="line"></span><br><span class="line">Map conf = <span class="keyword">new</span> HashMap();</span><br><span class="line">conf.put(Config.TOPOLOGY_WORKERS, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">StormSubmitter.submitTopology(<span class="string">"mytopology"</span>, conf, builder.createTopology());</span><br></pre></td></tr></table></figure><p>在本地模式（正在处理）中运行完全相同的拓扑，并将其配置为记录所有发出的元组，如下所示。请注意，在关闭本地群集之前，它允许拓扑运行10秒。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</span><br><span class="line"></span><br><span class="line">builder.setSpout(<span class="string">"1"</span>, <span class="keyword">new</span> TestWordSpout(<span class="keyword">true</span>), <span class="number">5</span>);</span><br><span class="line">builder.setSpout(<span class="string">"2"</span>, <span class="keyword">new</span> TestWordSpout(<span class="keyword">true</span>), <span class="number">3</span>);</span><br><span class="line">builder.setBolt(<span class="string">"3"</span>, <span class="keyword">new</span> TestWordCounter(), <span class="number">3</span>)</span><br><span class="line">         .fieldsGrouping(<span class="string">"1"</span>, <span class="keyword">new</span> Fields(<span class="string">"word"</span>))</span><br><span class="line">         .fieldsGrouping(<span class="string">"2"</span>, <span class="keyword">new</span> Fields(<span class="string">"word"</span>));</span><br><span class="line">builder.setBolt(<span class="string">"4"</span>, <span class="keyword">new</span> TestGlobalCount())</span><br><span class="line">         .globalGrouping(<span class="string">"1"</span>);</span><br><span class="line"></span><br><span class="line">Map conf = <span class="keyword">new</span> HashMap();</span><br><span class="line">conf.put(Config.TOPOLOGY_WORKERS, <span class="number">4</span>);</span><br><span class="line">conf.put(Config.TOPOLOGY_DEBUG, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">LocalCluster cluster = <span class="keyword">new</span> LocalCluster();</span><br><span class="line">cluster.submitTopology(<span class="string">"mytopology"</span>, conf, builder.createTopology());</span><br><span class="line">Utils.sleep(<span class="number">10000</span>);</span><br><span class="line">cluster.shutdown();</span><br></pre></td></tr></table></figure><p>模式TopologyBuilder是使用setSpout和setBolt方法将组件ID映射到组件。这些方法返回的对象随后用于声明该组件的输入。<br>详情可以查看<a href="http://storm.apache.org/releases/1.2.2/javadocs/org/apache/storm/topology/TopologyBuilder.html" target="_blank" rel="noopener">TopologyBuilder</a><br>2.创建spout相关<br>ISpout接口：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public interface ISpout extends Serializable &#123;</span><br><span class="line">    //初始化方法</span><br><span class="line">    void open(Map conf, TopologyContext context, SpoutOutputCollector collector);</span><br><span class="line">    //关闭</span><br><span class="line">    void close();</span><br><span class="line">    //遍历元组的方法，会一直执行这个方法</span><br><span class="line">    void nextTuple();</span><br><span class="line">    //成功时调用的确认方法</span><br><span class="line">    void ack(Object msgId);</span><br><span class="line">    //失败时调用的失败方法</span><br><span class="line">    void fail(Object msgId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>storm已经给我们提供的很多的spout接口和实现类，我们只需要实现或者对应的实现类就能和其他技术集成在一起。基本的spout，我们可以实现IRichSpout或者继承BasicRichSpout<br>完成spout的创建。<br>3.创建Bolt类<br>storm已经给我们提供的很多的Bolt接口和实现类，我们只需要实现或者对应的实现类就能和其他技术集成在一起。基本的spout，我们可以实现IRichBolt或者继承BasicRichBolt<br>如<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* BaseRichBolt 是一个不需要实现的ACK确认方法和fail（）失败方法</span></span><br><span class="line"><span class="comment">* </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleBolt</span> <span class="keyword">extends</span> <span class="title">BaseRichBolt</span> </span>&#123;</span><br><span class="line">    OutputCollector _collector;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map conf, TopologyContext context, OutputCollector collector)</span> </span>&#123;</span><br><span class="line">      _collector = collector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple tuple)</span> </span>&#123;</span><br><span class="line">      _collector.emit(tuple, <span class="keyword">new</span> Values(tuple.getString(<span class="number">0</span>) + <span class="string">"!!!"</span>));</span><br><span class="line">      _collector.ack(tuple);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</span><br><span class="line">      declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"word"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p></p><p>Storm使用入门起来是非常简单的。<br>下面我将简单的自己实现一个拓扑<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sonly.storm.demo1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.storm.Config;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.LocalCluster;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.StormSubmitter;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.generated.AlreadyAliveException;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.generated.AuthorizationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.generated.InvalidTopologyException;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.TopologyBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Fields;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;package:com.sonly.storm.demo1&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;project(项目):stormstudy&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;class(类)HelloToplogy&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;creat date(创建时间):2019-05-09 21:55&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;author(作者):&lt;/b&gt;xxydliuyss&lt;/br&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;note(备注)):&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * If you want to change the file header,please modify zhe File and Code Templates.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloToplogy</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(HelloToplogy.class);</span><br><span class="line">    <span class="comment">//Topology Name</span></span><br><span class="line">    <span class="comment">//component prefix</span></span><br><span class="line">    <span class="comment">//workers</span></span><br><span class="line">    <span class="comment">//spout executor (parallelism_hint)</span></span><br><span class="line">    <span class="comment">//spout task size</span></span><br><span class="line">    <span class="comment">//bolt executor (parallelism_hint)</span></span><br><span class="line">    <span class="comment">//bolt task size</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</span><br><span class="line">        Config conf = <span class="keyword">new</span> Config();</span><br><span class="line">        conf.setDebug(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (args==<span class="keyword">null</span> || args.length &lt; <span class="number">7</span>) &#123;</span><br><span class="line">            conf.setNumWorkers(<span class="number">3</span>);</span><br><span class="line">            builder.setSpout(<span class="string">"spout"</span>, <span class="keyword">new</span> HellowordSpout(), <span class="number">4</span>).setNumTasks(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">            builder.setBolt(<span class="string">"split-bolt"</span>, <span class="keyword">new</span> SplitBolt(),  <span class="number">4</span>).shuffleGrouping(<span class="string">"spout"</span>).setNumTasks(<span class="number">8</span>);</span><br><span class="line">            builder.setBolt(<span class="string">"count-bolt"</span>, <span class="keyword">new</span> HellowordBolt(), <span class="number">8</span>).fieldsGrouping(<span class="string">"split-bolt"</span>, <span class="keyword">new</span> Fields(<span class="string">"word"</span>)).setNumTasks(<span class="number">8</span>);</span><br><span class="line">            LocalCluster cluster = <span class="keyword">new</span> LocalCluster();</span><br><span class="line">            cluster.submitTopology(<span class="string">"word-count"</span>, conf, builder.createTopology());</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">            cluster.killTopology(<span class="string">"word-count"</span>);</span><br><span class="line">            cluster.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            Options options = Options.builder(args);</span><br><span class="line">            conf.setNumWorkers(options.getWorkers());</span><br><span class="line">            builder.setSpout(options.getPrefix()+<span class="string">"-spout"</span>, <span class="keyword">new</span> HellowordSpout(), options.getSpoutParallelismHint()).setNumTasks(options.getSpoutTaskSize());</span><br><span class="line"></span><br><span class="line">            builder.setBolt(options.getPrefix()+<span class="string">"-split-bolt"</span>, <span class="keyword">new</span> SplitBolt(),  options.getBoltParallelismHint()).shuffleGrouping(options.getPrefix()+<span class="string">"-spout"</span>).setNumTasks(options.getBoltTaskSize());</span><br><span class="line">            builder.setBolt(options.getPrefix()+<span class="string">"-count-bolt"</span>, <span class="keyword">new</span> HellowordBolt(), options.getBoltParallelismHint()).fieldsGrouping(options.getPrefix()+<span class="string">"-split-bolt"</span>, <span class="keyword">new</span> Fields(<span class="string">"word"</span>)).setNumTasks(options.getBoltTaskSize());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                StormSubmitter.submitTopologyWithProgressBar(options.getTopologyName(), conf, builder.createTopology());</span><br><span class="line">                LOGGER.warn(<span class="string">"==========================================================="</span>);</span><br><span class="line">                LOGGER.warn(<span class="string">"The Topology &#123;&#125; is Submited "</span>,options.getTopologyName());</span><br><span class="line">                LOGGER.warn(<span class="string">"==========================================================="</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (AlreadyAliveException | InvalidTopologyException | AuthorizationException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Options</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String topologyName;</span><br><span class="line">        <span class="keyword">private</span> String prefix;</span><br><span class="line">        <span class="keyword">private</span> Integer workers;</span><br><span class="line">        <span class="keyword">private</span> Integer spoutParallelismHint;</span><br><span class="line">        <span class="keyword">private</span> Integer spoutTaskSize;</span><br><span class="line">        <span class="keyword">private</span> Integer boltParallelismHint;</span><br><span class="line">        <span class="keyword">private</span> Integer boltTaskSize;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Options</span><span class="params">(String topologyName, String prefix, Integer workers, Integer spoutParallelismHint, Integer spoutTaskSize, Integer boltParallelismHint, Integer boltTaskSize)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.topologyName = topologyName;</span><br><span class="line">            <span class="keyword">this</span>.prefix = prefix;</span><br><span class="line">            <span class="keyword">this</span>.workers = workers;</span><br><span class="line">            <span class="keyword">this</span>.spoutParallelismHint = spoutParallelismHint;</span><br><span class="line">            <span class="keyword">this</span>.spoutTaskSize = spoutTaskSize;</span><br><span class="line">            <span class="keyword">this</span>.boltParallelismHint = boltParallelismHint;</span><br><span class="line">            <span class="keyword">this</span>.boltTaskSize = boltTaskSize;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Options <span class="title">builder</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Options(args[<span class="number">0</span>],args[<span class="number">1</span>],Integer.parseInt(args[<span class="number">2</span>])</span><br><span class="line">            ,Integer.parseInt(args[<span class="number">3</span>]),Integer.parseInt(args[<span class="number">4</span>]),Integer.parseInt(args[<span class="number">5</span>]),Integer.parseInt(args[<span class="number">6</span>])</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getTopologyName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> topologyName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTopologyName</span><span class="params">(String topologyName)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.topologyName = topologyName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getPrefix</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> prefix;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrefix</span><span class="params">(String prefix)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.prefix = prefix;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getWorkers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> workers;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWorkers</span><span class="params">(Integer workers)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.workers = workers;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getSpoutParallelismHint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> spoutParallelismHint;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSpoutParallelismHint</span><span class="params">(Integer spoutParallelismHint)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.spoutParallelismHint = spoutParallelismHint;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getSpoutTaskSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> spoutTaskSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSpoutTaskSize</span><span class="params">(Integer spoutTaskSize)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.spoutTaskSize = spoutTaskSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getBoltParallelismHint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> boltParallelismHint;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBoltParallelismHint</span><span class="params">(Integer boltParallelismHint)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.boltParallelismHint = boltParallelismHint;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getBoltTaskSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> boltTaskSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBoltTaskSize</span><span class="params">(Integer boltTaskSize)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.boltTaskSize = boltTaskSize;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>spout 类：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sonly.storm.demo1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.storm.spout.SpoutOutputCollector;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichSpout;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Fields;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Values;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Currency;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;package:com.sonly.storm.demo1&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;project(项目):stormstudy&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;class(类)$&#123;HellowordSpout&#125;&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;creat date(创建时间):2019-05-09 20:27&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;author(作者):&lt;/b&gt;xxydliuyss&lt;/br&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;note(备注)):&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * If you want to change the file header,please modify zhe File and Code Templates.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HellowordSpout</span> <span class="keyword">extends</span> <span class="title">BaseRichSpout</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(HellowordSpout.class);</span><br><span class="line">    <span class="comment">//拓扑上下文</span></span><br><span class="line">    <span class="keyword">private</span> TopologyContext context;</span><br><span class="line">    <span class="keyword">private</span> SpoutOutputCollector collector;</span><br><span class="line">    <span class="keyword">private</span> Map config;</span><br><span class="line">    <span class="keyword">private</span> Random random;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Map conf, TopologyContext topologyContext, SpoutOutputCollector collector)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.config = conf;</span><br><span class="line">        <span class="keyword">this</span>.context = topologyContext;</span><br><span class="line">        <span class="keyword">this</span>.collector = collector;</span><br><span class="line">        <span class="keyword">this</span>.random = <span class="keyword">new</span> Random();</span><br><span class="line">        LOGGER.warn(<span class="string">"HellowordSpout-&gt;open:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nextTuple</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String[] sentences = <span class="keyword">new</span> String[]&#123;<span class="string">"hello world !"</span>, <span class="string">"hello Storm !"</span>,</span><br><span class="line">                <span class="string">"hello apache flink !"</span>, <span class="string">"hello apache kafka stream !"</span>, <span class="string">"hello apache spark !"</span>&#125;;</span><br><span class="line">        <span class="keyword">final</span> String sentence = sentences[random.nextInt(sentences.length)];</span><br><span class="line">        collector.emit(<span class="keyword">new</span> Values(sentence));</span><br><span class="line">        LOGGER.warn(<span class="string">"HellowordSpout-&gt;nextTuple:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;,Values:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId(),sentence);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</span><br><span class="line">        declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"sentence"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LOGGER.warn(<span class="string">"HellowordSpout-&gt;close:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId());</span><br><span class="line">        <span class="keyword">super</span>.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>实现两个bolt一个用来统计单词出现个数，一个用来拆分语句。<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sonly.storm.demo1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.OutputCollector;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichBolt;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Fields;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Tuple;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Values;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;package:com.sonly.storm.demo1&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;project(项目):stormstudy&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;class(类)$&#123;CLASS_NAME&#125;&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;creat date(创建时间):2019-05-09 21:19&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;author(作者):&lt;/b&gt;xxydliuyss&lt;/br&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;note(备注)):&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * If you want to change the file header,please modify zhe File and Code Templates.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HellowordBolt</span> <span class="keyword">extends</span> <span class="title">BaseRichBolt</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(HellowordBolt.class);</span><br><span class="line">    <span class="keyword">private</span> TopologyContext context;</span><br><span class="line">    <span class="keyword">private</span> Map conf;</span><br><span class="line">    <span class="keyword">private</span> OutputCollector collector;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Integer&gt; counts = <span class="keyword">new</span> HashMap(<span class="number">16</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map map, TopologyContext topologyContext, OutputCollector outputCollector)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.conf=map;</span><br><span class="line">        <span class="keyword">this</span>.context = topologyContext;</span><br><span class="line">        <span class="keyword">this</span>.collector = outputCollector;</span><br><span class="line">        LOGGER.warn(<span class="string">"HellowordBolt-&gt;prepare:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple tuple)</span> </span>&#123;</span><br><span class="line">        LOGGER.warn(<span class="string">"HellowordBolt-&gt;execute:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId());</span><br><span class="line">        String word = tuple.getString(<span class="number">0</span>);</span><br><span class="line">        Integer count = counts.get(word);</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="keyword">null</span>)</span><br><span class="line">            count = <span class="number">0</span>;</span><br><span class="line">        count++;</span><br><span class="line">        counts.put(word, count);</span><br><span class="line">        collector.emit(<span class="keyword">new</span> Values(word, count));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</span><br><span class="line">        declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"word"</span>, <span class="string">"count"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sonly.storm.demo1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.OutputCollector;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichBolt;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Fields;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Tuple;</span><br><span class="line"><span class="keyword">import</span> org.apache.storm.tuple.Values;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;package:com.sonly.storm.demo1&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;project(项目):stormstudy&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;class(类)$&#123;CLASS_NAME&#125;&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;creat date(创建时间):2019-05-09 21:29&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;author(作者):&lt;/b&gt;xxydliuyss&lt;/br&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;note(备注)):&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * If you want to change the file header,please modify zhe File and Code Templates.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SplitBolt</span> <span class="keyword">extends</span> <span class="title">BaseRichBolt</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(SplitBolt.class);</span><br><span class="line">    <span class="keyword">private</span> TopologyContext context;</span><br><span class="line">    <span class="keyword">private</span> Map conf;</span><br><span class="line">    <span class="keyword">private</span> OutputCollector collector;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map map, TopologyContext topologyContext, OutputCollector outputCollector)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.conf=map;</span><br><span class="line">        <span class="keyword">this</span>.context = topologyContext;</span><br><span class="line">        <span class="keyword">this</span>.collector = outputCollector;</span><br><span class="line">        LOGGER.warn(<span class="string">"SplitBolt-&gt;prepare:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple tuple)</span> </span>&#123;</span><br><span class="line">        String words = tuple.getStringByField(<span class="string">"sentence"</span>);</span><br><span class="line">        String[] contents = words.split(<span class="string">" +"</span>);</span><br><span class="line">        <span class="keyword">for</span> (String content : contents) &#123;</span><br><span class="line">            collector.emit(<span class="keyword">new</span> Values(content));</span><br><span class="line">            collector.ack(tuple);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.warn(<span class="string">"SplitBolt-&gt;execute:hashcode:&#123;&#125;-&gt;ThreadId:&#123;&#125;,TaskId:&#123;&#125;"</span>,<span class="keyword">this</span>.hashCode(),Thread.currentThread().getId(),context.getThisTaskId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</span><br><span class="line">        declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"word"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>local模式启动运行<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1557417096146.png" alt="enter description here"></p><p>在pom文件中添加打包插件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">    &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;</span><br><span class="line">    &lt;configuration&gt;</span><br><span class="line">        &lt;descriptorRefs&gt;</span><br><span class="line">            &lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;</span><br><span class="line">        &lt;/descriptorRefs&gt;</span><br><span class="line">        &lt;archive&gt;</span><br><span class="line">            &lt;manifest&gt;</span><br><span class="line">                &lt;mainClass&gt;com.sonly.storm.demo1.HelloToplogy&lt;/mainClass&gt;</span><br><span class="line">            &lt;/manifest&gt;</span><br><span class="line">        &lt;/archive&gt;</span><br><span class="line">    &lt;/configuration&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure><p>同时修改dependency 的scope为provide<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;scope&gt;provide&lt;/scope&gt;</span><br></pre></td></tr></table></figure><p></p><p>原因是服务器上storm相关包都已经存在了，防止重复打包导致冲突。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//Topology Name</span><br><span class="line">//component prefix</span><br><span class="line">//workers</span><br><span class="line">//spout executor (parallelism_hint)</span><br><span class="line">//spout task size</span><br><span class="line">//bolt executor (parallelism_hint)</span><br><span class="line">//bolt task size</span><br></pre></td></tr></table></figure><p></p><p>打包上传后，storm jar jarName arg0 arg1 arg2 args3 …<br>后面跟参数运行即可。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --&gt;&lt;h1 id=&quot;引言&quot;&gt;&lt;a href=&quot;#引言&quot; class=&quot;headerlink&quot; title=&quot;引言&quot;&gt;&lt;/a&gt;引言&lt;/h1&gt;&lt;p&gt;介绍sto
      
    
    </summary>
    
      <category term="storm" scheme="http://www.liuyong520.cn/categories/storm/"/>
    
    
      <category term="storm" scheme="http://www.liuyong520.cn/tags/storm/"/>
    
  </entry>
  
  <entry>
    <title>storm 安装使用</title>
    <link href="http://www.liuyong520.cn/2019/05/02/storm-install/"/>
    <id>http://www.liuyong520.cn/2019/05/02/storm-install/</id>
    <published>2019-05-02T13:37:40.000Z</published>
    <updated>2019-05-08T09:39:18.278Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="zookeeper集群环境"><a href="#zookeeper集群环境" class="headerlink" title="zookeeper集群环境"></a>zookeeper集群环境</h2><p>storm是依赖于zookeeper注册中心的一款分布式消息对列，所以需要有zookeeper单机或者集群环境。</p><h2 id="准备三台服务器："><a href="#准备三台服务器：" class="headerlink" title="准备三台服务器："></a>准备三台服务器：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">172.16.18.198 k8s-n1</span><br><span class="line">172.16.18.199 k8s-n2</span><br><span class="line">172.16.18.200 k8s-n3</span><br></pre></td></tr></table></figure><h2 id="下载storm安装包"><a href="#下载storm安装包" class="headerlink" title="下载storm安装包"></a>下载storm安装包</h2><p><a href="http://storm.apache.org/downloads.html" target="_blank" rel="noopener">http://storm.apache.org/downloads.html</a> 中下载，目前最新版本的strom已经到1.2.2,我这里之前下载的是1.1.3版本的。</p><h1 id="安装storm集群"><a href="#安装storm集群" class="headerlink" title="安装storm集群"></a>安装storm集群</h1><h2 id="上传压缩包到三台服务器解压缩到-opt-目录下"><a href="#上传压缩包到三台服务器解压缩到-opt-目录下" class="headerlink" title="上传压缩包到三台服务器解压缩到/opt/目录下"></a>上传压缩包到三台服务器解压缩到/opt/目录下</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf apache-storm-1.1.3.tar.gz -C /opt</span><br><span class="line">ln -sf apache-storm-1.1.3/ storm</span><br></pre></td></tr></table></figure><h2 id="修改-conf目录下的storm-yml文件"><a href="#修改-conf目录下的storm-yml文件" class="headerlink" title="修改 conf目录下的storm.yml文件"></a>修改 conf目录下的storm.yml文件</h2><p>Storm包含一个conf/storm.yaml配置Storm守护进程的文件。这个文件里面配置的值会覆盖掉default.yml里面的值，同时里面有一些配置是必须填的<br><strong>注意：yml文件的前面的空格必须有，不然就会出问题，yml配置文件有严格的格式</strong><br>1)storm.zookeeper.servers：这是Storm集群的Zookeeper集群中的主机列表。它应该看起来像：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">storm.zookeeper.servers:</span><br><span class="line">  - &quot;k8s-n1&quot;</span><br><span class="line">  - &quot;k8s-n2</span><br><span class="line">  - &quot;k8s-n3&quot;</span><br></pre></td></tr></table></figure><p>2)如果zookeeper的默认端口不是2181的话还需要配置storm.zookeeper.port,如果是2181，此选项可以不用配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">storm.zookeeper.port: 2181</span><br></pre></td></tr></table></figure><p>3）storm.local.dir：Nimbus和Supervisor守护进程需要本地磁盘上的一个目录来存储少量状态（如jar，confs和类似的东西）。您应该在每台计算机上创建该目录，为其提供适当的权限，然后使用此配置填写目录位置。例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">storm.local.dir: &quot;/data/storm&quot;</span><br></pre></td></tr></table></figure><p>4）nimbus.seeds：工作节点需要知道哪些机器是主机的候选者才能下载拓扑罐和confs。例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nimbus.seeds: [&quot;k8s-n1&quot;,&quot;k8s-n2&quot;,&quot;k8s-n3&quot;]</span><br></pre></td></tr></table></figure><p>4）supervisor.slots.ports：对于每个工作者计算机，您可以使用此配置配置在该计算机上运行的工作程序数。每个工作人员使用单个端口接收消息，此设置定义哪些端口可以使用。如果您在此处定义了五个端口，那么Storm将分配最多五个工作人员在此计算机上运行。如果您定义了三个端口，Storm最多只能运行三个端口。默认情况下，此设置配置为在端口6700,6701,6702和6703上运行4个工作程序。例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">supervisor.slots.ports:</span><br><span class="line">    - 6700</span><br><span class="line">    - 6701</span><br><span class="line">    - 6702</span><br><span class="line">    - 6703</span><br></pre></td></tr></table></figure><p>5)开启监督机制监督健康状况<br>Storm提供了一种机制，管理员可以通过该机制定期管理员定期运行管理员提供的脚本，以确定节点是否健康。管理员可以让主管通过在storm.health.check.dir中的脚本中执行他们选择的任何检查来确定节点是否处于健康状态。如果脚本检测到节点处于不健康状态，则必须从标准输出打印一行，以字符串ERROR开头。主管将定期运行运行状况检查目录中的脚本并检查输出。如果脚本的输出包含字符串ERROR，如上所述，主管将关闭所有工作人员并退出。</p><p>如果主管在监督下运行，则可以调用“/ bin / storm node-health-check”来确定是否应该启动主管或节点是否运行状况不佳。</p><p>运行状况检查目录位置可以配置为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">storm.health.check.dir: &quot;healthchecks&quot;</span><br></pre></td></tr></table></figure><p>脚本必须具有执行权限。允许任何给定的运行状况检查脚本在由于超时而标记为失败之前运行的时间可以配置为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">storm.health.check.timeout.ms: 5000</span><br></pre></td></tr></table></figure><p>启动</p><p>Nimbus：在主机监督下运行命令“bin / storm nimbus”。<br>主管：在每台工作机器的监督下运行命令“bin / storm supervisor”。管理程序守护程序负责启动和停止该计算机上的工作进程。<br>UI：通过在监督下运行命令“bin / storm ui”，运行Storm UI（您可以从浏览器访问的站点，该站点提供对群集和拓扑的诊断）。可以通过将Web浏览器导航到http：// {ui host}：8080来访问UI。<br>如您所见，运行守护进程非常简单。守护程序将在您解压缩Storm版本的任何位置登录到logs /目录。<br>后台启动<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup storm ui &gt;/dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><p></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --&gt;&lt;h1 id=&quot;环境准备&quot;&gt;&lt;a href=&quot;#环境准备&quot; class=&quot;headerlink&quot; title=&quot;环境准备&quot;&gt;&lt;/a&gt;环境准备&lt;/h1&gt;
      
    
    </summary>
    
      <category term="storm" scheme="http://www.liuyong520.cn/categories/storm/"/>
    
    
      <category term="storm" scheme="http://www.liuyong520.cn/tags/storm/"/>
    
  </entry>
  
  <entry>
    <title>kafka API的使用</title>
    <link href="http://www.liuyong520.cn/2019/05/02/kafka-API/"/>
    <id>http://www.liuyong520.cn/2019/05/02/kafka-API/</id>
    <published>2019-05-02T13:37:40.000Z</published>
    <updated>2019-05-03T13:16:45.720Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --><h1 id="kafka-API"><a href="#kafka-API" class="headerlink" title="kafka API"></a>kafka API</h1><p>kafka Consumer提供两套Java API：高级Consumer API、和低级Consumer API。</p><p>高级Consumer API 优点：</p><ul><li>高级API写起来简单，易用。<br>不需要自行去管理offset，API已经封装好了offset这块的东西，会通过zookeeper自行管理<br>不需要管理分区，副本等情况，系统自动管理<br>消费者断线后会自动根据上次记录在zookeeper中的offset接着消费消息。</li></ul><p>高级Consumer API 缺点：</p><ul><li>不能自行控制offset。</li><li>不能自行管理分区，副本，zk等相关信息。</li></ul><p>低级API 优点：</p><ul><li>能够让开发者自己维护offset.想从哪里消费就从哪里消费</li><li>自行控制连接分区，对分区自定义负载均衡</li><li>对zookeeper的依赖性降低（如 offset 不一定要用zk来存储，可以存在缓存里或者内存中）</li></ul><p>缺点：<br>过于复杂，需要自行控制offset，连接哪个分区，找分区leader等。</p><h1 id="简单入门使用"><a href="#简单入门使用" class="headerlink" title="简单入门使用"></a>简单入门使用</h1><ol><li><p>引入maven依赖</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;kafka-clients&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.2.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li><li><p>Producer简单使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sonly.kafka;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerRecord;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;package:com.sonly.kafka&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;project(项目):kafkaAPIdemo&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;class(类)demo&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;creat date(创建时间):2019-05-03 12:17&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;author(作者):&lt;/b&gt;xxydliuyss&lt;/br&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;note(备注)):&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * If you want to change the file header,please modify zhe File and Code Templates.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">demo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,<span class="string">"k8s-n1:9092"</span>);</span><br><span class="line">        properties.put(ProducerConfig.ACKS_CONFIG,<span class="string">"1"</span>);</span><br><span class="line">        properties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,<span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line">        properties.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,<span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line">        KafkaProducer&lt;String, String&gt; producer = <span class="keyword">new</span> KafkaProducer&lt;String, String&gt;(properties);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">            producer.send(<span class="keyword">new</span> ProducerRecord&lt;String, String&gt;(<span class="string">"mytest"</span>, Integer.toString(i), Integer.toString(i)));</span><br><span class="line">        producer.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>带回调函数的生产者<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sonly.kafka;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;package:com.sonly.kafka&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;project(项目):kafkaAPIdemo&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;class(类)$&#123;CLASS_NAME&#125;&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;creat date(创建时间):2019-05-03 12:58&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;author(作者):&lt;/b&gt;xxydliuyss&lt;/br&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;note(备注)):&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * If you want to change the file header,please modify zhe File and Code Templates.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">demo1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="comment">//设置kafka集群</span></span><br><span class="line">        properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,<span class="string">"k8s-n1:9092"</span>);</span><br><span class="line">        <span class="comment">//设置brokeACK应答机制</span></span><br><span class="line">        properties.put(ProducerConfig.ACKS_CONFIG,<span class="string">"1"</span>);</span><br><span class="line">        <span class="comment">//设置key序列化</span></span><br><span class="line">        properties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,<span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line">        <span class="comment">//设置value序列化</span></span><br><span class="line">        properties.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,<span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line">        <span class="comment">//设置批量大小</span></span><br><span class="line">        properties.put(ProducerConfig.BATCH_SIZE_CONFIG,<span class="string">"6238"</span>);</span><br><span class="line">        <span class="comment">//设置提交延时</span></span><br><span class="line">        properties.put(ProducerConfig.LINGER_MS_CONFIG,<span class="string">"1"</span>);</span><br><span class="line">        <span class="comment">//设置producer缓存</span></span><br><span class="line">        properties.put(ProducerConfig.BUFFER_MEMORY_CONFIG,Long.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">        KafkaProducer&lt;String, String&gt; producer = <span class="keyword">new</span> KafkaProducer&lt;String, String&gt;(properties);</span><br><span class="line">        <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">12</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> finalI = i;</span><br><span class="line">            producer.send(<span class="keyword">new</span> ProducerRecord&lt;String, String&gt;(<span class="string">"mytest"</span>, Integer.toString(i), Integer.toString(i)), <span class="keyword">new</span> Callback() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompletion</span><span class="params">(RecordMetadata metadata, Exception exception)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span>(exception==<span class="keyword">null</span>)&#123;</span><br><span class="line">                        System.out.println(<span class="string">"发送成功: "</span> + finalI +<span class="string">","</span>+metadata.partition()+<span class="string">","</span>+ metadata.offset());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        producer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>结果：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">发送成功: 0,0,170</span><br><span class="line">发送成功: 2,0,171</span><br><span class="line">发送成功: 11,0,172</span><br><span class="line">发送成功: 4,1,101</span><br><span class="line">发送成功: 5,2,116</span><br><span class="line">发送成功: 6,2,117</span><br><span class="line">发送成功: 10,2,118</span><br><span class="line">发送成功: 1,3,175</span><br><span class="line">发送成功: 3,3,176</span><br><span class="line">发送成功: 7,3,177</span><br><span class="line">发送成功: 8,3,178</span><br><span class="line">发送成功: 9,3,179</span><br></pre></td></tr></table></figure><p></p><p>数据不均等的分配到0-3 号分区上</p><ol start="3"><li>自定义分区发送<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sonly.kafka;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.Partitioner;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.Cluster;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;package:com.sonly.kafka&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;project(项目):kafkaAPIdemo&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;class(类)$&#123;CLASS_NAME&#125;&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;creat date(创建时间):2019-05-03 13:43&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;author(作者):&lt;/b&gt;xxydliuyss&lt;/br&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;note(备注)):&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * If you want to change the file header,please modify zhe File and Code Templates.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomProducer</span> <span class="keyword">implements</span> <span class="title">Partitioner</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(String topic, Object key, <span class="keyword">byte</span>[] keyBytes, Object value, <span class="keyword">byte</span>[] valueBytes, Cluster cluster)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Map&lt;String, ?&gt; configs)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>设置分区<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sonly.kafka;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;package:com.sonly.kafka&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;project(项目):kafkaAPIdemo&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;class(类)$&#123;CLASS_NAME&#125;&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;creat date(创建时间):2019-05-03 13:46&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;author(作者):&lt;/b&gt;xxydliuyss&lt;/br&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;note(备注)):&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * If you want to change the file header,please modify zhe File and Code Templates.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">demo2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="comment">//设置kafka集群</span></span><br><span class="line">        properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,<span class="string">"k8s-n1:9092"</span>);</span><br><span class="line">        <span class="comment">//设置brokeACK应答机制</span></span><br><span class="line">        properties.put(ProducerConfig.ACKS_CONFIG,<span class="string">"1"</span>);</span><br><span class="line">        <span class="comment">//设置key序列化</span></span><br><span class="line">        properties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,<span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line">        <span class="comment">//设置value序列化</span></span><br><span class="line">        properties.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,<span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line">        <span class="comment">//设置批量大小</span></span><br><span class="line">        properties.put(ProducerConfig.BATCH_SIZE_CONFIG,<span class="string">"6238"</span>);</span><br><span class="line">        <span class="comment">//设置提交延时</span></span><br><span class="line">        properties.put(ProducerConfig.LINGER_MS_CONFIG,<span class="string">"1"</span>);</span><br><span class="line">        <span class="comment">//设置producer缓存</span></span><br><span class="line">        properties.put(ProducerConfig.BUFFER_MEMORY_CONFIG,Long.MAX_VALUE);</span><br><span class="line">        <span class="comment">//设置partition</span></span><br><span class="line">        properties.put(ProducerConfig.PARTITIONER_CLASS_CONFIG,<span class="string">"com.sonly.kafka.CustomProducer"</span>);</span><br><span class="line">        KafkaProducer&lt;String, String&gt; producer = <span class="keyword">new</span> KafkaProducer&lt;String, String&gt;(properties);</span><br><span class="line">        <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">12</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> finalI = i;</span><br><span class="line">            producer.send(<span class="keyword">new</span> ProducerRecord&lt;String, String&gt;(<span class="string">"mytest"</span>, Integer.toString(i), Integer.toString(i)), <span class="keyword">new</span> Callback() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompletion</span><span class="params">(RecordMetadata metadata, Exception exception)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span>(exception==<span class="keyword">null</span>)&#123;</span><br><span class="line">                        System.out.println(<span class="string">"发送成功: "</span> + finalI +<span class="string">","</span>+metadata.partition()+<span class="string">","</span>+ metadata.offset());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        producer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>消费者高级API：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sonly.kafka.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;package:com.sonly.kafka.consumer&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;project(项目):kafkaAPIdemo&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;class(类)$&#123;CLASS_NAME&#125;&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;creat date(创建时间):2019-05-03 13:59&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;author(作者):&lt;/b&gt;xxydliuyss&lt;/br&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;note(备注)):&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * If you want to change the file header,please modify zhe File and Code Templates.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="comment">//设置kafka集群</span></span><br><span class="line">        properties.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG,<span class="string">"k8s-n1:9092"</span>);</span><br><span class="line">        <span class="comment">//设置brokeACK应答机制</span></span><br><span class="line">        properties.put(ConsumerConfig.GROUP_ID_CONFIG,<span class="string">"teste3432"</span>);</span><br><span class="line">        <span class="comment">//设置key反序列化</span></span><br><span class="line">        properties.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG,<span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">        <span class="comment">//设置value反序列化</span></span><br><span class="line">        properties.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG,<span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">        <span class="comment">//设置拿取大小</span></span><br><span class="line">        properties.put(ConsumerConfig.FETCH_MAX_BYTES_CONFIG,<span class="number">100</span>*<span class="number">1024</span>*<span class="number">1024</span>);</span><br><span class="line">        <span class="comment">//设置自动提交offset</span></span><br><span class="line">        properties.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG,<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//设置自动提交延时</span></span><br><span class="line">        properties.put(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG,<span class="number">1000</span>);</span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;String, String&gt;(properties);</span><br><span class="line">        consumer.subscribe(Arrays.asList(<span class="string">"mytest"</span>,<span class="string">"test"</span>));</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">            ConsumerRecords&lt;String, String&gt; records = consumer.poll(<span class="number">10</span>);</span><br><span class="line">            <span class="keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records) &#123;</span><br><span class="line">                System.out.println(record.topic()+<span class="string">"--"</span>+record.partition()+<span class="string">"--"</span>+record.value());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>低级API：<br>1.消费者使用低级API的主要步骤</p><table><thead><tr><th>步骤</th><th>主要工作</th></tr></thead><tbody><tr><td>1</td><td>根据指定分区从topic元数据中找到leader</td></tr><tr><td>2</td><td>获取分区最新的消费进度</td></tr><tr><td>3</td><td>从主副本中拉取分区消息</td></tr><tr><td>4</td><td>识别主副本的变化，重试</td></tr></tbody></table><p>2.方法描述：</p><table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td>findLeader()</td><td>客户端向种子阶段发送主题元数据，将副本加入备用节点</td></tr><tr><td>getLastOffset()</td><td>消费者客户端发送偏移量请求，获取分区最近的偏移量</td></tr><tr><td>run()</td><td>消费者低级API拉取消息的方法</td></tr><tr><td>findNewLeader()</td><td>当分区主副本节点发生故障时，客户端将要找出新的主副本</td></tr></tbody></table><p>修改pom<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;kafka_2.11&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.1.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;kafka-clients&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.1.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sonly.kafka.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> kafka.api.FetchRequest;</span><br><span class="line"><span class="keyword">import</span> kafka.api.FetchRequestBuilder;</span><br><span class="line"><span class="keyword">import</span> kafka.api.KAFKA_0_8_1$;</span><br><span class="line"><span class="keyword">import</span> kafka.cluster.BrokerEndPoint;</span><br><span class="line"><span class="keyword">import</span> kafka.javaapi.*;</span><br><span class="line"><span class="keyword">import</span> kafka.javaapi.consumer.SimpleConsumer;</span><br><span class="line"><span class="keyword">import</span> kafka.javaapi.message.ByteBufferMessageSet;</span><br><span class="line"><span class="keyword">import</span> kafka.message.MessageAndOffset;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.Consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;package:com.sonly.kafka.consumer&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;project(项目):kafkaAPIdemo&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;class(类)$&#123;CLASS_NAME&#125;&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;creat date(创建时间):2019-05-03 15:21&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;author(作者):&lt;/b&gt;xxydliuyss&lt;/br&gt;</span></span><br><span class="line"><span class="comment"> * &lt;b&gt;note(备注)):&lt;/b&gt;</span></span><br><span class="line"><span class="comment"> * If you want to change the file header,please modify zhe File and Code Templates.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LowerConsumer</span> </span>&#123;</span><br><span class="line">    <span class="comment">//保存offset</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> offset;</span><br><span class="line">    <span class="comment">//保存分区副本</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Integer,List&lt;BrokerEndPoint&gt;&gt; partitionsMap = <span class="keyword">new</span> HashMap&lt;Integer, List&lt;BrokerEndPoint&gt;&gt;(<span class="number">1024</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        List&lt;String&gt; brokers = Arrays.asList(<span class="string">"k8s-n1"</span>, <span class="string">"k8s-n2"</span>,<span class="string">"k8s-n3"</span>);</span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">9092</span>;</span><br><span class="line">        <span class="keyword">int</span> partition = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">long</span> offset=<span class="number">2</span>;</span><br><span class="line">        LowerConsumer lowerConsumer = <span class="keyword">new</span> LowerConsumer();</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line"><span class="comment">//            offset = lowerConsumer.getOffset();</span></span><br><span class="line">            lowerConsumer.getData(brokers,port,<span class="string">"mytest"</span>,partition,offset);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getOffset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> offset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> BrokerEndPoint <span class="title">findLeader</span><span class="params">(Collection&lt;String&gt; brokers,<span class="keyword">int</span> port,String topic,<span class="keyword">int</span> partition)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String broker : brokers) &#123;</span><br><span class="line">            <span class="comment">//创建消费者对象操作每一台服务器</span></span><br><span class="line">            SimpleConsumer getLeader = <span class="keyword">new</span> SimpleConsumer(broker, port, <span class="number">10000</span>, <span class="number">1024</span> * <span class="number">24</span>, <span class="string">"getLeader"</span>);</span><br><span class="line">            <span class="comment">//构造元数据请求</span></span><br><span class="line">            TopicMetadataRequest topicMetadataRequest = <span class="keyword">new</span> TopicMetadataRequest(Collections.singletonList(topic));</span><br><span class="line">            <span class="comment">//发送元数据请求</span></span><br><span class="line">            TopicMetadataResponse response = getLeader.send(topicMetadataRequest);</span><br><span class="line">            <span class="comment">//解析元数据</span></span><br><span class="line">            List&lt;TopicMetadata&gt; topicMetadatas = response.topicsMetadata();</span><br><span class="line">            <span class="comment">//遍历数据</span></span><br><span class="line">            <span class="keyword">for</span> (TopicMetadata topicMetadata : topicMetadatas) &#123;</span><br><span class="line">                <span class="comment">//获取分区元数据信息</span></span><br><span class="line">                List&lt;PartitionMetadata&gt; partitionMetadatas = topicMetadata.partitionsMetadata();</span><br><span class="line">                <span class="comment">//遍历分区元数据</span></span><br><span class="line">                <span class="keyword">for</span> (PartitionMetadata partitionMetadata : partitionMetadatas) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(partition == partitionMetadata.partitionId())&#123;</span><br><span class="line">                        <span class="comment">//保存，分区对应的副本，如果需要主副本挂掉重新获取leader只需要遍历这个缓存即可</span></span><br><span class="line">                        List&lt;BrokerEndPoint&gt; isr = partitionMetadata.isr();</span><br><span class="line">                        <span class="keyword">this</span>.partitionsMap.put(partition,isr);</span><br><span class="line">                        <span class="keyword">return</span> partitionMetadata.leader();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getData</span><span class="params">(Collection&lt;String&gt; brokers,<span class="keyword">int</span> port,String topic,<span class="keyword">int</span> partition,<span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">        <span class="comment">//获取leader</span></span><br><span class="line">        BrokerEndPoint leader = findLeader(brokers, port, topic, partition);</span><br><span class="line">        <span class="keyword">if</span>(leader==<span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">        String host = leader.host();</span><br><span class="line">        <span class="comment">//获取数据的消费者对象</span></span><br><span class="line">        SimpleConsumer getData = <span class="keyword">new</span> SimpleConsumer(host, port, <span class="number">10000</span>, <span class="number">1024</span> * <span class="number">10</span>, <span class="string">"getData"</span>);</span><br><span class="line">        <span class="comment">//构造获取数据request 这里一次可以添加多个topic addFecth 添加即可</span></span><br><span class="line">        FetchRequest fetchRequestBuilder = <span class="keyword">new</span> FetchRequestBuilder().addFetch(topic, partition, offset, <span class="number">1024</span> * <span class="number">10</span>).build();</span><br><span class="line">        <span class="comment">//发送获取数据请求</span></span><br><span class="line">        FetchResponse fetchResponse = getData.fetch(fetchRequestBuilder);</span><br><span class="line">        <span class="comment">//解析元数据返回，这是message的一个set集合</span></span><br><span class="line">        ByteBufferMessageSet messageAndOffsets = fetchResponse.messageSet(topic, partition);</span><br><span class="line">        <span class="comment">//遍历消息集合</span></span><br><span class="line">        <span class="keyword">for</span> (MessageAndOffset messageAndOffset : messageAndOffsets) &#123;</span><br><span class="line">            <span class="keyword">long</span> offset1 = messageAndOffset.offset();</span><br><span class="line">            <span class="keyword">this</span>.setOffset(offset);</span><br><span class="line">            ByteBuffer payload = messageAndOffset.message().payload();</span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[payload.limit()];</span><br><span class="line">            payload.get(buffer);</span><br><span class="line">            String message = <span class="keyword">new</span> String(buffer);</span><br><span class="line">            System.out.println(<span class="string">"offset:"</span>+ offset1 +<span class="string">"--message:"</span>+ message);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setOffset</span><span class="params">(<span class="keyword">long</span> offset)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.offset = offset;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个低级API在最新的kafka版本中已经不再提供了。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --&gt;&lt;h1 id=&quot;kafka-API&quot;&gt;&lt;a href=&quot;#kafka-API&quot; class=&quot;headerlink&quot; title=&quot;kafka API
      
    
    </summary>
    
      <category term="消息队列" scheme="http://www.liuyong520.cn/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
    
      <category term="kafka" scheme="http://www.liuyong520.cn/tags/kafka/"/>
    
  </entry>
  
  <entry>
    <title>Linux下zookeeper集群搭建</title>
    <link href="http://www.liuyong520.cn/2019/04/29/zookeeper-install/"/>
    <id>http://www.liuyong520.cn/2019/04/29/zookeeper-install/</id>
    <published>2019-04-29T02:56:51.000Z</published>
    <updated>2019-04-29T10:04:56.654Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --><h2 id="部署前准备"><a href="#部署前准备" class="headerlink" title="部署前准备"></a>部署前准备</h2><ol><li><p>下载zookeeper的安装包<br><a href="http://zookeeper.apache.org/releases.html" target="_blank" rel="noopener">http://zookeeper.apache.org/releases.html</a> 我下载的版本是zookeeper-3.4.10。</p></li><li><p>准备三台服务器<br>ip地址为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">172.16.18.198</span><br><span class="line">172.16.18.199</span><br><span class="line">172.16.18.200</span><br></pre></td></tr></table></figure></li><li><p>检查jdk版本，安装jdk环境，jdk需要1.7以上。</p></li></ol><h2 id="安装zookeeper"><a href="#安装zookeeper" class="headerlink" title="安装zookeeper"></a>安装zookeeper</h2><ol><li><p>三台服务器分别上传zookeeper安装包，上传到/opt/目录下，然后tar zxvf zookeeper-3.4.10.tar.gz</p></li><li><p>拷贝zoo_sample.cfg 为zoo.cfg 修改/opt/zookeeper-3.4.10/conf/zoo.cfg配置文件，添加如下内容：</p></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server.1=172.16.18.198:2888:3888</span><br><span class="line">server.2=172.16.18.199:2888:3888</span><br><span class="line">server.3=172.16.18.200:2888:3888</span><br></pre></td></tr></table></figure><ol start="3"><li>修改zookeeper数据文件存放目录<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dataDir=/data/zookeeper</span><br></pre></td></tr></table></figure></li></ol><p>此时zoo.cfg 配置文件内容为：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># The number of milliseconds of each tick</span><br><span class="line">tickTime=2000 ##zookeeper单位时间为2ms</span><br><span class="line"># The number of ticks that the initial </span><br><span class="line"># synchronization phase can take</span><br><span class="line">initLimit=10  ##对于从节点最初连接到主节点时的超时时间，单位为tick值的倍数。即20ms</span><br><span class="line"># The number of ticks that can pass between </span><br><span class="line"># sending a request and getting an acknowledgement</span><br><span class="line">syncLimit=5   ##对于主节点与从节点进行同步操作时的超时时间，单位为tick值的倍数。即10ms</span><br><span class="line"># the directory where the snapshot is stored.</span><br><span class="line"># do not use /tmp for storage, /tmp here is just </span><br><span class="line"># example sakes.</span><br><span class="line">dataDir=/data/zookeeper</span><br><span class="line"># the port at which the clients will connect</span><br><span class="line">clientPort=2181  ##客户端链接端口</span><br><span class="line"># the maximum number of client connections.</span><br><span class="line"># increase this if you need to handle more clients</span><br><span class="line">maxClientCnxns=60 ##客户端最大链接数</span><br><span class="line">#</span><br><span class="line"># Be sure to read the maintenance section of the </span><br><span class="line"># administrator guide before turning on autopurge.</span><br><span class="line">#</span><br><span class="line"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span><br><span class="line">#</span><br><span class="line"># The number of snapshots to retain in dataDir</span><br><span class="line">#autopurge.snapRetainCount=3</span><br><span class="line"># Purge task interval in hours</span><br><span class="line"># Set to &quot;0&quot; to disable auto purge feature</span><br><span class="line">#autopurge.purgeInterval=1</span><br><span class="line">server.1=172.16.18.198:2888:3888  </span><br><span class="line">server.2=172.16.18.199:2888:3888</span><br><span class="line">server.3=172.16.18.200:2888:3888</span><br></pre></td></tr></table></figure><p></p><ol start="4"><li><p>新建myid文件<br>在三台服务器的数据存放目录下新建myid文件，并写入对应的server.num 中的num数字<br>如：在172.16.18.198上将server.1中1写入myid</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt;/data/zookeeper/myid</span><br></pre></td></tr></table></figure></li><li><p>添加环境变量，方便我们执行脚本命令<br>vi etc/profile 在最后添加如下两个。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export ZOOKEEPER_HOME=/opt/zookeeper-3.4.9</span><br><span class="line">export PATH=$PATH:$ZOOKEEPER_HOME/bin:$ZOOKEEPER_HOME/conf</span><br></pre></td></tr></table></figure></li></ol><p>保存后重新加载一下：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><p></p><ol start="6"><li>修改日志存放目录（可选）<br>vi /opt/zookeeper/bin/zkEnv.sh 找到ZOO_LOG_DIR 和 ZOO_LOG4J_PROP位置<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if [ &quot;x$&#123;ZOO_LOG_DIR&#125;&quot; = &quot;x&quot; ] </span><br><span class="line">then </span><br><span class="line">    #配置zookeeper日志输出存放路径 </span><br><span class="line">    ZOO_LOG_DIR=&quot;/var/applog/zookeeper&quot; </span><br><span class="line">fi </span><br><span class="line"></span><br><span class="line">if [ &quot;x$&#123;ZOO_LOG4J_PROP&#125;&quot; = &quot;x&quot; ] </span><br><span class="line">then </span><br><span class="line">    #配置日志输出级别,这里把几个级别一并配上 </span><br><span class="line">    ZOO_LOG4J_PROP=&quot;INFO,CONSOLE,ROLLINGFILE,TRACEFILE&quot; </span><br><span class="line">fi</span><br></pre></td></tr></table></figure></li></ol><p>编辑conf目录下log4j.properties<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># Define some default values that can be overridden by system properties </span><br><span class="line">zookeeper.root.logger=INFO, CONSOLE, ROLLINGFILE, TRACEFILE </span><br><span class="line">zookeeper.console.threshold=INFO </span><br><span class="line">zookeeper.log.dir=. </span><br><span class="line">zookeeper.log.file=zookeeper.log </span><br><span class="line">zookeeper.log.threshold=ERROR </span><br><span class="line">zookeeper.tracelog.dir=. </span><br><span class="line">zookeeper.tracelog.file=zookeeper_trace.log </span><br><span class="line">log4j.rootLogger=$&#123;zookeeper.root.logger&#125;</span><br></pre></td></tr></table></figure><p></p><p>完成log的日志目录的修改。<br>7.启动zookeeper服务</p><p>zkServer.sh start来启动。</p><p>zkServer.sh restart　　(重启)</p><p>zkServer.sh status　　(查看状态)</p><p>zkServer.sh stop　　(关闭)</p><p>zkServer.sh start-foreground　　(以打印日志方式启动)<br>三台服务器分别执行：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkServer.sh start</span><br></pre></td></tr></table></figure><p></p><p>然后用 status 检查下状态 如果出现 Mode：leader 或者Mode:follower 表示搭建成功。否则前台执行看一下日志。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /opt/zookeeper-3.4.10/bin/../conf/zoo.cfg</span><br><span class="line">Mode: follower</span><br></pre></td></tr></table></figure><p></p><p>如出现：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">2019-04-29 14:04:05,992 [myid:3] - INFO  [ListenerThread:QuorumCnxManager$Listener@739] - My election bind port: /172.16.18.200:3888</span><br><span class="line">2019-04-29 14:04:06,019 [myid:3] - INFO  [QuorumPeer[myid=3]/0:0:0:0:0:0:0:0:2181:QuorumPeer@865] - LOOKING</span><br><span class="line">2019-04-29 14:04:06,025 [myid:3] - INFO  [QuorumPeer[myid=3]/0:0:0:0:0:0:0:0:2181:FastLeaderElection@818] - New election. My id =  3, proposed zxid=0x0</span><br><span class="line">2019-04-29 14:04:06,056 [myid:3] - WARN  [WorkerSender[myid=3]:QuorumCnxManager@588] - Cannot open channel to 1 at election address /172.16.18.198:3888</span><br><span class="line">java.net.NoRouteToHostException: 没有到主机的路由</span><br><span class="line">        at java.net.PlainSocketImpl.socketConnect(Native Method)</span><br><span class="line">        at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:345)</span><br><span class="line">        at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)</span><br><span class="line">        at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)</span><br><span class="line">&quot;zookeeper.log&quot; 303L, 35429C</span><br></pre></td></tr></table></figure><p></p><p>报这种异常一般有三种情况：</p><p>1）：zoo.cfg配置文件中，server.x:2888:3888配置出现错误；</p><p>2）：myid文件内容和server.x不对应，或者myid不在data目录下；</p><p>3）：系统防火墙是否在启动。</p><p>我检查了三种原因后发现是防火墙running。</p><p>centos7下查看防火墙状态的命令：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --state</span><br></pre></td></tr></table></figure><p></p><p>关闭防火墙的命令：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld.service</span><br><span class="line">systemctl disable firewalld.service   （禁止开机启动，永久关闭防火墙）</span><br></pre></td></tr></table></figure><p></p><p>关闭防火墙后重启即可。</p><ol start="8"><li>验证是否成功<br>在命令行中输入：zkCli.sh -server 172.16.18.198:2181（由于本人在不同的办公地点在修改该文章，所以ip地址也在变化，知道原理即可）即可连接到其中一台ZooKeeper服务器。其他自动实现同步，客户端只需要和一台保持连接即可。出现如下表示链接成功<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">WATCHER::</span><br><span class="line"></span><br><span class="line">WatchedEvent state:SyncConnected type:None path:null</span><br><span class="line">[zk: 172.16.18.198:2181(CONNECTED) 0]</span><br></pre></td></tr></table></figure></li></ol><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --&gt;&lt;h2 id=&quot;部署前准备&quot;&gt;&lt;a href=&quot;#部署前准备&quot; class=&quot;headerlink&quot; title=&quot;部署前准备&quot;&gt;&lt;/a&gt;部署前准备&lt;
      
    
    </summary>
    
      <category term="分布式集群" scheme="http://www.liuyong520.cn/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4/"/>
    
    
      <category term="linux" scheme="http://www.liuyong520.cn/tags/linux/"/>
    
      <category term="ZooKeeper" scheme="http://www.liuyong520.cn/tags/ZooKeeper/"/>
    
  </entry>
  
  <entry>
    <title>kafka基本介绍</title>
    <link href="http://www.liuyong520.cn/2019/04/29/kafka-intruduce/"/>
    <id>http://www.liuyong520.cn/2019/04/29/kafka-intruduce/</id>
    <published>2019-04-29T02:56:51.000Z</published>
    <updated>2019-05-02T11:30:40.781Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --><h1 id="kafka是什么？"><a href="#kafka是什么？" class="headerlink" title="kafka是什么？"></a>kafka是什么？</h1><p>Kafka是一个分布式流式存储并处理的消息队列。由scale+java语言编写，它提供了类似于JMS的特性，但是在设计实现上又完全不同，因为kafka并不是按照JMS规范实现的。kafka集群由多个broke（Kafka实例称之为broke）组成，在集群里，kafka通过消息订阅和发布将消息以topic的形式发布出来，同时，消息也是存储在topic中的，消息的发送者成为producer，消息接受者成为Consummer。<br>同时，topic 是根据分区partitions，和副本replications来实现的数据的分布式存储，和加强数据的可靠性。</p><p><img src="http://kafka.apache.org/22/images/kafka-apis.png" alt="官方图片"></p><h1 id="何为topic？"><a href="#何为topic？" class="headerlink" title="何为topic？"></a>何为topic？</h1><p>一个topic可以认为是一类消息，每个topic将被分成多个partitions，每个partition在存储append log的形式存在文件里的。任何发布到partition的消息都会直接被追加到log文件的末尾，每条消息在文件中的位置称之为offset偏移量，offset为一个long型数字，它唯一标识一条消息，kafka并没有提供其他索引来存储offset，因此kafka不支持消息的随机读写。<br><img src="http://kafka.apache.org/22/images/log_anatomy.png" alt="分区结构图"></p><p>kafka和JMS（Java Message Service）实现(activeMQ)不同的是:即使消息被消费,消息仍然不会被立即删除.日志文件将会根据broker中的配置要求,保留一定的时间之后(默认是7天)删除;比如log文件保留2天,那么两天后,文件会被清除,无论其中的消息是否被消费.kafka通过这种简单的手段,来释放磁盘空间,以及减少消息消费之后对文件内容改动的磁盘IO开支.</p><h1 id="kafka消息如何消费的？"><a href="#kafka消息如何消费的？" class="headerlink" title="kafka消息如何消费的？"></a>kafka消息如何消费的？</h1><p>对于consumer而言,它需要保存消费消息的offset,对于offset的保存和使用,有consumer来控制;当consumer正常消费消息时,offset将会”线性”的向前驱动,即消息将依次顺序被消费.事实上consumer可以使用任意顺序消费消息,它只需要将offset重置为任意值..(kafka 老版本中offset将会保存在zookeeper中,1.x之后也会存储在broke集群里,参见下文)</p><h1 id="kafka-集群里consumer和producer的状态信息是如何保存的？"><a href="#kafka-集群里consumer和producer的状态信息是如何保存的？" class="headerlink" title="kafka 集群里consumer和producer的状态信息是如何保存的？"></a>kafka 集群里consumer和producer的状态信息是如何保存的？</h1><p>kafka集群几乎不需要维护任何consumer和producer状态信息,这些信息由zookeeper保存;因此producer和consumer的客户端实现非常轻量级,它们可以随意离开,而不会对集群造成额外的影响.</p><h1 id="kafka为何要引入分区的概念，有何好处？"><a href="#kafka为何要引入分区的概念，有何好处？" class="headerlink" title="kafka为何要引入分区的概念，有何好处？"></a>kafka为何要引入分区的概念，有何好处？</h1><p>partitions的设计目的有多个.最根本原因是kafka基于文件存储.通过分区,可以将日志内容分散到多个kafka实例上,来避免文件尺寸达到单机磁盘的上限,每个partiton都会被当前server(kafka实例)保存;可以将一个topic切分多任意多个partitions,来消息保存/消费的效率.此外越多的partitions意味着可以容纳更多的consumer,有效提升并发消费的能力.有负载均衡的功效(具体原理参见下文).</p><h1 id="kakfa数据是如何写入到磁盘的？"><a href="#kakfa数据是如何写入到磁盘的？" class="headerlink" title="kakfa数据是如何写入到磁盘的？"></a>kakfa数据是如何写入到磁盘的？</h1><p>一个Topic的多个partitions,被分布在kafka集群中的多个server上;每个server(kafka实例)负责partitions中消息的读写操作;此外kafka还可以配置partitions需要备份的个数(replicas),每个partition将会被备份到多台机器上,以提高可用性.</p><p>基于replicated方案,那么就意味着需要对多个备份进行调度;每个partition都有一个server为”leader”;leader负责所有的读写操作,如果leader失效,那么将会有其他follower来接管(成为新的leader);follower只是单调的和leader跟进,同步消息即可..由此可见作为leader的server承载了全部的请求压力,因此从集群的整体考虑,有多少个partitions就意味着有多少个”leader”,kafka会将”leader”均衡的分散在每个实例上,来确保整体的性能稳定.这和zookeeper的follower是有区别的：zookeeper的follower是可以读到数据的，而kafka的follower是读不到数据的。</p><p>kafka使用文件存储消息,这就直接决定kafka在性能上严重依赖文件系统的本身特性.且无论任何OS下,对文件系统本身的优化几乎没有可能.文件缓存/直接内存映射等是常用的手段.因为kafka是对日志文件进行append操作,因此磁盘检索的开支是较小的;同时为了减少磁盘写入的次数,broker会将消息暂时buffer起来,当消息的个数(或尺寸)达到一定阀值时,再flush到磁盘,这样减少了磁盘IO调用的次数.</p><h1 id="kafka中消费者组如何理解？"><a href="#kafka中消费者组如何理解？" class="headerlink" title="kafka中消费者组如何理解？"></a>kafka中消费者组如何理解？</h1><p>Producer将消息发布到指定的Topic中,同时Producer也能决定将此消息归属于哪个partition;比如基于”round-robin”方式或者通过其他的一些算法等.</p><p>本质上kafka只支持Topic.每个consumer属于一个consumer group;反过来说,每个group中可以有多个consumer.发送到Topic的消息,只会被订阅此Topic的每个group中的一个consumer消费.</p><p>如果所有的consumer都具有相同的group,这种情况和queue模式很像;消息将会在consumers之间负载均衡.<br>如果所有的consumer都具有不同的group,那这就是”发布-订阅”;消息将会广播给所有的消费者.</p><p>在kafka中,一个partition中的消息只会被group中的一个consumer消费;每个group中consumer消息消费互相独立;我们可以认为一个group是一个”订阅”者,一个Topic中的每个partions,只会被一个”订阅者”中的一个consumer消费,不过一个consumer可以消费多个partitions中的消息.kafka只能保证一个partition中的消息被某个consumer消费时,消息是顺序的.事实上,从Topic角度来说,消息仍不是有序的. 因为消费者消费消息的时候是按照分区依次读取的，所以无法保证消息的全局顺序性，只能保证在同一个分区内的消息是顺序的。如果想要所有的消息都是顺序的，可以把分区数设置为1.</p><h1 id="kafka中如何保证数据一段时间内不丢失？"><a href="#kafka中如何保证数据一段时间内不丢失？" class="headerlink" title="kafka中如何保证数据一段时间内不丢失？"></a>kafka中如何保证数据一段时间内不丢失？</h1><p>kafka 的producer有ACK机制。可以由用户自行设定是否开启确认机制，如果开启确认机制，kafka会等发送消息到kafka集群时，当leader服务器，会返回元数据给producer客户端，ACK机制也在元数据里，这里的ACK有两种，一种就是leader只要接收成功，就返回确认，另外一种就是：要等所有follower都收到了之后才返回确认。producer在接收到确认之后，才会发下一条消息。而所有的消息最终都是存储在磁盘一段时间的，所以一段时间内消息是不会丢失的。</p><h1 id="kafka-的应用场景主要有哪些？"><a href="#kafka-的应用场景主要有哪些？" class="headerlink" title="kafka 的应用场景主要有哪些？"></a>kafka 的应用场景主要有哪些？</h1><p>官方介绍是讲可以用作message queue，数据采集，简单流式计算等。</p><h1 id="用作消息队列message-queue有哪些优缺点？"><a href="#用作消息队列message-queue有哪些优缺点？" class="headerlink" title="用作消息队列message queue有哪些优缺点？"></a>用作消息队列message queue有哪些优缺点？</h1><p>对于一些常规的消息系统,kafka是个不错的选择;partitons/replication和容错,可以使kafka具有良好的扩展性和性能优势.不过到目前为止,我们应该很清楚认识到,kafka并没有提供JMS中的”事务性””消息传输担保(消息确认机制)””消息分组”等企业级特性;kafka只能使用作为”常规”的消息系统,在一定程度上,尚未确保消息的发送与接收绝对可靠(比如,消息重发,消息发送丢失等)</p><h1 id="kafka是如何保持高性能的？"><a href="#kafka是如何保持高性能的？" class="headerlink" title="kafka是如何保持高性能的？"></a>kafka是如何保持高性能的？</h1><p>需要考虑的影响性能点很多,除磁盘IO之外,我们还需要考虑网络IO,这直接关系到kafka的吞吐量问题.kafka并没有提供太多高超的技巧;对于producer端,可以将消息buffer起来,当消息的条数达到一定阀值时,批量发送给broker;对于consumer端也是一样,批量fetch多条消息.不过消息量的大小可以通过配置文件来指定.对于kafka broker端,似乎有个sendfile系统调用可以潜在的提升网络IO的性能:将文件的数据映射到系统内存中,socket直接读取相应的内存区域即可,而无需进程再次copy和交换. 其实对于producer/consumer/broker三者而言,CPU的开支应该都不大,因此启用消息压缩机制是一个良好的策略;压缩需要消耗少量的CPU资源,不过对于kafka而言,网络IO更应该需要考虑.可以将任何在网络上传输的消息都经过压缩.kafka支持gzip/snappy等多种压缩方式.</p><h1 id="kafka在消费者端有哪些异常处理策略？"><a href="#kafka在消费者端有哪些异常处理策略？" class="headerlink" title="kafka在消费者端有哪些异常处理策略？"></a>kafka在消费者端有哪些异常处理策略？</h1><p>对于JMS实现,消息传输担保非常直接:有且只有一次(exactly once).在kafka中稍有不同:<br>1) at most once: 最多一次,这个和JMS中”非持久化”消息类似.发送一次,无论成败,将不会重发.<br>2) at least once: 消息至少发送一次,如果消息未能接受成功,可能会重发,直到接收成功.<br>3) exactly once: 消息只会发送一次.<br>at most once: 消费者fetch消息,然后保存offset,然后处理消息;当client保存offset之后,但是在消息处理过程中出现了异常,导致部分消息未能继续处理.那么此后”未处理”的消息将不能被fetch到,这就是”at most once”.<br>at least once: 消费者fetch消息,然后处理消息,然后保存offset.如果消息处理成功之后,但是在保存offset阶段zookeeper异常导致保存操作未能执行成功,这就导致接下来再次fetch时可能获得上次已经处理过的消息,这就是”at least once”，原因offset没有及时的提交给zookeeper，zookeeper恢复正常还是之前offset状态.</p><p>exactly once: kafka中并没有严格的去实现基于2阶段提交,事务),我们认为这种策略在kafka中是没有必要的.<br>通常情况下”at-least-once”是我们搜选.(相比at most once而言,重复接收数据总比丢失数据要好).</p><h1 id="kafka-工作流程是怎样的？"><a href="#kafka-工作流程是怎样的？" class="headerlink" title="kafka 工作流程是怎样的？"></a>kafka 工作流程是怎样的？</h1><ol><li>主要结构图：大体可以从三个方面分析：生产者产生消息、消费者消费消息、Broker cluster保存消息。<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/attachments_1556770670858.drawio.png" alt="结构图"></li><li><p>生产者产生消息过程分析</p><ul><li>写入方式：<br>producer 采用push的方式将消息发送到broker cluster，每条消息都被追加到分区中，属于顺序写磁盘（顺序写磁盘效率比随机写内存效率要高，能提高Kafka吞吐率）<br>而且broker集群并不是每一条消息都及时写磁盘，而是先写buffer，达到一定大小或者每隔一段时间再flush到磁盘上。<br>多个producer可以给同一个topic 发布消息，而且可以指定分区发布。</li><li>分区Partition<br>每个Topic可以有多个分区，而消息最终是存储在磁盘的文件里的，Partition在磁盘上是文件夹的形式存在的。如<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd /var/applog/kafka/ ## 赚到kafka数据目录 即log.dir=配置的目录</span><br><span class="line">ls</span><br><span class="line">cleaner-offset-checkpoint  __consumer_offsets-22  __consumer_offsets-4   log-start-offset-checkpoint  recovery-point-offset-checkpoint</span><br><span class="line">__consumer_offsets-1       __consumer_offsets-25  __consumer_offsets-40  meta.properties              replication-offset-checkpoint</span><br><span class="line">__consumer_offsets-10      __consumer_offsets-28  __consumer_offsets-43  mytest-0                     test-0</span><br><span class="line">__consumer_offsets-13      __consumer_offsets-31  __consumer_offsets-46  mytest-1</span><br><span class="line">__consumer_offsets-16      __consumer_offsets-34  __consumer_offsets-49  mytest-2</span><br><span class="line">__consumer_offsets-19      __consumer_offsets-37  __consumer_offsets-7   mytest-3</span><br></pre></td></tr></table></figure></li></ul><p>其中mytest-0 mytest-1 mytest-2 mytest-3 即为分区Partition，里面的文件就是分区里面存放的数据。</p></li><li><p>broker cluster 保存消息<br>broker 收到消息后，首先会去找topic对应分区的leader，找到leader后，先将数据写入buffer，再flush到磁盘。然后zookeeper会协调follower自动同步leader分区的数据，以达到replication备份的目的，同时leader会按照备份完成的先后顺序给follower作一次排序，作为leader发生意外时选举时选举为leader的顺序。<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556780993351.png" alt="enter description here"></p></li><li>消费者消费消息<ol><li>消费者消费消息，同一个分区里的数据不能够被一个消费组里面的多个消费者同时消费，同一个消费组里的消费者只能消费不同分区的数据。</li><li>不同消费者组可以消费同一个分区里的数据。</li><li>消费者消费数据时是按照分区的一个一个分区数据进行消费的。<h1 id="zookeeper在kafka中的具体作用是什么？"><a href="#zookeeper在kafka中的具体作用是什么？" class="headerlink" title="zookeeper在kafka中的具体作用是什么？"></a>zookeeper在kafka中的具体作用是什么？</h1>kafka是依赖于zookeeper注册中心的，主要来协调各个broker的分区备份，broker的选举，以及消费者相关状信息的存储。<br>kafka使用zookeeper来存储一些meta信息,并使用了zookeeper watch机制来发现meta信息的变更并作出相应的动作(比如consumer失效,触发负载均衡等)<br>1) Broker node registry: 当一个kafkabroker启动后,首先会向zookeeper注册自己的节点信息(临时znode),同时当broker和zookeeper断开连接时,此znode也会被删除.<br>格式: /broker/ids/[0…N] –&gt;host:port;其中[0..N]表示broker id,每个broker的配置文件中都需要指定一个数字类型的id(全局不可重复),znode的值为此broker的host:port信息.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ zkCli -server k8s-n1:2181</span><br><span class="line">$ ls /brokers</span><br><span class="line">[ids, topics, seqid]</span><br><span class="line">$ ls /brokers/ids</span><br><span class="line">[0, 1, 2]</span><br><span class="line">$ get /brokers/ids/0</span><br><span class="line">&#123;&quot;listener_security_protocol_map&quot;:&#123;&quot;PLAINTEXT&quot;:&quot;PLAINTEXT&quot;&#125;,&quot;endpoints&quot;:[&quot;PLAINTEXT://k8s-n1:9092&quot;],&quot;jmx_port&quot;:-1,&quot;host&quot;:&quot;k8s-n1&quot;,&quot;timestamp&quot;:&quot;1556568752340&quot;,&quot;port&quot;:9092,&quot;version&quot;:4&#125;</span><br><span class="line">cZxid = 0xd0000003c</span><br><span class="line">ctime = Wed Apr 24 16:10:19 CST 2019</span><br><span class="line">mZxid = 0xd0000003c</span><br><span class="line">mtime = Wed Apr 24 16:10:19 CST 2019</span><br><span class="line">pZxid = 0xd0000003c</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 1</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x26a4e173fc40002</span><br><span class="line">dataLength = 182</span><br><span class="line">numChildren = 0</span><br></pre></td></tr></table></figure></li></ol></li></ol><p>2) Broker Topic Registry: 当一个broker启动时,会向zookeeper注册自己持有的topic和partitions信息,仍然是一个临时znode.<br>格式: /broker/topics/[topic]/[0…N] 其中[0..N]表示partition索引号.<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ls /brokers/topics</span><br><span class="line">[test, __consumer_offsets]</span><br></pre></td></tr></table></figure><p></p><p>__consumer_offsets 是消费端的offset<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ ls /brokers/topics/test</span><br><span class="line">[partitions] ##test的分区信息</span><br><span class="line">$ ls /brokers/topics/test/partitions</span><br><span class="line">[0]</span><br><span class="line">$ ls /brokers/topics/test/partitions/0</span><br><span class="line">[state]</span><br><span class="line">$ get /brokers/topics/test/partitions/0/state   </span><br><span class="line">&#123;&quot;controller_epoch&quot;:19,&quot;leader&quot;:0,&quot;version&quot;:1,&quot;leader_epoch&quot;:3,&quot;isr&quot;:[0]&#125;</span><br><span class="line">cZxid = 0x2000000b6</span><br><span class="line">ctime = Wed Apr 24 07:53:42 CST 2019</span><br><span class="line">mZxid = 0xd00000044</span><br><span class="line">mtime = Wed Apr 24 16:10:19 CST 2019</span><br><span class="line">pZxid = 0x2000000b6</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 3</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 73</span><br><span class="line">numChildren = 0</span><br></pre></td></tr></table></figure><p></p><p>3) Consumer and Consumer group: 每个consumer客户端被创建时,会向zookeeper注册自己的信息;此作用主要是为了”负载均衡”.<br>一个group中的多个consumer可以交错的消费一个topic的所有partitions;简而言之,保证此topic的所有partitions都能被此group所消费,且消费时为了性能考虑,让partition相对均衡的分散到每个consumer上.</p><p>4) Consumer id Registry: 每个consumer都有一个唯一的ID(host:uuid,可以通过配置文件指定,也可以由系统生成),此id用来标记消费者信息.<br>格式:/consumers/[group_id]/ids/[consumer_id]<br>仍然是一个临时的znode,此节点的值为{“topic_name”:#streams…},即表示此consumer目前所消费的topic + partitions列表.<br>启动消费者：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$  kafka-console-consumer.sh --bootstrap-server k8s-n2:9092 --topic test</span><br></pre></td></tr></table></figure><p></p><p>启动生成者：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-console-producer.sh --broker-list k8s-n1:9092 --topic test</span><br></pre></td></tr></table></figure><p></p><p>查看zookeeper信息：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ls /</span><br><span class="line">[cluster, controller_epoch, controller, brokers, zookeeper, admin, isr_change_notification, consumers, log_dir_event_notification, latest_producer_id_block, config]</span><br><span class="line">$ ls /consumers</span><br><span class="line">[]</span><br></pre></td></tr></table></figure><p></p><p>发现consummer下啥也没有？这是因为新版本的kafka，consumer中offset不是放在这个位置的，而是放在__consumer_offset 这个topic下的。那么该如何验证呢？<br>启动消费者：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$  kafka-console-consumer.sh --bootstrap-server k8s-n2:9092 --topic test</span><br></pre></td></tr></table></figure><p></p><p>启动生成者：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-console-producer.sh --broker-list k8s-n1:9092 --topic test</span><br></pre></td></tr></table></figure><p></p><p>验证消息生产成功<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list k8s-n1:9092 --topic mytest --time -1</span><br><span class="line">mytest:0:15</span><br><span class="line">mytest:1:16</span><br><span class="line">mytest:2:16</span><br><span class="line">mytest:3:15</span><br></pre></td></tr></table></figure><p></p><p>mytest topic 上 0号分区有15条消息。很好理解。<br>再创建一个消费者组<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-console-consumer.sh --bootstrap-server k8s-n1:9092 --topic mytest --from-beginning</span><br></pre></td></tr></table></figure><p></p><p>查询一下消费者组信息<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kafka-consumer-groups.sh --bootstrap-server k8s-n1:9092 --list</span><br><span class="line">console-consumer-24766</span><br><span class="line">console-consumer-52794</span><br></pre></td></tr></table></figure><p></p><p>查询一下topic里的内容：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-console-consumer.sh --topic __consumer_offsets --bootstrap-server k8s-n1:9092 --formatter &quot;kafka.coordinator.group.GroupMetadataManager\$OffsetsMessageFormatter&quot; --consumer.config config/consumer.properties --from-beginning</span><br></pre></td></tr></table></figure><p></p><p>结果：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> [console-consumer-52794,__consumer_offsets,12]::OffsetAndMetadata(offset=0, leaderEpoch=Optional.empty, metadata=, commitTimestamp=1556122524504, expireTimestamp=None)</span><br><span class="line">[console-consumer-52794,__consumer_offsets,45]::OffsetAndMetadata(offset=0, leaderEpoch=Optional.empty, metadata=, commitTimestamp=1556122524504, expireTimestamp=None)</span><br><span class="line">[console-consumer-52794,__consumer_offsets,1]::OffsetAndMetadata(offset=0, leaderEpoch=Optional.empty, metadata=, commitTimestamp=1556122524504, expireTimestamp=None)</span><br><span class="line">[console-consumer-52794,__consumer_offsets,5]::OffsetAndMetadata(offset=0, leaderEpoch=Optional.empty, metadata=, commitTimestamp=1556122524504, expireTimestamp=None)</span><br><span class="line">[console-consumer-52794,__consumer_offsets,26]::OffsetAndMetadata(offset=0, leaderEpoch=Optional.empty, metadata=, commitTimestamp=1556122524504, expireTimestamp=None)</span><br><span class="line">[console-consumer-52794,__consumer_offsets,29]::OffsetAndMetadata(offset=0, leaderEpoch=Optional.empty, metadata=, commitTimestamp=1556122524504, expireTimestamp=None)</span><br><span class="line">[console-consumer-52794,__consumer_offsets,34]::OffsetAndMetadata(offset=0, leaderEpoch=Optional.empty, metadata=, commitTimestamp=1556122524504, expireTimestamp=None)</span><br><span class="line">[console-consumer-52794,__consumer_offsets,10]::OffsetAndMetadata(offset=0, leaderEpoch=Optional.empty, metadata=, commitTimestamp=1556122524504, expireTimestamp=None)</span><br><span class="line">[console-consumer-52794,__consumer_offsets,32]::OffsetAndMetadata(offset=5, leaderEpoch=Optional.empty, metadata=, commitTimestamp=1556122524504, expireTimestamp=None)</span><br><span class="line">[console-consumer-52794,__consumer_offsets,40]::OffsetAndMetadata(offset=3, leaderEpoch=Optional.empty, metadata=, commitTimestamp=1556122524504, expireTimestamp=None)</span><br><span class="line">^CProcessed a total of 1674 messages</span><br></pre></td></tr></table></figure><p></p><p>参考了 <a href="http://www.cnblogs.com/huxi2b/p/6061110.html这篇blog的作法，但是我的版本是kafka_2.2.0里面并没有找offset的命令。" target="_blank" rel="noopener">http://www.cnblogs.com/huxi2b/p/6061110.html这篇blog的作法，但是我的版本是kafka_2.2.0里面并没有找offset的命令。</a></p><p>5) Consumer offset Tracking: 用来跟踪每个consumer目前所消费的partition中最大的offset.<br>格式:/consumers/[group_id]/offsets/[topic]/[broker_id-partition_id]–&gt;offset_value<br>此znode为持久节点,可以看出offset跟group_id有关,以表明当group中一个消费者失效,其他consumer可以继续消费.<br>6) Partition Owner registry: 用来标记partition被哪个consumer消费.临时znode<br>格式:/consumers/[group_id]/owners/[topic]/[broker_id-partition_id]–&gt;consumer_node_id当consumer启动时,所触发的操作:<br>A) 首先进行”Consumer id Registry”;<br>B) 然后在”Consumer id Registry”节点下注册一个watch用来监听当前group中其他consumer的”leave”和”join”;只要此znode path下节点列表变更,都会触发此group下consumer的负载均衡.(比如一个consumer失效,那么其他consumer接管partitions).<br>C) 在”Broker id registry”节点下,注册一个watch用来监听broker的存活情况;如果broker列表变更,将会触发所有的groups下的consumer重新balance.</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --&gt;&lt;h1 id=&quot;kafka是什么？&quot;&gt;&lt;a href=&quot;#kafka是什么？&quot; class=&quot;headerlink&quot; title=&quot;kafka是什么？
      
    
    </summary>
    
      <category term="消息队列" scheme="http://www.liuyong520.cn/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
    
      <category term="kafka" scheme="http://www.liuyong520.cn/tags/kafka/"/>
    
      <category term="linux" scheme="http://www.liuyong520.cn/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>Linux下kafka集群搭建</title>
    <link href="http://www.liuyong520.cn/2019/04/29/kafka-install/"/>
    <id>http://www.liuyong520.cn/2019/04/29/kafka-install/</id>
    <published>2019-04-29T02:56:51.000Z</published>
    <updated>2019-04-30T02:48:31.425Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><ol><li><p>zookeeper集群环境<br>kafka是依赖于zookeeper注册中心的一款分布式消息对列，所以需要有zookeeper单机或者集群环境。</p></li><li><p>三台服务器：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">172.16.18.198 k8s-n1</span><br><span class="line">172.16.18.199 k8s-n2</span><br><span class="line">172.16.18.200 k8s-n3</span><br></pre></td></tr></table></figure></li><li><p>下载kafka安装包</p></li></ol><p><a href="http://kafka.apache.org/downloads" target="_blank" rel="noopener">http://kafka.apache.org/downloads</a> 中下载，目前最新版本的kafka已经到2.2.0,我这里之前下载的是kafka_2.11-2.2.0.tgz.</p><h2 id="安装kafka集群"><a href="#安装kafka集群" class="headerlink" title="安装kafka集群"></a>安装kafka集群</h2><ol><li><p>上传压缩包到三台服务器解压缩到/opt/目录下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf kafka_2.11-2.2.0.tgz -C /opt/</span><br><span class="line">ls -s kafka_2.11-2.2.0 kafka</span><br></pre></td></tr></table></figure></li><li><p>修改 server.properties</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">############################# Server Basics #############################</span><br><span class="line"></span><br><span class="line"># The id of the broker. This must be set to a unique integer for each broker.</span><br><span class="line">broker.id=0</span><br><span class="line"></span><br><span class="line">############################# Socket Server Settings #############################</span><br><span class="line"></span><br><span class="line"># The address the socket server listens on. It will get the value returned from </span><br><span class="line"># java.net.InetAddress.getCanonicalHostName() if not configured.</span><br><span class="line">#   FORMAT:</span><br><span class="line">#     listeners = listener_name://host_name:port</span><br><span class="line">#   EXAMPLE:</span><br><span class="line">#     listeners = PLAINTEXT://your.host.name:9092</span><br><span class="line">listeners=PLAINTEXT://k8s-n1:9092</span><br><span class="line"></span><br><span class="line"># Hostname and port the broker will advertise to producers and consumers. If not set, </span><br><span class="line"># it uses the value for &quot;listeners&quot; if configured.  Otherwise, it will use the value</span><br><span class="line"># returned from java.net.InetAddress.getCanonicalHostName().</span><br><span class="line">advertised.listeners=PLAINTEXT://k8s-n1:9092</span><br><span class="line"></span><br><span class="line"># Maps listener names to security protocols, the default is for them to be the same. See the config documentation for more details</span><br><span class="line">#listener.security.protocol.map=PLAINTEXT:PLAINTEXT,SSL:SSL,SASL_PLAINTEXT:SASL_PLAINTEXT,SASL_SSL:SASL_SSL</span><br><span class="line"></span><br><span class="line"># The number of threads that the server uses for receiving requests from the network and sending responses to the network</span><br><span class="line">num.network.threads=3</span><br><span class="line"></span><br><span class="line"># The number of threads that the server uses for processing requests, which may include disk I/O</span><br><span class="line">num.io.threads=8</span><br><span class="line"></span><br><span class="line"># The send buffer (SO_SNDBUF) used by the socket server</span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line"></span><br><span class="line"># The receive buffer (SO_RCVBUF) used by the socket server</span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line"></span><br><span class="line"># The maximum size of a request that the socket server will accept (protection against OOM)</span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">############################# Log Basics #############################</span><br><span class="line"></span><br><span class="line"># A comma separated list of directories under which to store log files</span><br><span class="line">log.dirs=/var/applog/kafka/</span><br><span class="line"></span><br><span class="line"># The default number of log partitions per topic. More partitions allow greater</span><br><span class="line"># parallelism for consumption, but this will also result in more files across</span><br><span class="line"># the brokers.</span><br><span class="line">num.partitions=5</span><br><span class="line"></span><br><span class="line"># The number of threads per data directory to be used for log recovery at startup and flushing at shutdown.</span><br><span class="line"># This value is recommended to be increased for installations with data dirs located in RAID array.</span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line"></span><br><span class="line">############################# Internal Topic Settings  #############################</span><br><span class="line"># The replication factor for the group metadata internal topics &quot;__consumer_offsets&quot; and &quot;__transaction_state&quot;</span><br><span class="line"># For anything other than development testing, a value greater than 1 is recommended for to ensure availability such as 3.</span><br><span class="line">offsets.topic.replication.factor=1</span><br><span class="line">transaction.state.log.replication.factor=1</span><br><span class="line">transaction.state.log.min.isr=1</span><br><span class="line"></span><br><span class="line">############################# Log Flush Policy #############################</span><br><span class="line"></span><br><span class="line"># Messages are immediately written to the filesystem but by default we only fsync() to sync</span><br><span class="line"># the OS cache lazily. The following configurations control the flush of data to disk.</span><br><span class="line"># There are a few important trade-offs here:</span><br><span class="line">#    1. Durability: Unflushed data may be lost if you are not using replication.</span><br><span class="line">#    2. Latency: Very large flush intervals may lead to latency spikes when the flush does occur as there will be a lot of data to flush.</span><br><span class="line">#    3. Throughput: The flush is generally the most expensive operation, and a small flush interval may lead to excessive seeks.</span><br><span class="line"># The settings below allow one to configure the flush policy to flush data after a period of time or</span><br><span class="line"># every N messages (or both). This can be done globally and overridden on a per-topic basis.</span><br><span class="line"></span><br><span class="line"># The number of messages to accept before forcing a flush of data to disk</span><br><span class="line">log.flush.interval.messages=10000</span><br><span class="line"></span><br><span class="line"># The maximum amount of time a message can sit in a log before we force a flush</span><br><span class="line">log.flush.interval.ms=1000</span><br><span class="line"></span><br><span class="line">############################# Log Retention Policy #############################</span><br><span class="line"></span><br><span class="line"># The following configurations control the disposal of log segments. The policy can</span><br><span class="line"># be set to delete segments after a period of time, or after a given size has accumulated.</span><br><span class="line"># A segment will be deleted whenever *either* of these criteria are met. Deletion always happens</span><br><span class="line"># from the end of the log.</span><br><span class="line"></span><br><span class="line"># The minimum age of a log file to be eligible for deletion due to age</span><br><span class="line">log.retention.hours=24</span><br><span class="line"></span><br><span class="line"># A size-based retention policy for logs. Segments are pruned from the log unless the remaining</span><br><span class="line"># segments drop below log.retention.bytes. Functions independently of log.retention.hours.</span><br><span class="line">#log.retention.bytes=1073741824</span><br><span class="line"></span><br><span class="line"># The maximum size of a log segment file. When this size is reached a new log segment will be created.</span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line"></span><br><span class="line"># The interval at which log segments are checked to see if they can be deleted according</span><br><span class="line"># to the retention policies</span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line"></span><br><span class="line">############################# Zookeeper #############################</span><br><span class="line"></span><br><span class="line"># Zookeeper connection string (see zookeeper docs for details).</span><br><span class="line"># This is a comma separated host:port pairs, each corresponding to a zk</span><br><span class="line"># server. e.g. &quot;127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002&quot;.</span><br><span class="line"># You can also append an optional chroot string to the urls to specify the</span><br><span class="line"># root directory for all kafka znodes.</span><br><span class="line">zookeeper.connect=k8s-n1:2181,k8s-n2:2181,k8s-n3:2181</span><br><span class="line"></span><br><span class="line"># Timeout in ms for connecting to zookeeper</span><br><span class="line">zookeeper.connection.timeout.ms=6000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">############################# Group Coordinator Settings #############################</span><br><span class="line"></span><br><span class="line"># The following configuration specifies the time, in milliseconds, that the GroupCoordinator will delay the initial consumer rebalance.</span><br><span class="line"># The rebalance will be further delayed by the value of group.initial.rebalance.delay.ms as new members join the group, up to a maximum of max.poll.interval.ms.</span><br><span class="line"># The default value for this is 3 seconds.</span><br><span class="line"># We override this to 0 here as it makes for a better out-of-the-box experience for development and testing.</span><br><span class="line"># However, in production environments the default value of 3 seconds is more suitable as this will help to avoid unnecessary, and potentially expensive, rebalances during application startup.</span><br><span class="line">group.initial.rebalance.delay.ms=0</span><br><span class="line"></span><br><span class="line">delete.topic.enable=true</span><br></pre></td></tr></table></figure></li></ol><p>拷贝两份到k8s-n2,k8s-n3<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-n2 config]# cat server.properties </span><br><span class="line">broker.id=1</span><br><span class="line">listeners=PLAINTEXT://k8s-n2:9092</span><br><span class="line">advertised.listeners=PLAINTEXT://k8s-n2:9092</span><br><span class="line"></span><br><span class="line">[root@k8s-n3 config]# cat server.properties</span><br><span class="line">broker.id=2</span><br><span class="line">listeners=PLAINTEXT://k8s-n3:9092</span><br><span class="line">advertised.listeners=PLAINTEXT://k8s-n3:9092</span><br></pre></td></tr></table></figure><p></p><ol start="3"><li>添加环境变量 在/etc/profile 中添加</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export ZOOKEEPER_HOME=/opt/kafka_2.11-2.2.0</span><br><span class="line">export PATH=$PATH:$ZOOKEEPER_HOME/bin</span><br></pre></td></tr></table></figure><p>source /etc/profile 重载生效</p><ol start="4"><li>启动kafka<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-server-start.sh config/server.properties &amp;</span><br></pre></td></tr></table></figure></li></ol><h3 id="Zookeeper-Kafka集群测试"><a href="#Zookeeper-Kafka集群测试" class="headerlink" title="Zookeeper+Kafka集群测试"></a>Zookeeper+Kafka集群测试</h3><ol><li><p>创建topic:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-topics.sh --create --zookeeper k8s-n1:2181, k8s-n2:2181, k8s-n3:2181 --replication-factor 3 --partitions 3 --topic test</span><br></pre></td></tr></table></figure></li><li><p>显示topic</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-topics.sh --describe --zookeeper k8s-n1:2181, k8s-n2:2181, k8s-n3:2181 --topic test</span><br></pre></td></tr></table></figure></li><li><p>列出topic</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kafka-topics.sh --list --zookeeper k8s-n1:2181, k8s-n2:2181, k8s-n3:2181</span><br><span class="line">test</span><br></pre></td></tr></table></figure></li></ol><p>创建 producer(生产者);<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kafka-console-producer.sh --broker-list k8s-n1:9092 --topic test</span><br><span class="line">hello</span><br></pre></td></tr></table></figure><p></p><p>创建 consumer（消费者）<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kafka-console-consumer.sh --bootstrap-server k8s-n1:9092 --topic test --from-beginning</span><br><span class="line">hello</span><br></pre></td></tr></table></figure><p></p><p>至此，kafka集群搭建就已经完成了。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --&gt;&lt;h2 id=&quot;环境准备&quot;&gt;&lt;a href=&quot;#环境准备&quot; class=&quot;headerlink&quot; title=&quot;环境准备&quot;&gt;&lt;/a&gt;环境准备&lt;/h2&gt;
      
    
    </summary>
    
      <category term="消息队列" scheme="http://www.liuyong520.cn/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
    
      <category term="kafka" scheme="http://www.liuyong520.cn/tags/kafka/"/>
    
      <category term="linux" scheme="http://www.liuyong520.cn/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>hexo博客主题优化</title>
    <link href="http://www.liuyong520.cn/2017/08/29/hexo-promise/"/>
    <id>http://www.liuyong520.cn/2017/08/29/hexo-promise/</id>
    <published>2017-08-29T02:56:51.000Z</published>
    <updated>2019-04-28T08:58:06.799Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --><p>在介绍博客主题优化这个话题之前，我想先介绍hexo主题的大体结构，便于后面将主题优化方面的东西。</p><h2 id="hexo主题结构"><a href="#hexo主题结构" class="headerlink" title="hexo主题结构"></a>hexo主题结构</h2><p>我这里选用pure主题为例进行讲解。</p><ol><li>进入themes/pure文件夹下执行如下命令<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">├── LICENSE</span><br><span class="line">├── README.cn.md</span><br><span class="line">├── README.md</span><br><span class="line">├── _config.yml #主题主配置文件</span><br><span class="line">├── _config.yml.example #主题配置文件例子</span><br><span class="line">├── _source #博客页面例子文件夹</span><br><span class="line">│   ├── 404 #博客404页面只要拷贝到站点soure就行</span><br><span class="line">│   │   └── index.md</span><br><span class="line">│   ├── _data #博客友情链接页面</span><br><span class="line">│   │   ├── gallery.yml</span><br><span class="line">│   │   └── links.yml</span><br><span class="line">│   ├── about #博客关于页面</span><br><span class="line">│   │   └── index.md</span><br><span class="line">│   ├── books #博客书单页面</span><br><span class="line">│   │   └── index.md</span><br><span class="line">│   ├── categories #博客分类页面</span><br><span class="line">│   │   └── index.md</span><br><span class="line">│   ├── links #博客友情链接</span><br><span class="line">│   │   └── index.md</span><br><span class="line">│   ├── repository #博客仓库模版页面</span><br><span class="line">│   │   └── index.md</span><br><span class="line">│   └── tags #博客标签页面</span><br><span class="line">│       └── index.md</span><br><span class="line">├── languages #博客语言切换配置文件夹</span><br><span class="line">│   ├── default.yml</span><br><span class="line">│   ├── en.yml</span><br><span class="line">│   ├── zh-CN.yml</span><br><span class="line">│   └── zh-TW.yml</span><br><span class="line">├── layout #博客布局文件夹 这里就是生成页面的精华部分了</span><br><span class="line">│   ├── _common</span><br><span class="line">│   │   ├── footer.ejs</span><br><span class="line">│   │   ├── head.ejs</span><br><span class="line">│   │   ├── header.ejs</span><br><span class="line">│   │   ├── script.ejs</span><br><span class="line">│   │   └── social.ejs</span><br><span class="line">│   ├── _partial</span><br><span class="line">│   │   ├── archive-book.ejs</span><br><span class="line">│   │   ├── archive-category.ejs</span><br><span class="line">│   │   ├── archive-link.ejs</span><br><span class="line">│   │   ├── archive-list.ejs</span><br><span class="line">│   │   ├── archive-post.ejs</span><br><span class="line">│   │   ├── archive-repository.ejs</span><br><span class="line">│   │   ├── archive-tag.ejs</span><br><span class="line">│   │   ├── archive.ejs</span><br><span class="line">│   │   ├── article-about.ejs</span><br><span class="line">│   │   ├── article.ejs</span><br><span class="line">│   │   ├── item-post.ejs</span><br><span class="line">│   │   ├── pagination.ejs</span><br><span class="line">│   │   ├── post</span><br><span class="line">│   │   │   ├── category.ejs</span><br><span class="line">│   │   │   ├── comment.ejs</span><br><span class="line">│   │   │   ├── copyright.ejs</span><br><span class="line">│   │   │   ├── date.ejs</span><br><span class="line">│   │   │   ├── donate.ejs</span><br><span class="line">│   │   │   ├── gallery.ejs</span><br><span class="line">│   │   │   ├── nav.ejs</span><br><span class="line">│   │   │   ├── pv.ejs</span><br><span class="line">│   │   │   ├── tag.ejs</span><br><span class="line">│   │   │   ├── thumbnail.ejs</span><br><span class="line">│   │   │   ├── title.ejs</span><br><span class="line">│   │   │   └── wordcount.ejs</span><br><span class="line">│   │   ├── sidebar-about.ejs</span><br><span class="line">│   │   ├── sidebar-toc.ejs</span><br><span class="line">│   │   └── sidebar.ejs</span><br><span class="line">│   ├── _script</span><br><span class="line">│   │   ├── _analytics</span><br><span class="line">│   │   │   ├── baidu-analytics.ejs</span><br><span class="line">│   │   │   ├── google-analytics.ejs</span><br><span class="line">│   │   │   └── tencent-analytics.ejs</span><br><span class="line">│   │   ├── _comment</span><br><span class="line">│   │   │   ├── disqus.ejs</span><br><span class="line">│   │   │   ├── gitalk.ejs</span><br><span class="line">│   │   │   ├── gitment.ejs</span><br><span class="line">│   │   │   ├── livere.ejs</span><br><span class="line">│   │   │   ├── valine.ejs</span><br><span class="line">│   │   │   └── youyan.ejs</span><br><span class="line">│   │   ├── _search</span><br><span class="line">│   │   │   ├── baidu.ejs</span><br><span class="line">│   │   │   └── insight.ejs</span><br><span class="line">│   │   ├── analytics.ejs</span><br><span class="line">│   │   ├── comment.ejs</span><br><span class="line">│   │   ├── douban.ejs</span><br><span class="line">│   │   ├── fancybox.ejs</span><br><span class="line">│   │   ├── mathjax.ejs</span><br><span class="line">│   │   ├── pv.ejs</span><br><span class="line">│   │   ├── repository.ejs</span><br><span class="line">│   │   └── search.ejs</span><br><span class="line">│   ├── _search</span><br><span class="line">│   │   ├── baidu.ejs</span><br><span class="line">│   │   ├── index-mobile.ejs</span><br><span class="line">│   │   ├── index.ejs</span><br><span class="line">│   │   ├── insight.ejs</span><br><span class="line">│   │   └── swiftype.ejs</span><br><span class="line">│   ├── _widget</span><br><span class="line">│   │   ├── archive.ejs</span><br><span class="line">│   │   ├── board.ejs</span><br><span class="line">│   │   ├── category.ejs</span><br><span class="line">│   │   ├── recent_posts.ejs</span><br><span class="line">│   │   ├── tag.ejs</span><br><span class="line">│   │   └── tagcloud.ejs</span><br><span class="line">│   ├── about.ejs</span><br><span class="line">│   ├── archive.ejs</span><br><span class="line">│   ├── books.ejs</span><br><span class="line">│   ├── categories.ejs</span><br><span class="line">│   ├── category.ejs</span><br><span class="line">│   ├── index.ejs</span><br><span class="line">│   ├── layout.ejs</span><br><span class="line">│   ├── links.ejs</span><br><span class="line">│   ├── page.ejs</span><br><span class="line">│   ├── post.ejs</span><br><span class="line">│   ├── repository.ejs</span><br><span class="line">│   ├── tag.ejs</span><br><span class="line">│   └── tags.ejs</span><br><span class="line">├── package.json</span><br><span class="line">├── screenshot #主题颜色切换背景</span><br><span class="line">│   ├── pure-theme-black.png</span><br><span class="line">│   ├── pure-theme-blue.png</span><br><span class="line">│   ├── pure-theme-green.png</span><br><span class="line">│   ├── pure-theme-purple.png</span><br><span class="line">│   ├── pure.png</span><br><span class="line">│   └── pure.psd</span><br><span class="line">├── scripts</span><br><span class="line">│   └── thumbnail.js</span><br><span class="line">└── source #主题静态资源文件目录</span><br><span class="line">    ├── css</span><br><span class="line">    │   ├── style.css</span><br><span class="line">    │   └── style.min.css</span><br><span class="line">    ├── favicon.png</span><br><span class="line">    ├── fonts</span><br><span class="line">    │   ├── README.md</span><br><span class="line">    │   ├── iconfont.eot</span><br><span class="line">    │   ├── iconfont.svg</span><br><span class="line">    │   ├── iconfont.ttf</span><br><span class="line">    │   └── iconfont.woff</span><br><span class="line">    ├── images</span><br><span class="line">    │   ├── avatar.jpg</span><br><span class="line">    │   ├── avatar.jpg1</span><br><span class="line">    │   ├── donate</span><br><span class="line">    │   │   ├── alipayimg.png</span><br><span class="line">    │   │   └── wechatpayimg.png</span><br><span class="line">    │   ├── favatar</span><br><span class="line">    │   │   ├── SzsFox-logo.png</span><br><span class="line">    │   │   ├── chuangzaoshi-logo.png</span><br><span class="line">    │   │   └── idesign-logo.png</span><br><span class="line">    │   ├── thumb-default.png</span><br><span class="line">    │   └── xingqiu-qrcode.jpg</span><br><span class="line">    └── js</span><br><span class="line">        ├── application.js</span><br><span class="line">        ├── application.min.js</span><br><span class="line">        ├── insight.js</span><br><span class="line">        ├── jquery.min.js</span><br><span class="line">        ├── plugin.js</span><br><span class="line">        ├── plugin.js.map</span><br><span class="line">        └── plugin.min.js</span><br><span class="line"></span><br><span class="line">29 directories, 125 files</span><br></pre></td></tr></table></figure></li></ol><p>layout里面的文件使用ejs （js模版语言）<a href="https://ejs.bootcss.com/" target="_blank" rel="noopener">ejs官网</a>实现的，里面把整个页面通过js抽取各个小的模块模版文件，同时数据和标签页面是分离的，所以在页面里面可以加载config.yml 里面的配置。</p><p>整个页面入口文件就是layout.js<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&lt;%= config.language ? &quot; lang=&quot; + config.language.substring(0, 2) : &quot;&quot;%&gt;&gt;</span><br><span class="line">&lt;%- partial(&apos;_common/head&apos;, &#123;post: page&#125;) %&gt;</span><br><span class="line">##这里会判断是否启用layout配置</span><br><span class="line">&lt;% </span><br><span class="line">var bodyClass = &apos;main-center&apos;; </span><br><span class="line">if (theme.config.layout) &#123;</span><br><span class="line">bodyClass = theme.config.layout;</span><br><span class="line">&#125;</span><br><span class="line">  if (theme.config.skin) &#123;</span><br><span class="line">    bodyClass += &apos; &apos; + theme.config.skin;</span><br><span class="line">  &#125;</span><br><span class="line">bodyClass = page.sidebar === &apos;none&apos; ? (bodyClass + &apos; no-sidebar&apos;) : bodyClass;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;body class=&quot;&lt;%= bodyClass %&gt;&quot; itemscope itemtype=&quot;http://schema.org/WebPage&quot;&gt;</span><br><span class="line">  &lt;%- partial(&apos;_common/header&apos;, null, &#123;cache: !config.relative_link&#125;) %&gt;</span><br><span class="line">  &lt;% if (theme.sidebar &amp;&amp; (page.sidebar!=&apos;none&apos; || page.sidebar!=&apos;custom&apos;))&#123; %&gt;</span><br><span class="line">    &lt;% if (theme.config.toc &amp;&amp; page.toc)&#123; %&gt;</span><br><span class="line">    &lt;%- partial(&apos;_partial/sidebar-toc&apos;, &#123;post: page&#125;) %&gt;</span><br><span class="line">    &lt;% &#125;else&#123; %&gt;</span><br><span class="line">    &lt;%- partial(&apos;_partial/sidebar&apos;, null, &#123;cache: !config.relative_link&#125;) %&gt;</span><br><span class="line">    &lt;% &#125; %&gt;</span><br><span class="line">  &lt;% &#125; %&gt;</span><br><span class="line">  &lt;%- body %&gt;</span><br><span class="line">  &lt;%- partial(&apos;_common/footer&apos;, null, &#123;cache: !config.relative_link&#125;) %&gt;</span><br><span class="line">  &lt;%- partial(&apos;_common/script&apos;, &#123;post: page&#125;) %&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p></p><p>其中&lt;%- partial(‘_common/footer’, null, {cache: !config.relative_link}) %&gt; 表示引入子模块_common/footer.ejs文件，{cache: !config.relative_link}表示参数<br>我们的创建的博客文章都会加载这个布局文件。</p><ol start="2"><li><p>我们新创建的博客文章有如下的配置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">title: 文章标题</span><br><span class="line">categories:</span><br><span class="line">  - 文章分类</span><br><span class="line">tags:</span><br><span class="line">  - 文章标签</span><br><span class="line">toc: true # 是否启用内容索引</span><br><span class="line">comment:true #是否启用评论</span><br><span class="line">layout:模版文件，如果没有默认不加载任何模版</span><br><span class="line">sidebar: none # 是否启用sidebar侧边栏，none：不启用，不配置默认启动</span><br></pre></td></tr></table></figure><p>以上配置属于page 域的配置文件属于单个页面的，而config.language 这种是全局配置文件（也就是站点配置文件config.yml），每个页面都能使用。theme.config 加载的就是主题的配置文件config.yml 文件。</p><ol start="3"><li>主题配置文件config.yml<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line"> # menu</span><br><span class="line">menu:</span><br><span class="line">  Home: .</span><br><span class="line">  Archives: archives  # 归档</span><br><span class="line">  Categories: categories  # 分类</span><br><span class="line">  Tags: tags  # 标签</span><br><span class="line">  Repository: repository  # github repositories</span><br><span class="line">  Books: books  # 豆瓣书单</span><br><span class="line">  Links: links  # 友链</span><br><span class="line">  About: about  # 关于</span><br><span class="line"></span><br><span class="line"># Enable/Disable menu icons</span><br><span class="line">menu_icons:</span><br><span class="line">  enable: true  # 是否启用导航菜单图标</span><br><span class="line">  home: icon-home-fill</span><br><span class="line">  archives: icon-archives-fill</span><br><span class="line">  categories: icon-folder</span><br><span class="line">  tags: icon-tags</span><br><span class="line">  repository: icon-project</span><br><span class="line">  books: icon-book-fill</span><br><span class="line">  links: icon-friendship</span><br><span class="line">  about: icon-cup-fill</span><br><span class="line"></span><br><span class="line"># rss</span><br><span class="line">rss: /atom.xml</span><br><span class="line"></span><br><span class="line"># Site</span><br><span class="line">site:</span><br><span class="line">  logo:</span><br><span class="line">    enabled: true</span><br><span class="line">    width: 40</span><br><span class="line">    height: 40</span><br><span class="line">    url: ../images/logo.png</span><br><span class="line">  title: Hexo # 页面title</span><br><span class="line">  favicon: /favicon.png</span><br><span class="line">  board: &lt;p&gt;欢迎交流与分享经验!&lt;/p&gt; # 站点公告</span><br><span class="line">  copyright: false # 底部版权信息</span><br><span class="line"></span><br><span class="line"># config</span><br><span class="line">config:</span><br><span class="line">  skin: theme-black # 主题颜色 theme-black theme-blue theme-green theme-purple</span><br><span class="line">  layout: main-center # 布局方式 main-left main-center main-right</span><br><span class="line">  toc: true # 是否开启文章章节目录导航</span><br><span class="line">  menu_highlight: false # 是否开启当前菜单高亮显示</span><br><span class="line">  thumbnail: false # enable posts thumbnail, options: true, false</span><br><span class="line">  excerpt_link: Read More</span><br><span class="line"></span><br><span class="line"># Pagination 分页</span><br><span class="line">pagination:</span><br><span class="line">  number: false #是否开启数字</span><br><span class="line">  prev: </span><br><span class="line">    alwayShow: true</span><br><span class="line">  next:</span><br><span class="line">    alwayShow: true</span><br><span class="line"></span><br><span class="line"># Sidebar</span><br><span class="line">sidebar: right</span><br><span class="line">widgets:</span><br><span class="line">  - board  </span><br><span class="line">  - category</span><br><span class="line">  - tag</span><br><span class="line">  - tagcloud</span><br><span class="line">  - archive</span><br><span class="line">  - recent_posts</span><br><span class="line"></span><br><span class="line"># display widgets at the bottom of index pages (pagination == 2)</span><br><span class="line">index_widgets:</span><br><span class="line"># - category</span><br><span class="line"># - tagcloud</span><br><span class="line"># - archive  </span><br><span class="line"></span><br><span class="line"># widget behavior</span><br><span class="line">archive_type: &apos;monthly&apos;</span><br><span class="line">show_count: true</span><br><span class="line"></span><br><span class="line"># Fancybox</span><br><span class="line">fancybox: false</span><br><span class="line"></span><br><span class="line"># Search</span><br><span class="line">search:</span><br><span class="line">  insight: true # you need to install `hexo-generator-json-content` before using Insight Search</span><br><span class="line">  baidu: false # you need to disable other search engines to use Baidu search, options: true, false</span><br><span class="line"></span><br><span class="line"># Donate</span><br><span class="line">donate:</span><br><span class="line">  enable: true</span><br><span class="line">  # 微信打赏</span><br><span class="line">  wechatpay:</span><br><span class="line">    qrcode: images/donate/wechatpayimg.png</span><br><span class="line">    title: 微信支付</span><br><span class="line">  # 支付宝打赏</span><br><span class="line">  alipay: </span><br><span class="line">    qrcode: images/donate/alipayimg.png </span><br><span class="line">    title: 支付宝</span><br><span class="line"></span><br><span class="line"># Share</span><br><span class="line"># weibo,qq,qzone,wechat,tencent,douban,diandian,facebook,twitter,google,linkedin</span><br><span class="line">share:</span><br><span class="line">  enable: true  # 是否启用分享</span><br><span class="line">  sites: weibo,qq,wechat,facebook,twitter  # PC端显示的分享图标</span><br><span class="line">  mobile_sites: weibo,qq,qzone  # 移动端显示的分享图标</span><br><span class="line"></span><br><span class="line"># Github</span><br><span class="line">github: </span><br><span class="line">  username: ***</span><br><span class="line"></span><br><span class="line"># Comment</span><br><span class="line"># Gitment</span><br><span class="line"># Introduction: https://imsun.net/posts/gitment-introduction/</span><br><span class="line">comment:</span><br><span class="line">  type: youyan</span><br><span class="line">  disqus: # enter disqus shortname here</span><br><span class="line">  youyan: </span><br><span class="line">    uid: 1783844 # enter youyan uid </span><br><span class="line">  livere:</span><br><span class="line">    uid: # enter youyan uid </span><br><span class="line">  gitment:</span><br><span class="line">    githubID: </span><br><span class="line">    repo: </span><br><span class="line">    ClientID: </span><br><span class="line">    ClientSecret: </span><br><span class="line">    lazy: false</span><br><span class="line">  gitalk: # gitalk. https://gitalk.github.io/</span><br><span class="line">    owner:  #必须. GitHub repository 所有者，可以是个人或者组织。</span><br><span class="line">    admin:  #必须. GitHub repository 的所有者和合作者 (对这个 repository 有写权限的用户)。</span><br><span class="line">    repo:  #必须. GitHub repository.</span><br><span class="line">    ClientID:  #必须. GitHub Application Client ID.</span><br><span class="line">    ClientSecret:  #必须. GitHub Application Client Secret.</span><br><span class="line">  valine: # Valine. https://valine.js.org</span><br><span class="line">    appid:  # your leancloud application appid</span><br><span class="line">    appkey:  # your leancloud application appkey</span><br><span class="line">    notify: false # mail notifier , https://github.com/xCss/Valine/wiki</span><br><span class="line">    verify: false # Verification code</span><br><span class="line">    placeholder: Just go go # comment box placeholder</span><br><span class="line">    avatar: mm # gravatar style</span><br><span class="line">    meta: nick,mail,link # custom comment header</span><br><span class="line">    pageSize: 10 # pagination size</span><br><span class="line">    visitor: false # Article reading statistic https://valine.js.org/visitor.html</span><br><span class="line"></span><br><span class="line"># douban 豆瓣书单</span><br><span class="line"># Api：</span><br><span class="line">  # https://developers.douban.com/wiki/?title=book_v2 图书</span><br><span class="line">  # https://developers.douban.com/wiki/?title=movie_v2 电影</span><br><span class="line"># books：  </span><br><span class="line">  # https://api.douban.com/v2/book/user/:name/collections?start=0&amp;count=100 个人书单列表</span><br><span class="line"># movies: </span><br><span class="line">  # https://api.douban.com/v2/movie/in_theaters 正在上映的电影</span><br><span class="line">  # https://api.douban.com/v2/movie/coming_soon 即将上映的电影</span><br><span class="line">  # https://api.douban.com/v2/movie/subject/:id 单个电影信息</span><br><span class="line">  # https://api.douban.com/v2/movie/search?q=&#123;text&#125; 电影搜索</span><br><span class="line">douban:</span><br><span class="line">  user: # 豆瓣用户名</span><br><span class="line">  start: 0 # 从哪一条记录开始</span><br><span class="line">  count: 100 # 获取豆瓣书单数据条数</span><br><span class="line">  </span><br><span class="line"># PV</span><br><span class="line">pv:</span><br><span class="line">  busuanzi:</span><br><span class="line">    enable: false  # 不蒜子统计</span><br><span class="line">  leancloud:</span><br><span class="line">    enable: false  # leancloud统计</span><br><span class="line">    app_id: # leancloud &lt;AppID&gt;</span><br><span class="line">    app_key: # leancloud &lt;AppKey&gt;</span><br><span class="line">        </span><br><span class="line"># wordcount</span><br><span class="line">postCount:</span><br><span class="line">  enable: false</span><br><span class="line">  wordcount: true  # 文章字数统计</span><br><span class="line">  min2read: true  # 阅读时长预计 </span><br><span class="line"></span><br><span class="line"># Plugins</span><br><span class="line">plugins:</span><br><span class="line">  google_analytics: # enter the tracking ID for your Google Analytics</span><br><span class="line">  google_site_verification: # enter Google site verification code</span><br><span class="line">  baidu_analytics: # enter Baidu Analytics hash key</span><br><span class="line">  tencent_analytics: </span><br><span class="line">  </span><br><span class="line"># Miscellaneous</span><br><span class="line">twitter:</span><br><span class="line">google_plus:</span><br><span class="line">fb_admins:</span><br><span class="line">fb_app_id:  </span><br><span class="line">  </span><br><span class="line"># profile</span><br><span class="line">profile:</span><br><span class="line">  enabled: true # Whether to show profile bar</span><br><span class="line">  avatar: images/avatar.jpg</span><br><span class="line">  gravatar: # Gravatar email address, if you enable Gravatar, your avatar config will be overriden</span><br><span class="line">  author: 昵称</span><br><span class="line">  author_title: Web Developer &amp; Designer</span><br><span class="line">  author_description: 个人简介。</span><br><span class="line">  location: Shenzhen, China</span><br><span class="line">  follow: https://github.com/cofess</span><br><span class="line">  # Social Links</span><br><span class="line">  social:</span><br><span class="line">    links:</span><br><span class="line">      github: https://github.com/cofess</span><br><span class="line">      weibo: http://weibo.com/cofess</span><br><span class="line">      twitter: https://twitter.com/iwebued</span><br><span class="line">      # facebook: /</span><br><span class="line">      # dribbble: /</span><br><span class="line">      behance: https://www.behance.net/cofess</span><br><span class="line">      rss: atom.xml</span><br><span class="line">    link_tooltip: true # enable the social link tooltip, options: true, false</span><br><span class="line">  # My Skills </span><br><span class="line">  skills:</span><br><span class="line">    Git: ★★★☆☆</span><br><span class="line">    Gulp: ★★★☆☆</span><br><span class="line">    Javascript: ★★★☆☆</span><br><span class="line">    HTML+CSS: ★★★☆☆</span><br><span class="line">    Bootstrap: ★★★☆☆</span><br><span class="line">    ThinkPHP: ★★★☆☆</span><br><span class="line">    平面设计: ★★★☆☆</span><br><span class="line">  # My Personal Links</span><br><span class="line">  links:</span><br><span class="line">    Github: https://github.com/cofess</span><br><span class="line">    Blog: http://blog.cofess.com</span><br><span class="line">    微博: http://weibo.com/cofess</span><br><span class="line">    花瓣: http://huaban.com/cofess</span><br><span class="line">    Behance: https://www.behance.net/cofess</span><br><span class="line">  # My Personal Labels</span><br><span class="line">  labels:</span><br><span class="line">    - 前端</span><br><span class="line">    - 前端开发</span><br><span class="line">    - 前端重构</span><br><span class="line">    - Web前端</span><br><span class="line">    - 网页重构</span><br><span class="line">  # My Personal Works</span><br><span class="line">  works:</span><br><span class="line">    name:</span><br><span class="line">      link: http://www.example.com</span><br><span class="line">      date: 2016</span><br><span class="line">  # My Personal Projects</span><br><span class="line">  projects:</span><br><span class="line">    cofess/gulp-startpro: https://github.com/cofess/gulp-startpro</span><br><span class="line">    cofess/hexo-theme-pure: https://github.com/cofess/hexo-theme-pure</span><br></pre></td></tr></table></figure></li></ol><p>基本上每个配置做什么用的，配置文件里面基本写了注解。也很容易理解。<br>如果还不是很能理解配置项。可以查看<a href="https://github.com/cofess/hexo-theme-pure/blob/master/README.cn.md" target="_blank" rel="noopener">https://github.com/cofess/hexo-theme-pure/blob/master/README.cn.md</a> 文件。<br>至此，hexo模版的大体结构已经清楚了。</p><h3 id="主题优化"><a href="#主题优化" class="headerlink" title="主题优化"></a>主题优化</h3><h4 id="修改主题"><a href="#修改主题" class="headerlink" title="修改主题"></a>修改主题</h4><p>在config.yml 文件中修改</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> # Extensions</span><br><span class="line">## Plugins: https://hexo.io/plugins/</span><br><span class="line">## Themes: https://hexo.io/themes/</span><br><span class="line">theme: pure</span><br></pre></td></tr></table></figure></li></ol><h4 id="修改语言"><a href="#修改语言" class="headerlink" title="修改语言"></a>修改语言</h4><p>在config.yml 文件中修改<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Site</span><br><span class="line">language: zh-CN #修改成中文</span><br></pre></td></tr></table></figure><p></p><h4 id="添加Rss订阅"><a href="#添加Rss订阅" class="headerlink" title="添加Rss订阅"></a>添加Rss订阅</h4><ol><li><p>安装feed插件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-generator-feed --save</span><br></pre></td></tr></table></figure></li><li><p>在config.yml添加</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> # Extensions</span><br><span class="line">## Plugins: https://hexo.io/plugins/</span><br><span class="line">#RSS订阅</span><br><span class="line">plugin:</span><br><span class="line">- hexo-generator-feed</span><br></pre></td></tr></table></figure></li><li><p>设置feed插件参数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> #Feed Atom</span><br><span class="line">feed:</span><br><span class="line">  type: atom</span><br><span class="line">  path: atom.xml</span><br><span class="line">  limit: 20</span><br></pre></td></tr></table></figure></li><li><p>生成预览</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo g</span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure><p>预览下就是如下<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556433596798.png" alt="rss订阅"></p><h4 id="添加站点地图"><a href="#添加站点地图" class="headerlink" title="添加站点地图"></a>添加站点地图</h4><p>站点地图是一种文件，您可以通过该文件列出您网站上的网页，从而将您网站内容的组织架构告知Google和其他搜索引擎。Googlebot等搜索引擎网页抓取工具会读取此文件，以便更加智能地抓取您的网站</p><ol><li>分别安装百度和google插件<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-generator-sitemap --save</span><br><span class="line">npm install hexo-generator-baidu-sitemap --save</span><br></pre></td></tr></table></figure></li></ol></li></ol><ol start="2"><li><p>在博客目录的_config.yml中添加如下代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 自动生成sitemap</span><br><span class="line">sitemap:</span><br><span class="line">path: sitemap.xml</span><br><span class="line">baidusitemap:</span><br><span class="line">path: baidusitemap.xml</span><br></pre></td></tr></table></figure></li><li><p>编译你的博客</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo g</span><br><span class="line">hexo s</span><br></pre></td></tr></table></figure></li></ol><p>如果你在你的博客根目录的public下面发现生成了sitemap.xml以及baidusitemap.xml就表示成功了,在本地访问 <a href="http://127.0.0.4000/sitemap.xml" target="_blank" rel="noopener">http://127.0.0.4000/sitemap.xml</a> 和 <a href="http://127.0.0.4000/baidusitemap.xml" target="_blank" rel="noopener">http://127.0.0.4000/baidusitemap.xml</a> 就能正确的展示出两个sitemap 文件了。</p><ol start="4"><li>注册百度站长平台<br>4.1 访问：<a href="https://ziyuan.baidu.com/linksubmit/index" target="_blank" rel="noopener">https://ziyuan.baidu.com/linksubmit/index</a><br>4.2 提交链接<br>提交链接方式有主动推送、自动推送、sitemap、手动上传等。<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556435172481.png" alt="enter description here"><br>4.3主动推送<br>安装对应提交插件<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-baidu-url-submit --save</span><br></pre></td></tr></table></figure></li></ol><p>修改配置：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">##配置插件</span><br><span class="line">plugin:</span><br><span class="line">- hexo-generator-baidu-sitemap</span><br><span class="line">- hexo-generator-sitemap</span><br><span class="line">- hexo-baidu-url-submit</span><br><span class="line"></span><br><span class="line">baidu_url_submit:</span><br><span class="line">  ## 比如3，代表提交最新的三个链接</span><br><span class="line">  count: 3</span><br><span class="line">  # 在百度站长平台中注册的域名</span><br><span class="line">  host: www.liuyong520.cn </span><br><span class="line">  ## 请注意这是您的秘钥， 请不要发布在公众仓库里!</span><br><span class="line">  token: upR0BjzCYxTC2CPq </span><br><span class="line">  ## 文本文档的地址， 新链接会保存在此文本文档里</span><br><span class="line">  path: baidu_urls.txt</span><br></pre></td></tr></table></figure><p></p><p>编译博客<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo g</span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure><p></p><p>如果出现下图即表示成功了<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556435593425.png" alt="enter description here"></p><p>4.4 自动推送<br>将如下代码添加到head.ejs中即可生效<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">   (function()&#123;</span><br><span class="line">       var bp = document.createElement(&apos;script&apos;);</span><br><span class="line">       var curProtocol = window.location.protocol.split(&apos;:&apos;)[0];</span><br><span class="line">       if (curProtocol === &apos;https&apos;) &#123;</span><br><span class="line">           bp.src = &apos;https://zz.bdstatic.com/linksubmit/push.js&apos;;        </span><br><span class="line">       &#125;</span><br><span class="line">       else &#123;</span><br><span class="line">           bp.src = &apos;http://push.zhanzhang.baidu.com/push.js&apos;;</span><br><span class="line">       &#125;</span><br><span class="line">       var s = document.getElementsByTagName(&quot;script&quot;)[0];</span><br><span class="line">       s.parentNode.insertBefore(bp, s);</span><br><span class="line">   &#125;)();</span><br><span class="line"> &lt;/script&gt;</span><br></pre></td></tr></table></figure><p></p><p>4.5 sitemap 提交方式<br>打开百度站长平台，点击sitemap，填入我们的sitemap文件路径：&lt;域名&gt;/&lt;sitemap名字&gt;如下<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556435919259.png" alt="sitemap"><br>提交即可.<br>但是此时你的域名其实并没有被百度站长所收录：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556436053972.png" alt="enter description here"><br>百度依然检索不到你的网站，需要10多个工作日之后才能审核通过。</p><ol start="5"><li><p>绑定站点到熊掌ID，这样熊掌ID站点管理里面就能看到相关站点数据了<br>登录站长平台，注册熊掌ID，提交审核过后<br>点击站点收录：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556436351784.png" alt="enter description here"><br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556436435701.png" alt="enter description here"></p><h4 id="静态资源压缩"><a href="#静态资源压缩" class="headerlink" title="静态资源压缩"></a>静态资源压缩</h4><p>hexo 的文章是通过md格式的文件经过swig转换成的html，生成的html会有很多空格，而且自己写的js以及css中会有很多的空格和注释。<br>js和java不一样，注释也会影响一部分的性能，空格同样是的。<br>静态资源压缩也有多种手段：有gulp插件和hexo自带的neat插件。</p><h5 id="1-hexo-neat-插件："><a href="#1-hexo-neat-插件：" class="headerlink" title="1.hexo-neat 插件："></a>1.hexo-neat 插件：</h5></li><li><p>安装hexo-neat插件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-neat --save</span><br></pre></td></tr></table></figure></li><li><p>修改站点配置文件_config.yml：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> # hexo-neat</span><br><span class="line"># 博文压缩</span><br><span class="line">neat_enable: true</span><br><span class="line"># 压缩html</span><br><span class="line">neat_html:</span><br><span class="line">  enable: true</span><br><span class="line">  exclude:</span><br><span class="line"># 压缩css  </span><br><span class="line">neat_css:</span><br><span class="line">  enable: true</span><br><span class="line">  exclude:</span><br><span class="line">    - &apos;**/*.min.css&apos;</span><br><span class="line"># 压缩js</span><br><span class="line">neat_js:</span><br><span class="line">  enable: true</span><br><span class="line">  mangle: true</span><br><span class="line">  output:</span><br><span class="line">  compress:</span><br><span class="line">  exclude:</span><br><span class="line">    - &apos;**/*.min.js&apos;</span><br><span class="line">    - &apos;**/jquery.fancybox.pack.js&apos;</span><br><span class="line">    - &apos;**/index.js&apos;</span><br></pre></td></tr></table></figure></li><li><p>编译博客</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo g </span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure><h5 id="gulp插件方式"><a href="#gulp插件方式" class="headerlink" title="gulp插件方式"></a>gulp插件方式</h5></li><li>安装gulp及相关插件<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">npm install gulp -g</span><br><span class="line">npm install gulp-minify-css --save</span><br><span class="line">npm install gulp-uglify --save</span><br><span class="line">npm install gulp-htmlmin --save</span><br><span class="line">npm install gulp-htmlclean --save</span><br><span class="line">npm install gulp-imagemin --save</span><br></pre></td></tr></table></figure></li></ol><p>在 Hexo 站点下新建 gulpfile.js文件，文件内容如下：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">var gulp = require(&apos;gulp&apos;);</span><br><span class="line">var minifycss = require(&apos;gulp-minify-css&apos;);</span><br><span class="line">var uglify = require(&apos;gulp-uglify&apos;);</span><br><span class="line">var htmlmin = require(&apos;gulp-htmlmin&apos;);</span><br><span class="line">var htmlclean = require(&apos;gulp-htmlclean&apos;);</span><br><span class="line">var imagemin = require(&apos;gulp-imagemin&apos;);</span><br><span class="line">// 压缩css文件</span><br><span class="line">gulp.task(&apos;minify-css&apos;, function() &#123;</span><br><span class="line">  return gulp.src(&apos;./public/**/*.css&apos;)</span><br><span class="line">  .pipe(minifycss())</span><br><span class="line">  .pipe(gulp.dest(&apos;./public&apos;));</span><br><span class="line">&#125;);</span><br><span class="line">// 压缩html文件</span><br><span class="line">gulp.task(&apos;minify-html&apos;, function() &#123;</span><br><span class="line">  return gulp.src(&apos;./public/**/*.html&apos;)</span><br><span class="line">  .pipe(htmlclean())</span><br><span class="line">  .pipe(htmlmin(&#123;</span><br><span class="line">    removeComments: true,</span><br><span class="line">    minifyJS: true,</span><br><span class="line">    minifyCSS: true,</span><br><span class="line">    minifyURLs: true,</span><br><span class="line">  &#125;))</span><br><span class="line">  .pipe(gulp.dest(&apos;./public&apos;))</span><br><span class="line">&#125;);</span><br><span class="line">// 压缩js文件</span><br><span class="line">gulp.task(&apos;minify-js&apos;, function() &#123;</span><br><span class="line">    return gulp.src([&apos;./public/**/.js&apos;,&apos;!./public/js/**/*min.js&apos;])</span><br><span class="line">        .pipe(uglify())</span><br><span class="line">        .pipe(gulp.dest(&apos;./public&apos;));</span><br><span class="line">&#125;);</span><br><span class="line">// 压缩 public/demo 目录内图片</span><br><span class="line">gulp.task(&apos;minify-images&apos;, function() &#123;</span><br><span class="line">    gulp.src(&apos;./public/demo/**/*.*&apos;)</span><br><span class="line">        .pipe(imagemin(&#123;</span><br><span class="line">           optimizationLevel: 5, //类型：Number  默认：3  取值范围：0-7（优化等级）</span><br><span class="line">           progressive: true, //类型：Boolean 默认：false 无损压缩jpg图片</span><br><span class="line">           interlaced: false, //类型：Boolean 默认：false 隔行扫描gif进行渲染</span><br><span class="line">           multipass: false, //类型：Boolean 默认：false 多次优化svg直到完全优化</span><br><span class="line">        &#125;))</span><br><span class="line">        .pipe(gulp.dest(&apos;./public/uploads&apos;));</span><br><span class="line">&#125;);</span><br><span class="line">// 默认任务</span><br><span class="line">gulp.task(&apos;default&apos;, [</span><br><span class="line">  &apos;minify-html&apos;,&apos;minify-css&apos;,&apos;minify-js&apos;,&apos;minify-images&apos;</span><br><span class="line">]);</span><br></pre></td></tr></table></figure><p></p><p>只需要每次在执行 generate 命令后执行 gulp 就可以实现对静态资源的压缩，压缩完成后执行 deploy 命令同步到服务器：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo g</span><br><span class="line">gulp</span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure><p></p><h4 id="修改访问URL路径"><a href="#修改访问URL路径" class="headerlink" title="修改访问URL路径"></a>修改访问URL路径</h4><p>默认情况下访问URL路径为：domain/2018/10/18/关于本站,修改为 domain/About/关于本站。 编辑 Hexo 站点下的 _config.yml 文件，修改其中的 permalink字段：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">permalink: :category/:title/</span><br></pre></td></tr></table></figure><p></p><h4 id="博文置顶"><a href="#博文置顶" class="headerlink" title="博文置顶"></a>博文置顶</h4><ol><li>安装插件<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm uninstall hexo-generator-index --save</span><br><span class="line">npm install hexo-generator-index-pin-top --save</span><br></pre></td></tr></table></figure></li></ol><p>然后在需要置顶的文章的Front-matter中加上top即可：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--</span><br><span class="line">title: 2018</span><br><span class="line">date: 2018-10-25 16:10:03</span><br><span class="line">top: 10</span><br><span class="line">---</span><br></pre></td></tr></table></figure><p></p><p>设置置顶标志<br>打开：/themes/*/layout/_macro/post.swig，定位到<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if post.top %&#125;</span><br><span class="line">  &lt;i class=&quot;fa fa-thumb-tack&quot;&gt;&lt;/i&gt;</span><br><span class="line">  &lt;font color=7D26CD&gt;置顶&lt;/font&gt;</span><br><span class="line">  &lt;span class=&quot;post-meta-divider&quot;&gt;|&lt;/span&gt;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><p></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;在介绍博客主题优化这个话题之前，我想先介绍hexo主题的大体结构，便于后面将主题优化方面的东西。&lt;/p&gt;&lt;h2 id=&quot;hexo主题结构&quot;&gt;&lt;a
      
    
    </summary>
    
      <category term="hexo" scheme="http://www.liuyong520.cn/categories/hexo/"/>
    
    
      <category term="hexo" scheme="http://www.liuyong520.cn/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>利用hexo搭建博客</title>
    <link href="http://www.liuyong520.cn/2017/08/27/creatblog/"/>
    <id>http://www.liuyong520.cn/2017/08/27/creatblog/</id>
    <published>2017-08-27T02:56:51.000Z</published>
    <updated>2019-04-27T16:22:09.846Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --><p>如果你和我一样是小白，那么恭喜你！看完这篇文章，你也可以拥有一个这样的博客</p><hr><p>前面已经介绍过如何搭建hexo环境，现在我将介绍如何用hexo搭建自己的blog</p><h2 id="博客搭建"><a href="#博客搭建" class="headerlink" title="博客搭建"></a>博客搭建</h2><h3 id="实施方案"><a href="#实施方案" class="headerlink" title="实施方案"></a>实施方案</h3><h4 id="方案一：GithubPages"><a href="#方案一：GithubPages" class="headerlink" title="方案一：GithubPages"></a>方案一：GithubPages</h4><ol><li><p>创建Github账号</p></li><li><p>创建仓库 ，仓库名为：&lt;Github账号名称&gt;.github.io<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556370583717.png" alt="仓库名称"><br>点击settings<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556370714512.png" alt="settings"><br>往下翻就能看到githubPages，我这里是已经配置过了的，没有配置可以是select themes ，点击能够选择SkyII主题。（SkyII主题也是和hexo类似的blog的框架，这里不与介绍）</p></li><li><p>将本地Hexo博客推送到GithubPages<br>3.1. 安装hexo-deployer-git插件。在命令行（即Git Bash）运行以下命令即可：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure><p>3.2. 添加SSH key。</p><ul><li><p>创建一个 SSH key 。在命令行（即Git Bash）输入以下命令， 回车三下即可：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-keygen -t rsa -C &quot;邮箱地址&quot;</span><br></pre></td></tr></table></figure></li><li><p>添加到 github。 复制密钥文件内容（路径形如C:\Users\Administrator.ssh\id_rsa.pub），粘贴到New SSH Key即可。</p></li><li><p>测试是否添加成功。在命令行（即Git Bash）依次输入以下命令，返回“You’ve successfully authenticated”即成功：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -T git@github.com</span><br></pre></td></tr></table></figure><p>3.3. 修改_config.yml（在站点目录下）。文件末尾修改为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Deployment</span><br><span class="line">## Docs: https://hexo.io/docs/deployment.html</span><br><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: git@github.com:&lt;Github账号名称&gt;/&lt;Github账号名称&gt;.github.io.git</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure><p>注意：上面仓库地址写ssh地址，不写http地址。<br>3.4. 推送到GithubPages。在命令行（即Git Bash）依次输入以下命令， 返回INFO Deploy done: git即成功推送：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ hexo g</span><br><span class="line">$ hexo d</span><br></pre></td></tr></table></figure><p>等待1分钟左右，浏览器访问网址： https://&lt;Github账号名称&gt;.github.io<br>至此，您的Hexo博客已经搭建在GithubPages, 域名为https://&lt;Github账号名称&gt;.github.io。</p></li></ul></li></ol><h4 id="方案二：GithubPages-域名"><a href="#方案二：GithubPages-域名" class="headerlink" title="方案二：GithubPages + 域名"></a>方案二：GithubPages + 域名</h4><p>在方案一的基础上，添加自定义域名（您购买的域名）。我的是从阿里云购买的。</p><ol><li><p>域名解析<br>类型选择为 CNAME；</p><p>主机记录即域名前缀，填写为www；</p><p>记录值填写为&lt;Github账号名称&gt;.github.io；</p><p>解析线路，TTL 默认即可<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/屏幕快照_2019-04-27_21.28.51.png" alt="阿里云"><br>点击 liuyong520.cn<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556371873729.png" alt="域名解析"></p></li><li><p>仓库设置。<br>2.1. 打开博客仓库设置：<a href="https://github.com/" target="_blank" rel="noopener">https://github.com/</a>&lt;Github账号名称&gt;/&lt;Github账号名称&gt;.github.io/settings</p><p>2.2. 在Custom domain下，填写自定义域名，点击save。</p><p>2.3. 在站点目录的source文件夹下，创建并打开CNAME.txt，写入你的域名（如<a href="http://www.liuyong520.cn），保存，并重命名为CNAME。如图" target="_blank" rel="noopener">www.liuyong520.cn），保存，并重命名为CNAME。如图</a><br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556370801480.png" alt="githubpages"></p><ol start="3"><li><p>等待10分钟左右。<br>浏览器访问自定义域名。<a href="http://www.liuyong520.cn">http://www.liuyong520.cn</a></p><p>至此，您的Hexo博客已经解析到自定义域名，https://&lt;Github账号名称&gt;.github.io依然可用。</p></li></ol><h4 id="方案三：GithubPages-CodingPages-域名"><a href="#方案三：GithubPages-CodingPages-域名" class="headerlink" title="方案三：GithubPages + CodingPages + 域名"></a>方案三：GithubPages + CodingPages + 域名</h4></li></ol><p>GithubPages 在国内较慢，百度不收录，而CodingPages 在国外较快。所以在方案二的基础上，添加CodingPages 。</p><ol><li>创建Coding账号</li><li>创建仓库， 仓库名为：&lt;Coding账号名称&gt;</li><li>进入项目里『代码』页面，点击『一键开启静态 Pages』，稍等片刻CodingPages即可部署成功。<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556380352090.png" alt="enter description here"></li><li><p>将本地Hexo博客推送到CodingPages<br>4.1. 鉴于创建GithubPages 时，已经生成过公钥。可直接复制密钥文件内容（路径形如C:\Users\Administrator.ssh\id_rsa.pub）， 粘贴到新增公钥。<br>4.2. 测试是否添加成功。在命令行（即Git Bash）依次输入以下命令，返回“You’ve successfully authenticated”即成功：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ssh -T git@git.coding.net</span><br><span class="line">$ yes</span><br></pre></td></tr></table></figure><p>4.3. 修改_config.yml（在存放Hexo初始化文件的路径下）。文件末尾修改为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># Deployment</span><br><span class="line">## Docs: https://hexo.io/docs/deployment.html</span><br><span class="line">deploy:</span><br><span class="line">- type: git</span><br><span class="line">  repo: git@github.com:&lt;Github账号名称&gt;/&lt;Github账号名称&gt;.github.io.git</span><br><span class="line">  branch: master</span><br><span class="line">- type: git</span><br><span class="line">  repo: git@git.dev.tencent.com:&lt;Coding账号名称&gt;/&lt;Coding账号名称&gt;.git</span><br><span class="line"> branch: master</span><br></pre></td></tr></table></figure><p>4.4. 推送到GithubPages。在命令行（即Git Bash）依次输入以下命令， 返回INFO Deploy done: git即成功推送：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ hexo g</span><br><span class="line">$ hexo d</span><br></pre></td></tr></table></figure></li><li><p>域名解析</p><ol><li><p>添加 CNAME 记录指向 &lt;Coding账号名称&gt;.coding.me</p><p>类型选择为 CNAME；</p><p>主机记录即域名前缀，填写为www；</p><p>记录值填写为&lt;Github账号名称&gt;.coding.me；</p><p>解析线路，TTL 默认即可。</p></li><li><p>添加 两条A 记录指向 192.30.252.153和192.30.252.154</p><p>类型选择为 A；</p><p>主机记录即域名前缀，填写为@；</p><p>记录值填写为192.30.252.153和192.30.252.154；</p><p>解析线路，境外或谷歌。<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556382087569.png" alt="enter description here"></p><ol start="3"><li>在『Pages 服务』设置页（<a href="https://dev.tencent.com/u/" target="_blank" rel="noopener">https://dev.tencent.com/u/</a>&lt;Coding账号名称&gt;/p/&lt;Coding账号名称&gt;/git/pages/settings）中绑定自定义域名<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556382059000.png" alt="enter description here"></li><li>至此，您的Hexo博客已经解析到自定义域名，https://&lt;Github账号名称&gt;.github.io和https://&lt;Coding账号名称&gt;.coding.me依然可用。</li></ol></li></ol></li></ol><h4 id="切换主题"><a href="#切换主题" class="headerlink" title="切换主题"></a>切换主题</h4><ul><li><p>选择主题<br>hexo主题是非常多的，默认的主题是landscape，您可以自主的在hexo官方网站上挑选自己喜欢的主题，网站：<a href="https://hexo.io/themes/" target="_blank" rel="noopener">https://hexo.io/themes/</a><br>推荐以下主题：<br><a href="https://github.com/shenliyang/hexo-theme-snippet#hexo-theme-snippet" target="_blank" rel="noopener">snippet</a><br><a href="https://github.com/iTimeTraveler/hexo-theme-hiero#hiero" target="_blank" rel="noopener">Hiero</a><br><a href="https://github.com/tangkunyin/hexo-theme-jsimple#jsimple" target="_blank" rel="noopener">Jsimple</a><br><a href="https://github.com/chaooo/hexo-theme-BlueLake#bluelake" target="_blank" rel="noopener">BlueLake</a><br><a href="https://github.com/cofess/hexo-theme-pure" target="_blank" rel="noopener">Pure</a><br><a href="https://github.com/theme-next/hexo-theme-next" target="_blank" rel="noopener">Next</a><br><a href="https://github.com/ppoffice/hexo-theme-hueman" target="_blank" rel="noopener">Hueman</a><br>我这里选择的是Pure。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/cofess/hexo-theme-pure.git  themes/pure</span><br></pre></td></tr></table></figure><p>此时会在themes 目录下生成 pure目录<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556365705175.png" alt="目录"></p></li><li><p>应用主题<br>更改站点配置_config.yml 修改成</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Extensions</span><br><span class="line">## Plugins: https://hexo.io/plugins/</span><br><span class="line">## Themes: https://hexo.io/themes/</span><br><span class="line">theme: &lt;主题文件夹的名称&gt;</span><br></pre></td></tr></table></figure></li><li><p>主题优化<br>以上主题都有比较详细的说明文档，本节主要解决主题优化的常见问题。</p><p>主题优化一般包括：</p><ul><li>设置「RSS」</li><li>添加「标签」页面</li><li>添加「分类」页面</li><li>设置「字体」</li><li>设置「代码高亮主题」</li><li>侧边栏社交链接</li><li>开启打赏功能</li><li>设置友情链接</li><li>腾讯公益404页面</li><li>站点建立时间</li><li>订阅微信公众号</li><li>设置「动画效果」</li><li>设置「背景动画」<br>下一次我将针对Pure进行主题方面的相关配置，以及讲解一下hexo主题的的实现原理的。这样你们针对不同的主题也就都能配置了。</li></ul></li></ul><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;如果你和我一样是小白，那么恭喜你！看完这篇文章，你也可以拥有一个这样的博客&lt;/p&gt;&lt;hr&gt;&lt;p&gt;前面已经介绍过如何搭建hexo环境，现在我将介绍
      
    
    </summary>
    
      <category term="hexo" scheme="http://www.liuyong520.cn/categories/hexo/"/>
    
    
      <category term="hexo" scheme="http://www.liuyong520.cn/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>Hexo之环境搭建</title>
    <link href="http://www.liuyong520.cn/2017/08/27/hexo-install/"/>
    <id>http://www.liuyong520.cn/2017/08/27/hexo-install/</id>
    <published>2017-08-27T02:56:51.000Z</published>
    <updated>2019-04-27T12:11:10.273Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --><p>如果你和我一样是小白，那么恭喜你！看完这篇文章，你也可以拥有一个这样的博客啦！</p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在以前我们要维护一个专属于自己的blog，是比较麻烦的，要购买服务器，部署博客程序到服务器，还要维护相关数据和网络。这一类blog最为典型的例子就是WordPress。而今天我们要介绍的是如何基于Hexo博客快速的搭建我们自己服务器系列。</p><h2 id="hexo介绍"><a href="#hexo介绍" class="headerlink" title="hexo介绍"></a>hexo介绍</h2><p>Hexo 是一个快速、简洁且高效的博客框架。Hexo 使用 Markdown（或其他渲染引擎）解析文章，在几秒内，即可利用靓丽的主题生成静态网页。</p><h2 id="hexo安装"><a href="#hexo安装" class="headerlink" title="hexo安装"></a>hexo安装</h2><p>hexo 是基于node.js环境的，所以安装前，您必须检查电脑中是否已安装下列应用程序：<a href="https://nodejs.org/en/" target="_blank" rel="noopener">node.js</a><br>如果您的电脑中已经安装上述必备程序，那么恭喜您！接下来只需要使用 npm 即可完成 Hexo 的安装。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install -g hexo-cli</span><br></pre></td></tr></table></figure><p></p><p>如果您的电脑中未安装Node，那么就需要安装Node.js<br>详细安装步骤参考：<a href="http://www.liuyong520.cn/2017/08/26/nodejs-install/">http://www.liuyong520.cn/2017/08/26/nodejs-install/</a></p><p>再安装Hexo，在命令行（即Git Bash）运行以下命令：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g hexo-cli</span><br></pre></td></tr></table></figure><p></p><p>至此Hexo的环境就搭建好了，下一步验证一下hexo<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">MacBook-Pro:_posts xxydliuyss$ hexo version</span><br><span class="line">hexo: 3.8.0</span><br><span class="line">hexo-cli: 1.1.0</span><br><span class="line">os: Darwin 18.5.0 darwin x64</span><br><span class="line">http_parser: 2.8.0</span><br><span class="line">node: 10.15.3</span><br><span class="line">v8: 6.8.275.32-node.51</span><br><span class="line">uv: 1.23.2</span><br><span class="line">zlib: 1.2.11</span><br><span class="line">ares: 1.15.0</span><br><span class="line">modules: 64</span><br><span class="line">nghttp2: 1.34.0</span><br><span class="line">napi: 3</span><br><span class="line">openssl: 1.1.0j</span><br><span class="line">icu: 62.1</span><br><span class="line">unicode: 11.0</span><br><span class="line">cldr: 33.1</span><br><span class="line">tz: 2018e</span><br></pre></td></tr></table></figure><p></p><p>这样hexo就安装完成了</p><h3 id="hexo命令介绍"><a href="#hexo命令介绍" class="headerlink" title="hexo命令介绍"></a>hexo命令介绍</h3><p>官网已经介绍的比较详细了这里就不再赘述了<br>详情请看官方命令地址：<a href="https://hexo.io/zh-cn/docs/commands" target="_blank" rel="noopener">https://hexo.io/zh-cn/docs/commands</a></p><h3 id="hexo快速新建博客"><a href="#hexo快速新建博客" class="headerlink" title="hexo快速新建博客"></a>hexo快速新建博客</h3><p>初始化Hexo，在命令行（即Git Bash）依次运行以下命令即可：</p><p>以下，即存放Hexo初始化文件的路径， 即站点目录。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ hexo init myproject</span><br><span class="line">$ cd myproject</span><br><span class="line">$ npm install</span><br></pre></td></tr></table></figure><p></p><p>新建完成后，在路径下，会产生这些文件和文件夹：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">├── _config.yml</span><br><span class="line">├── package.json</span><br><span class="line">├── scaffolds</span><br><span class="line">├── source</span><br><span class="line">|   ├── _drafts</span><br><span class="line">|   └── _posts</span><br><span class="line">└── themes</span><br></pre></td></tr></table></figure><p></p><table><thead><tr><th>目录名或者文件名</th><th>详情介绍</th></tr></thead><tbody><tr><td>_config.yml</td><td>hexo 全局配置文件</td></tr><tr><td>package.json</td><td>nodejs 包配置文件</td></tr><tr><td>scaffolds</td><td>hexo模版文件夹hexo new filename 会对应根据模版文件生成文件</td></tr><tr><td>source</td><td>项目源代码文件目录</td></tr><tr><td>_drafts</td><td>为草稿原文件目录</td></tr><tr><td>_posts</td><td>项目发布文件目录 项目最终会根据这个目录下的文件生成html</td></tr><tr><td>themes</td><td>博客主题存放目录</td></tr></tbody></table><p>注：</p><p>hexo相关命令均在站点目录下，用Git Bash运行。</p><p>站点配置文件：站点目录下的_config.yml。</p><p>​ 路径为<folder>_config.yml</folder></p><p>主题配置文件：站点目录下的themes文件夹下的，主题文件夹下的_config.yml。</p><p>​ 路径为<folder>\themes\&lt;主题文件夹&gt;_config.yml</folder></p><ol start="2"><li>启动服务器。在路径下，命令行（即Git Bash）输入以下命令，运行即可：</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo server</span><br></pre></td></tr></table></figure><ol start="3"><li>浏览器访问网址： <a href="http://localhost:4000/" target="_blank" rel="noopener">http://localhost:4000/</a> 就可以预览博客了<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556363959958.png" alt="图片"></li></ol><p>下一篇 我将介绍如何搭建自己的blog</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;如果你和我一样是小白，那么恭喜你！看完这篇文章，你也可以拥有一个这样的博客啦！&lt;/p&gt;&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; cla
      
    
    </summary>
    
      <category term="hexo" scheme="http://www.liuyong520.cn/categories/hexo/"/>
    
    
      <category term="hexo" scheme="http://www.liuyong520.cn/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>node.js环境搭建</title>
    <link href="http://www.liuyong520.cn/2017/08/26/nodejs-install/"/>
    <id>http://www.liuyong520.cn/2017/08/26/nodejs-install/</id>
    <published>2017-08-26T01:56:51.000Z</published>
    <updated>2019-04-27T09:42:47.606Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --><h2 id="安装node-js"><a href="#安装node-js" class="headerlink" title="安装node.js"></a>安装node.js</h2><p>登录<img src="https://nodejs.org/en/" alt="node.js">官网下载对应的exe安装包。下载地址为：<img src="https://nodejs.org/en/download/" alt="https://nodejs.org/en/download/"><br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556354057260.png" alt="nodejs下载页面"><br>你可以根据不同平台系统选择你需要的Node.js安装包。</p><p>Node.js 历史版本下载地址：<a href="https://nodejs.org/dist/" target="_blank" rel="noopener">https://nodejs.org/dist/</a></p><p>注意：Linux上安装Node.js需要安装Python 2.6 或 2.7 ，不建议安装Python 3.0以上版本。</p><hr><h3 id="windows-上安装-node-js"><a href="#windows-上安装-node-js" class="headerlink" title="windows 上安装 node.js"></a>windows 上安装 node.js</h3><p>你可以采用以下两种方式来安装。</p><p>1、Windows 安装包(.msi)<br>32 位安装包下载地址 : <a href="https://nodejs.org/dist/v4.4.3/node-v4.4.3-x86.msi" target="_blank" rel="noopener">https://nodejs.org/dist/v4.4.3/node-v4.4.3-x86.msi</a></p><p>64 位安装包下载地址 : <a href="https://nodejs.org/dist/v4.4.3/node-v4.4.3-x64.msi" target="_blank" rel="noopener">https://nodejs.org/dist/v4.4.3/node-v4.4.3-x64.msi</a></p><p>本文实例以 v0.10.26 版本为例，其他版本类似， 安装步骤：</p><p>步骤 1 : 双击下载后的安装包 v0.10.26，如下所示：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556356341458.png" alt="安装图"><br>步骤 2: 点击以上的Run(运行)，将出现如下界面：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556356418282.png" alt="安装图"><br>步骤 3 : 勾选接受协议选项，点击 next（下一步） 按钮 :<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556356471486.png" alt="enter description here"><br>步骤 4 : Node.js默认安装目录为 “C:\Program Files\nodejs\” , 你可以修改目录，并点击 next（下一步）：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556356504568.png" alt="enter description here"><br>步骤 5 : 点击树形图标来选择你需要的安装模式 , 然后点击下一步 next（下一步）<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556356545218.png" alt="enter description here"><br>步骤 6 :点击 Install（安装） 开始安装Node.js。你也可以点击 Back（返回）来修改先前的配置。 然后并点击 next（下一步）：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556356578858.png" alt="enter description here"><br>点击 Finish（完成）按钮退出安装向导。<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556356605083.png" alt="完成图"><br>检测PATH环境变量是否配置了Node.js，点击开始=》运行=》输入”cmd” =&gt; 输入命令”path”，输出如下结果：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PATH=C:\oraclexe\app\oracle\product\10.2.0\server\bin;C:\Windows\system32;</span><br><span class="line">C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\;</span><br><span class="line">c:\python32\python;C:\MinGW\bin;C:\Program Files\GTK2-Runtime\lib;</span><br><span class="line">C:\Program Files\MySQL\MySQL Server 5.5\bin;C:\Program Files\nodejs\;</span><br><span class="line">C:\Users\rg\AppData\Roaming\npm</span><br></pre></td></tr></table></figure><p></p><p>我们可以看到环境变量中已经包含了C:\Program Files\nodejs\</p><p>检查Node.js版本<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">E:\&gt; node --version</span><br><span class="line">v0.10.26</span><br></pre></td></tr></table></figure><p></p><p>2、Windows 二进制文件 (.exe)安装<br>32 位安装包下载地址 : <a href="http://nodejs.org/dist/v0.10.26/node.exe" target="_blank" rel="noopener">http://nodejs.org/dist/v0.10.26/node.exe</a></p><p>64 位安装包下载地址 : <a href="http://nodejs.org/dist/v0.10.26/x64/node.exe" target="_blank" rel="noopener">http://nodejs.org/dist/v0.10.26/x64/node.exe</a><br>安装步骤</p><p>步骤 1 : 双击下载的安装包 Node.exe ，将出现如下界面 :<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556356900243.png" alt="enter description here"><br>点击 Run（运行）按钮将出现命令行窗口：<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556356930002.png" alt="enter description here"><br>版本测试<br>进入 node.exe 所在的目录，如下所示<br><img src="https://www.github.com/liuyong520/pic/raw/master/小书匠/1556356957166.png" alt="enter description here"><br>如果你获得以上输出结果，说明你已经成功安装了Node.js。</p><h3 id="linux安装node-js"><a href="#linux安装node-js" class="headerlink" title="linux安装node.js"></a>linux安装node.js</h3><p>直接使用已编译好的包<br>Node 官网已经把 linux 下载版本更改为已编译好的版本了，我们可以直接下载解压后使用：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># wget https://nodejs.org/dist/v10.9.0/node-v10.9.0-linux-x64.tar.xz    // 下载</span><br><span class="line"># tar xf  node-v10.9.0-linux-x64.tar.xz       // 解压</span><br><span class="line"># cd node-v10.9.0-linux-x64/                  // 进入解压目录</span><br><span class="line"># ./bin/node -v                               // 执行node命令 查看版本</span><br><span class="line">v10.9.0</span><br></pre></td></tr></table></figure><p></p><p>解压文件的 bin 目录底下包含了 node、npm 等命令，我们可以使用 ln 命令来设置软连接<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/software/nodejs/bin/npm   /usr/local/bin/ </span><br><span class="line">ln -s /usr/software/nodejs/bin/node   /usr/local/bin/</span><br></pre></td></tr></table></figure><p></p><p>Ubuntu 源码安装 Node.js<br>以下部分我们将介绍在 Ubuntu Linux 下使用源码安装 Node.js 。 其他的 Linux 系统，如 Centos 等类似如下安装步骤。</p><p>在 Github 上获取 Node.js 源码：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo git clone https://github.com/nodejs/node.git</span><br><span class="line">Cloning into &apos;node&apos;...</span><br></pre></td></tr></table></figure><p></p><p>修改目录权限：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo chmod -R 755 node</span><br></pre></td></tr></table></figure><p></p><p>使用 ./configure 创建编译文件，并按照：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cd node</span><br><span class="line">$ sudo ./configure</span><br><span class="line">$ sudo make</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure><p></p><p>查看 node 版本：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ node --version</span><br><span class="line">v0.10.25</span><br></pre></td></tr></table></figure><p></p><p>Ubuntu apt-get命令安装<br>命令格式如下：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install nodejs</span><br><span class="line">sudo apt-get install npm</span><br></pre></td></tr></table></figure><p></p><p>CentOS 下源码安装 Node.js<br>1、下载源码，你需要在<a href="https://nodejs.org/en/download/" target="_blank" rel="noopener">https://nodejs.org/en/download/</a> 下载最新的Nodejs版本，本文以v0.10.24为例:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/</span><br><span class="line">wget http://nodejs.org/dist/v0.10.24/node-v0.10.24.tar.gz</span><br></pre></td></tr></table></figure><p></p><p>2、解压源码<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf node-v0.10.24.tar.gz</span><br></pre></td></tr></table></figure><p></p><p>3、 编译安装<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd node-v0.10.24</span><br><span class="line">./configure --prefix=/usr/local/node/0.10.24</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p></p><p>4、 配置NODE_HOME，进入profile编辑环境变量<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br></pre></td></tr></table></figure><p></p><p>设置nodejs环境变量，在 <em>export PATH USER LOGNAME MAIL HOSTNAME HISTSIZE HISTCONTROL</em> 一行的上面添加如下内容:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#set for nodejs</span><br><span class="line">export NODE_HOME=/usr/local/node/0.10.24</span><br><span class="line">export PATH=$NODE_HOME/bin:$PATH</span><br></pre></td></tr></table></figure><p></p><p>:wq保存并退出，编译/etc/profile 使配置生效<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><p></p><p>验证是否安装配置成功<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br></pre></td></tr></table></figure><p></p><p>输出 v0.10.24 表示配置成功<br>npm模块安装路径:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/node/0.10.24/lib/node_modules/</span><br></pre></td></tr></table></figure><p></p><p>注：Nodejs 官网提供了编译好的Linux二进制包，你也可以下载下来直接应用。</p><h3 id="Mac-OS-上安装"><a href="#Mac-OS-上安装" class="headerlink" title="Mac OS 上安装"></a>Mac OS 上安装</h3><p>你可以通过以下两种方式在 Mac OS 上来安装 node：</p><p>1、在官方下载网站</p><p>下载 pkg 安装包，直接点击安装即可。<br>2、使用 brew 命令来安装：<br></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install node</span><br></pre></td></tr></table></figure><p></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --&gt;&lt;h2 id=&quot;安装node-js&quot;&gt;&lt;a href=&quot;#安装node-js&quot; class=&quot;headerlink&quot; title=&quot;安装node.js
      
    
    </summary>
    
      <category term="node" scheme="http://www.liuyong520.cn/categories/node/"/>
    
    
      <category term="node" scheme="http://www.liuyong520.cn/tags/node/"/>
    
  </entry>
  
  <entry>
    <title>xsync 同步命令脚本和xcall远程执行命令脚本</title>
    <link href="http://www.liuyong520.cn/2017/03/29/xsync/"/>
    <id>http://www.liuyong520.cn/2017/03/29/xsync/</id>
    <published>2017-03-28T16:18:32.000Z</published>
    <updated>2019-04-28T16:40:15.580Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --><h2 id="缘由"><a href="#缘由" class="headerlink" title="缘由"></a>缘由</h2><p>在linux服务器集群上，有时我们需要将数据从主服务器同步到所有的从服务器上，或者在集群里需要执行一条或者多条命令，如果们一次次的拷贝，或者每个服务器一条条的执行，会造成重复的工作。所以就写两个脚本解决这方面的问题。</p><h2 id="xsync命令的编写"><a href="#xsync命令的编写" class="headerlink" title="xsync命令的编写"></a>xsync命令的编写</h2><ol><li><p>安装 sync命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y sync</span><br></pre></td></tr></table></figure></li><li><p>编写脚本 environment.sh</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#! /usr/bin/bash</span><br><span class="line"># 集群 IP 数组</span><br><span class="line">export NODE_IPS=(172.16.18.198 172.16.18.199 172.16.18.200)</span><br><span class="line"># 集群各 IP 对应的 主机名数组</span><br><span class="line">export NODE_NAMES=(k8s-n1 k8s-n2 k8s-n3)</span><br></pre></td></tr></table></figure></li><li><p>编写xsyncj考本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># 获取输出参数，如果没有参数则直接返回</span><br><span class="line">pcount=$#</span><br><span class="line">if [ $pcount -eq 0 ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;no parameter find !&quot;;</span><br><span class="line">    exit;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 获取传输文件名</span><br><span class="line">p1=$1</span><br><span class="line">filename=`basename $p1`</span><br><span class="line">echo &quot;load file $p1 success !&quot;</span><br><span class="line"></span><br><span class="line"># 获取文件的绝对路径</span><br><span class="line">pdir=`cd -P $(dirname $p1); pwd`</span><br><span class="line">echo &quot;file path is $pdir&quot;</span><br><span class="line"></span><br><span class="line"># 获取当前用户（如果想使用root用户权限拷贝文件，在命令后加入-root参数即可）</span><br><span class="line">user=$2</span><br><span class="line">case &quot;$user&quot; in</span><br><span class="line">&quot;-root&quot;)</span><br><span class="line">    user=&quot;root&quot;;;</span><br><span class="line">&quot;&quot;)</span><br><span class="line">    user=`whoami`;;</span><br><span class="line">*)</span><br><span class="line">    echo &quot;illegal parameter $user&quot;</span><br><span class="line">    </span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">echo $user</span><br><span class="line"># 拷贝文件到从机(这里注意主机的host需要根据你的实际情况配置，要与你具体的主机名对应)</span><br><span class="line">source /opt/user/environment.sh</span><br><span class="line">index=0</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">do </span><br><span class="line">    </span><br><span class="line">    echo &quot;================current host is $&#123;NODE_NAMES[$index]&#125; ip is $&#123;node_ip&#125;=================&quot;</span><br><span class="line">    rsync -rvl $pdir/$filename $user@$&#123;node_ip&#125;:$pdir</span><br><span class="line">    index=`expr $index + 1`</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">echo &quot;complete !&quot;</span><br></pre></td></tr></table></figure></li></ol><h2 id="xcall脚本的编写"><a href="#xcall脚本的编写" class="headerlink" title="xcall脚本的编写"></a>xcall脚本的编写</h2><p>利用ssh命令远程执行脚本命令。<br>脚本如下：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># 获取控制台指令</span><br><span class="line"></span><br><span class="line">cmd=$*</span><br><span class="line"></span><br><span class="line"># 判断指令是否为空</span><br><span class="line">if (( #$cmd -eq # ))</span><br><span class="line">then</span><br><span class="line">    echo &quot;command can not be null !&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 获取当前登录用户</span><br><span class="line">user=`whoami`</span><br><span class="line">source /opt/user/environment.sh</span><br><span class="line"># 在从机执行指令,这里需要根据你具体的集群情况配置，host与具体主机名一致</span><br><span class="line">for node_ip in $&#123;NODE_IPS[@]&#125;</span><br><span class="line">do</span><br><span class="line">        echo &quot;================current host is $&#123;node_ip&#125;=================&quot;</span><br><span class="line">        echo &quot;--&gt; excute command \&quot;$cmd\&quot;&quot;</span><br><span class="line">        ssh $user@$&#123;node_ip&#125; $cmd</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">echo &quot;excute successfully !&quot;</span><br></pre></td></tr></table></figure><p></p><p>这两个脚本仅仅只是一个简单的脚本，欢迎大家修改和使用。</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      
      
        &lt;!-- build time:Sun May 12 2019 12:14:15 GMT+0800 (GMT+08:00) --&gt;&lt;h2 id=&quot;缘由&quot;&gt;&lt;a href=&quot;#缘由&quot; class=&quot;headerlink&quot; title=&quot;缘由&quot;&gt;&lt;/a&gt;缘由&lt;/h2&gt;&lt;p&gt;在linu
      
    
    </summary>
    
      <category term="linux shell" scheme="http://www.liuyong520.cn/categories/linux-shell/"/>
    
    
      <category term="linux" scheme="http://www.liuyong520.cn/tags/linux/"/>
    
      <category term="shell" scheme="http://www.liuyong520.cn/tags/shell/"/>
    
  </entry>
  
</feed>
